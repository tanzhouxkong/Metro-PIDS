<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Metro-PIDS äº‘æ§ç®¡ç†åå°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Crect width='16' height='16' rx='3' fill='%23667eea'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='10' fill='%23fff' font-weight='bold'%3EMP%3C/text%3E%3C/svg%3E" type="image/svg+xml" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    .header {
      background: rgba(255, 255, 255, 0.95);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 24px 32px;
      margin-bottom: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 {
      font-size: 28px;
      font-weight: 700;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .header .api-info {
      font-size: 13px;
      color: #666;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .header .api-info code {
      background: #f0f0f0;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
    }
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      background: rgba(255, 255, 255, 0.95);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      padding: 8px;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }
    .tab {
      padding: 10px 20px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #666;
      border-radius: 8px;
      transition: all 0.2s;
    }
    .tab:hover {
      background: rgba(102, 126, 234, 0.1);
    }
    .tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .card {
      background: rgba(255, 255, 255, 0.95);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    .card h2 {
      font-size: 20px;
      margin-bottom: 16px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card h2 i {
      color: #667eea;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }
    .field {
      margin-bottom: 16px;
    }
    .field label {
      display: block;
      font-size: 13px;
      color: #666;
      margin-bottom: 6px;
      font-weight: 500;
    }
    .field input,
    .field textarea,
    .field select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s;
    }
    .field input:focus,
    .field textarea:focus,
    .field select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .field textarea {
      min-height: 200px;
      font-family: 'Consolas', 'Menlo', monospace;
      resize: vertical;
    }
    .btn-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    .btn {
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
    }
    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }
    .btn-secondary:hover {
      background: #e0e0e0;
    }
    .btn-danger {
      background: #ff4757;
      color: white;
    }
    .btn-danger:hover {
      background: #ff3838;
    }
    .btn-success {
      background: #2ed573;
      color: white;
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }
    .status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      padding: 6px 12px;
      border-radius: 6px;
      margin-left: 8px;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
    }
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
    }
    .table-container {
      overflow-x: auto;
      margin-top: 16px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }
    th {
      background: #f8f9fa;
      font-weight: 600;
      color: #333;
      font-size: 13px;
    }
    tr:hover {
      background: #f8f9fa;
    }
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }
    .badge-success {
      background: #d4edda;
      color: #155724;
    }
    .badge-danger {
      background: #f8d7da;
      color: #721c24;
    }
    .badge-info {
      background: #d1ecf1;
      color: #0c5460;
    }
    pre {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 16px;
      border-radius: 8px;
      font-family: 'Consolas', 'Menlo', monospace;
      font-size: 13px;
      max-height: 400px;
      overflow: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
    }
    .empty-state i {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      -webkit-backdrop-filter: blur(4px);
      backdrop-filter: blur(4px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .modal-header h3 {
      font-size: 20px;
      color: #333;
    }
    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }
    .close-btn:hover {
      background: #f0f0f0;
      color: #333;
    }
    .api-info {
      margin-top: 8px;
    }
    .stat-card {
      color: white;
      padding: 24px;
    }
    .stat-card-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .stat-card-secondary {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    .stat-value {
      font-size: 32px;
      font-weight: 700;
    }
    .stat-label {
      font-size: 14px;
      opacity: 0.9;
      margin-top: 4px;
    }
    .btn-group-spaced {
      margin-top: 16px;
    }
    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
    }
    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }
    .stat-meta {
      font-size: 13px;
      color: #666;
    }
    .stat-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .stat-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
      cursor: default;
      white-space: nowrap;
    }
    .stat-tag:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .stat-tag strong {
      font-weight: 600;
    }
    .stat-tag .stat-value {
      font-weight: 700;
      margin-left: 4px;
    }
    .stat-tag-country {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      color: #1976d2;
      border: 1px solid rgba(25, 118, 210, 0.2);
    }
    .stat-tag-version {
      background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
      color: #7b1fa2;
      border: 1px solid rgba(123, 31, 162, 0.2);
    }
    .stat-tag-admin {
      background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
      color: #e65100;
      border: 1px solid rgba(230, 81, 0, 0.2);
    }
    .stat-tag-os {
      background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
      color: #2e7d32;
      border: 1px solid rgba(46, 125, 50, 0.2);
    }
    .stat-tag-device {
      background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 100%);
      color: #c2185b;
      border: 1px solid rgba(194, 24, 91, 0.2);
    }
    .stat-tag-device-unknown {
      background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
      color: #616161;
      border: 1px solid rgba(97, 97, 97, 0.2);
    }
    .stat-tag code {
      font-family: 'Consolas', 'Menlo', 'Monaco', monospace;
      font-size: 11px;
      background: rgba(0,0,0,0.05);
      padding: 2px 6px;
      border-radius: 3px;
      font-weight: 600;
    }
    .settings-check-status {
      margin-top: 4px;
      min-height: 24px;
    }
    .btn-small-spaced {
      margin-left: 4px;
    }
    .date-info-card {
      background: #f0f7ff;
      border-left: 4px solid #667eea;
      padding: 12px;
      margin-bottom: 16px;
    }
    .date-info-label {
      font-size: 13px;
      color: #666;
      margin-bottom: 4px;
    }
    .date-info-value {
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }
    .device-id-display {
      font-family: monospace;
      word-break: break-all;
    }
    .device-id-hint {
      font-size: 12px;
      color: #999;
      margin-top: 4px;
    }
    .date-group-header {
      background: #f8f9fa;
      font-weight: 600;
      cursor: pointer;
      -webkit-user-select: none;
      user-select: none;
    }
    .date-group-header:hover {
      background: #e9ecef;
    }
    .date-group-header .toggle-icon {
      display: inline-block;
      width: 16px;
      margin-right: 8px;
      transition: transform 0.2s;
    }
    .date-group-header.collapsed .toggle-icon {
      transform: rotate(-90deg);
    }
    .date-group-rows {
      display: table-row-group;
    }
    .date-group-rows.collapsed {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>ğŸš‡ Metro-PIDS äº‘æ§ç®¡ç†åå°</h1>
        <div class="api-info">
          <span>API åœ°å€ï¼š</span>
          <code id="api-base-display">æœªè®¾ç½®</code>
        </div>
      </div>
      <div>
        <button class="btn btn-secondary" id="btn-settings">
          <i class="fas fa-cog"></i> è®¾ç½®
        </button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="runtime">è¿æ§çº¿è·¯</button>
      <button class="tab" data-tab="easter-eggs">å½©è›‹é…ç½®</button>
      <button class="tab" data-tab="holidays">èŠ‚æ—¥é…ç½®</button>
      <button class="tab" data-tab="updates">ç‰ˆæœ¬æ›´æ–°</button>
      <button class="tab" data-tab="stats">ç»Ÿè®¡ä¿¡æ¯</button>
    </div>

    <!-- è¿æ§çº¿è·¯ -->
    <div class="tab-content active" id="tab-runtime">
      <div class="card">
        <h2><i class="fas fa-sync-alt"></i> è¿æ§çº¿è·¯åˆ—è¡¨</h2>
        <div class="btn-group">
          <button class="btn btn-primary" id="btn-list-runtime">
            <i class="fas fa-sync"></i> åˆ·æ–°åˆ—è¡¨
          </button>
        </div>
        <div class="table-container">
          <table id="runtime-table">
            <thead>
              <tr>
                <th>çº¿è·¯åç§°</th>
                <th>ç«™ç‚¹æ•°é‡</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="runtime-tbody">
              <tr>
                <td colspan="3" class="empty-state">
                  <i class="fas fa-inbox"></i>
                  <div>ç‚¹å‡»"åˆ·æ–°åˆ—è¡¨"åŠ è½½æ•°æ®</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2><i class="fas fa-edit"></i> è¿æ§çº¿è·¯ç¼–è¾‘</h2>
        <div style="background:#e3f2fd; padding:12px; border-radius:8px; margin-bottom:16px; font-size:13px; line-height:1.6;">
          <strong>ğŸ’¡ ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
          â€¢ é€‰æ‹© JSON æ–‡ä»¶ä¸Šä¼ ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¯»å–çº¿è·¯æ•°æ®<br>
          â€¢ æ”¯æŒä¸€æ¬¡é€‰æ‹©å¤šä¸ªæ–‡ä»¶ï¼Œæ‰¹é‡ä¸Šä¼ å¤šæ¡çº¿è·¯<br>
          â€¢ æ–‡ä»¶æ ¼å¼ï¼šæ ‡å‡†çš„è¿æ§çº¿è·¯ JSON æ–‡ä»¶ï¼ˆåŒ…å« metaã€stations ç­‰å­—æ®µï¼‰
        </div>
        
        <div class="field">
          <label for="runtime-line-file-input">
            <i class="fas fa-file-upload"></i> é€‰æ‹©è¿æ§çº¿è·¯ JSON æ–‡ä»¶ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
          </label>
          <input type="file" id="runtime-line-file-input" accept=".json" multiple />
          <div style="font-size:12px; color:#666; margin-top:4px;">
            å¯ä»¥ä¸€æ¬¡é€‰æ‹©å¤šä¸ª JSON æ–‡ä»¶ï¼Œæ¯ä¸ªæ–‡ä»¶å¯¹åº”ä¸€æ¡è¿æ§çº¿è·¯
          </div>
          <div id="runtime-files-list" style="margin-top:8px; padding:8px; background:#f9f9f9; border-radius:4px; display:none;">
            <strong>å·²é€‰æ‹©çš„æ–‡ä»¶ï¼š</strong>
            <ul id="runtime-files-items" style="margin:4px 0 0 0; padding-left:20px; font-size:12px;"></ul>
          </div>
        </div>
        
        <div class="btn-group">
          <button class="btn btn-info" id="btn-parse-runtime-files">
            <i class="fas fa-magic"></i> è§£æå¹¶ä¸Šä¼ æ–‡ä»¶
          </button>
          <button class="btn btn-secondary" id="btn-get-runtime">
            <i class="fas fa-download"></i> ä¸‹è½½æŒ‡å®šçº¿è·¯
          </button>
          <button class="btn btn-danger" id="btn-del-runtime">
            <i class="fas fa-trash"></i> åˆ é™¤æŒ‡å®šçº¿è·¯
          </button>
        </div>
        
        <div class="grid" style="margin-top:16px;">
          <div class="field">
            <label for="runtime-line-name">çº¿è·¯åç§°ï¼ˆç”¨äºä¸‹è½½/åˆ é™¤ï¼‰</label>
            <input type="text" id="runtime-line-name" placeholder="ä¾‹å¦‚ï¼šæµå—åœ°é“1å·çº¿" />
          </div>
        </div>
        
        <div class="field" style="margin-top:16px;">
          <label for="runtime-line-json">è¿æ§çº¿è·¯ JSON æ•°æ®é¢„è§ˆ</label>
          <textarea id="runtime-line-json" placeholder='ä¸Šä¼ æ–‡ä»¶åä¼šè‡ªåŠ¨æ˜¾ç¤º JSON æ•°æ®ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨ç¼–è¾‘' style="min-height:200px;"></textarea>
          <div style="font-size:12px; color:#666; margin-top:4px;">
            æ­¤æ–‡æœ¬æ¡†ä»…ç”¨äºé¢„è§ˆå’Œæ‰‹åŠ¨ç¼–è¾‘ï¼Œæ¨èä½¿ç”¨æ–‡ä»¶ä¸Šä¼ æ–¹å¼
          </div>
        </div>
        <div id="runtime-status"></div>
      </div>
    </div>

    <!-- å½©è›‹é…ç½® -->
    <div class="tab-content" id="tab-easter-eggs">
      <div class="card">
        <h2><i class="fas fa-egg"></i> å½©è›‹é…ç½®</h2>
        <div class="btn-group">
          <button class="btn btn-secondary" id="btn-get-easter-eggs">
            <i class="fas fa-download"></i> ä¸‹è½½
          </button>
          <button class="btn btn-primary" id="btn-put-easter-eggs">
            <i class="fas fa-upload"></i> ä¸Šä¼ 
          </button>
        </div>
        <div class="field">
          <label for="easter-eggs-json">å½©è›‹é…ç½® JSON</label>
          <textarea id="easter-eggs-json" placeholder='{"stations": [...], "messages": [...], "enabled": true}'></textarea>
        </div>
        <div id="easter-eggs-status"></div>
      </div>
    </div>

    <!-- èŠ‚æ—¥é…ç½® -->
    <div class="tab-content" id="tab-holidays">
      <div class="card">
        <h2><i class="fas fa-calendar-alt"></i> èŠ‚æ—¥é…ç½®</h2>
        <div class="card date-info-card">
          <div class="date-info-label">å½“å‰æ—¥æœŸï¼ˆç”¨äºç¡®è®¤èŠ‚æ—¥é…ç½®ï¼‰</div>
          <div class="date-info-value" id="current-date-display">åŠ è½½ä¸­...</div>
        </div>
        <div class="btn-group">
          <button class="btn btn-secondary" id="btn-get-holidays">
            <i class="fas fa-download"></i> ä¸‹è½½
          </button>
          <button class="btn btn-primary" id="btn-put-holidays">
            <i class="fas fa-upload"></i> ä¸Šä¼ 
          </button>
          <button class="btn btn-secondary" id="btn-get-active-holidays">
            <i class="fas fa-check-circle"></i> æŸ¥çœ‹æ¿€æ´»èŠ‚æ—¥
          </button>
        </div>
        <div class="field">
          <label for="holidays-json">èŠ‚æ—¥é…ç½® JSON</label>
          <textarea id="holidays-json" placeholder='{"birthday": {...}, "chineseNewYear": {...}}'></textarea>
        </div>
        <div id="holidays-status"></div>
      </div>
    </div>

    <!-- ç‰ˆæœ¬æ›´æ–° -->
    <div class="tab-content" id="tab-updates">
      <div class="card">
        <h2><i class="fas fa-shield-alt"></i> å¼ºåˆ¶æ›´æ–°è®¾ç½®</h2>
        <div style="background:#e3f2fd; padding:12px; border-radius:8px; margin-bottom:16px; font-size:13px; line-height:1.6;">
          <strong>ğŸ’¡ ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
          â€¢ ç‰ˆæœ¬ä¿¡æ¯ä¼šè‡ªåŠ¨ä» GitHub Releases åŒæ­¥ï¼ˆæ— éœ€æ‰‹åŠ¨ä¸Šä¼ ï¼‰<br>
          â€¢ å¯ä»¥è®¾ç½®æœ€ä½ç‰ˆæœ¬è¦æ±‚ï¼Œä½äºæ­¤ç‰ˆæœ¬çš„å®¢æˆ·ç«¯å°†è¢«å¼ºåˆ¶æ›´æ–°<br>
          â€¢ å¯ä»¥å¯ç”¨"å¼ºåˆ¶æ‰€æœ‰ç‰ˆæœ¬æ›´æ–°"ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯éƒ½å¿…é¡»æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬<br>
          â€¢ ä¿®æ”¹åç‚¹å‡»"åº”ç”¨å¼ºåˆ¶æ›´æ–°è®¾ç½®"ä¿å­˜
        </div>
        
        <div class="field">
          <label>å¹³å°/æ¶æ„</label>
          <select id="update-platform-select">
            <option value="win32:x64">Windows x64</option>
            <option value="win32:arm64">Windows ARM64</option>
            <option value="darwin:x64">macOS Intel</option>
            <option value="darwin:arm64">macOS Apple Silicon</option>
            <option value="linux:x64">Linux x64</option>
            <option value="linux:arm64">Linux ARM64</option>
          </select>
          <div style="font-size:12px; color:#666; margin-top:4px;">
            é€‰æ‹©è¦è®¾ç½®å¼ºåˆ¶æ›´æ–°çš„å¹³å°/æ¶æ„
          </div>
        </div>
        
        <div class="field">
          <label for="update-minimum-version">æœ€ä½è¦æ±‚ç‰ˆæœ¬ï¼ˆå¯é€‰ï¼‰</label>
          <select id="update-minimum-version">
            <option value="">ä¸è®¾ç½®æœ€ä½ç‰ˆæœ¬è¦æ±‚</option>
          </select>
          <div style="font-size:12px; color:#666; margin-top:4px;">
            ä½äºæ­¤ç‰ˆæœ¬çš„å®¢æˆ·ç«¯å°†è¢«å¼ºåˆ¶æ›´æ–°ï¼ˆä»å·²å‘å¸ƒçš„ç‰ˆæœ¬ä¸­é€‰æ‹©ï¼‰
          </div>
        </div>
        
        <div class="field">
          <label>
            <input type="checkbox" id="update-force-update" />
            <span style="margin-left:6px;">å¼ºåˆ¶æ‰€æœ‰ç‰ˆæœ¬æ›´æ–°</span>
          </label>
          <div style="font-size:12px; color:#666; margin-top:4px;">
            å¯ç”¨åï¼Œæ‰€æœ‰ç‰ˆæœ¬çš„å®¢æˆ·ç«¯éƒ½å¿…é¡»æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬
          </div>
        </div>
        
        <div class="btn-group">
          <button class="btn btn-secondary" id="btn-get-update-info">
            <i class="fas fa-download"></i> æŸ¥çœ‹å½“å‰ç‰ˆæœ¬ä¿¡æ¯
          </button>
          <button class="btn btn-primary" id="btn-sync-from-github">
            <i class="fas fa-sync-alt"></i> ä» GitHub åŒæ­¥
          </button>
          <button class="btn btn-success" id="btn-apply-force-update">
            <i class="fas fa-save"></i> åº”ç”¨å¼ºåˆ¶æ›´æ–°è®¾ç½®
          </button>
        </div>
        <div id="update-info-status"></div>
      </div>
      
      <div class="card">
        <h2><i class="fas fa-info-circle"></i> å½“å‰ç‰ˆæœ¬ä¿¡æ¯ï¼ˆåªè¯»ï¼‰</h2>
        <div class="field">
          <label for="update-info-json">ç‰ˆæœ¬ä¿¡æ¯ JSON</label>
          <textarea id="update-info-json" placeholder='ç‚¹å‡»"æŸ¥çœ‹å½“å‰ç‰ˆæœ¬ä¿¡æ¯"æŒ‰é’®åŠ è½½æ•°æ®' style="min-height:200px;" readonly></textarea>
        </div>
        <div style="font-size:12px; color:#666; margin-top:8px;">
          ğŸ’¡ æç¤ºï¼šç‰ˆæœ¬ä¿¡æ¯ä¼šè‡ªåŠ¨ä» GitHub Releases åŒæ­¥ï¼Œæ— éœ€æ‰‹åŠ¨ä¸Šä¼ 
        </div>
      </div>

      <div class="card">
        <h2><i class="fas fa-book"></i> æ›´æ–°æ—¥å¿—ç®¡ç†</h2>
        <div style="background:#e3f2fd; padding:12px; border-radius:8px; margin-bottom:16px; font-size:13px; line-height:1.6;">
          <strong>ğŸ’¡ ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
          â€¢ ç‚¹å‡»"æ·»åŠ ç‰ˆæœ¬"æŒ‰é’®æ·»åŠ æ–°ç‰ˆæœ¬çš„æ›´æ–°æ—¥å¿—<br>
          â€¢ æ”¯æŒä¸Šä¼  .md æ–‡ä»¶è‡ªåŠ¨å¡«å……å†…å®¹ï¼Œæˆ–æ‰‹åŠ¨è¾“å…¥<br>
          â€¢ å¯ä»¥ç¼–è¾‘ã€åˆ é™¤å·²æœ‰ç‰ˆæœ¬çš„æ—¥å¿—<br>
          â€¢ ä¿®æ”¹åç‚¹å‡»"ä¿å­˜æ‰€æœ‰æ›´æ”¹"ä¸Šä¼ åˆ°æœåŠ¡å™¨
        </div>
        
        <div class="btn-group">
          <button class="btn btn-success" id="btn-add-changelog-version">
            <i class="fas fa-plus"></i> æ·»åŠ ç‰ˆæœ¬
          </button>
          <button class="btn btn-secondary" id="btn-get-changelog">
            <i class="fas fa-download"></i> ä»æœåŠ¡å™¨åŠ è½½
          </button>
          <button class="btn btn-primary" id="btn-sync-changelog-from-github">
            <i class="fas fa-sync-alt"></i> ä» GitHub åŒæ­¥
          </button>
          <button class="btn btn-primary" id="btn-put-changelog">
            <i class="fas fa-save"></i> ä¿å­˜æ‰€æœ‰æ›´æ”¹
          </button>
        </div>
        
        <div id="changelog-list-container" style="margin-top:20px;">
          <div id="changelog-list-empty" style="text-align:center; padding:40px; color:#999;">
            <i class="fas fa-inbox" style="font-size:48px; margin-bottom:12px; opacity:0.3;"></i>
            <div>æš‚æ— æ›´æ–°æ—¥å¿—ï¼Œç‚¹å‡»"æ·»åŠ ç‰ˆæœ¬"å¼€å§‹æ·»åŠ </div>
          </div>
          <div id="changelog-list" style="display:none;"></div>
        </div>
        
        <div id="changelog-status" style="margin-top:16px;"></div>
      </div>
      
      <!-- ç‰ˆæœ¬æ—¥å¿—ç¼–è¾‘æ¨¡æ€æ¡† -->
      <div class="modal" id="changelog-edit-modal">
        <div class="modal-content" style="max-width:800px;">
          <div class="modal-header">
            <h3 id="changelog-modal-title">æ·»åŠ æ›´æ–°æ—¥å¿—</h3>
            <button class="close-btn" id="changelog-modal-close">&times;</button>
          </div>
          <div class="modal-body">
            <div class="field">
              <label for="changelog-edit-version">ç‰ˆæœ¬å· *</label>
              <input type="text" id="changelog-edit-version" placeholder="1.5.5" />
            </div>
            
            <div class="field">
              <label for="changelog-edit-title">ç‰ˆæœ¬æ ‡é¢˜</label>
              <input type="text" id="changelog-edit-title" placeholder="ç‰ˆæœ¬ 1.5.5" />
              <div style="font-size:12px; color:#666; margin-top:4px;">
                å¦‚æœä¸å¡«å†™ï¼Œå°†è‡ªåŠ¨ä½¿ç”¨"ç‰ˆæœ¬ {ç‰ˆæœ¬å·}"
              </div>
            </div>
            
            <div class="field">
              <label for="changelog-edit-md-file">
                <i class="fas fa-file-alt"></i> ä¸Šä¼  Markdown æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
              </label>
              <input type="file" id="changelog-edit-md-file" accept=".md,.markdown" />
              <div style="font-size:12px; color:#666; margin-top:4px;">
                ä¸Šä¼  .md æ–‡ä»¶åä¼šè‡ªåŠ¨å¡«å……ç‰ˆæœ¬å·å’Œå†…å®¹
              </div>
            </div>
            
            <div class="field">
              <label for="changelog-edit-content">æ›´æ–°å†…å®¹ï¼ˆæ”¯æŒ Markdownï¼‰*</label>
              <textarea id="changelog-edit-content" placeholder="### æ–°åŠŸèƒ½&#10;- åŠŸèƒ½1&#10;- åŠŸèƒ½2&#10;&#10;### ä¿®å¤&#10;- ä¿®å¤1" style="min-height:300px; font-family:monospace;"></textarea>
            </div>
            
            <div class="field">
              <label for="changelog-edit-releasedate">å‘å¸ƒæ—¥æœŸ</label>
              <input type="datetime-local" id="changelog-edit-releasedate" />
              <div style="font-size:12px; color:#666; margin-top:4px;">
                å¦‚æœä¸å¡«å†™ï¼Œå°†ä½¿ç”¨å½“å‰æ—¶é—´
              </div>
            </div>
            
            <div class="field">
              <label>
                <input type="checkbox" id="changelog-edit-prerelease" />
                <span style="margin-left:6px;">é¢„å‘å¸ƒç‰ˆæœ¬ï¼ˆbetaã€alphaã€rc ç­‰ï¼‰</span>
              </label>
            </div>
          </div>
          <div class="modal-footer" style="display:flex; gap:8px; justify-content:flex-end; padding-top:16px; border-top:1px solid #eee;">
            <button class="btn btn-secondary" id="changelog-modal-cancel">å–æ¶ˆ</button>
            <button class="btn btn-primary" id="changelog-modal-save">ä¿å­˜</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <div class="tab-content" id="tab-stats">
      <div class="card">
        <h2><i class="fas fa-chart-bar"></i> æ•°æ®ç»Ÿè®¡</h2>
        <div class="grid">
          <div class="card stat-card stat-card-secondary">
            <div class="stat-value" id="stat-runtime-count">-</div>
            <div class="stat-label">è¿æ§çº¿è·¯</div>
          </div>
        </div>
        <div class="btn-group btn-group-spaced">
          <button class="btn btn-primary" id="btn-refresh-stats">
            <i class="fas fa-sync"></i> åˆ·æ–°ç»Ÿè®¡
          </button>
        </div>
      </div>
      <div class="card">
        <h2><i class="fas fa-globe"></i> ä½¿ç”¨ç»Ÿè®¡</h2>
        <div class="grid">
          <div class="card stat-card stat-card-primary">
            <div class="stat-value" id="stat-users">-</div>
            <div class="stat-label">è®¿é—®æ¬¡æ•°</div>
          </div>
          <div class="card stat-card stat-card-secondary">
            <div class="stat-value" id="stat-unique-devices">-</div>
            <div class="stat-label">ç‹¬ç«‹è®¾å¤‡</div>
          </div>
        </div>
        <div class="field">
          <label><i class="fas fa-globe"></i> å…¨çƒåˆ†å¸ƒ</label>
          <div id="stat-by-country" class="stat-meta stat-tags">-</div>
        </div>
        <div class="field">
          <label><i class="fas fa-code-branch"></i> ä½¿ç”¨ç‰ˆæœ¬</label>
          <div id="stat-by-version" class="stat-meta stat-tags">-</div>
        </div>
        <div class="field">
          <label><i class="fas fa-desktop"></i> æ“ä½œç³»ç»Ÿåˆ†å¸ƒ</label>
          <div id="stat-by-os" class="stat-meta stat-tags">-</div>
        </div>
        <div class="field">
          <label><i class="fas fa-mobile-alt"></i> è®¾å¤‡ç»Ÿè®¡ï¼ˆå‰10ä¸ªï¼‰</label>
          <div id="stat-by-device" class="stat-meta stat-tags">-</div>
        </div>
        <div class="field">
          <label>
            æœ€è¿‘è®°å½•ï¼ˆæŒ‰æ—¥æœŸåˆ†ç»„ï¼Œå·²åˆå¹¶5åˆ†é’Ÿå†…é‡å¤è®¿é—®ï¼‰
            <span style="font-size:12px; color:#666; font-weight:normal; margin-left:8px;">ğŸ’¡ åŒä¸€è®¾å¤‡çŸ­æ—¶é—´å†…çš„é‡å¤è®¿é—®å·²è‡ªåŠ¨åˆå¹¶</span>
          </label>
          <div class="table-container" id="stat-recent-container">
            <table>
              <thead>
                <tr><th>å›½å®¶/åœ°åŒº</th><th>åŸå¸‚</th><th>æ“ä½œç³»ç»Ÿ</th><th>ç‰ˆæœ¬</th><th>è®¾å¤‡ID</th><th>æ—¶é—´ï¼ˆé‡å¤è®¿é—®ä¼šæ˜¾ç¤ºæ¬¡æ•°å’ŒæŒç»­æ—¶é—´ï¼‰</th><th>æ“ä½œ</th></tr>
              </thead>
              <tbody id="stat-recent-tbody">
                <tr><td colspan="6" class="empty-state">æš‚æ— </td></tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="btn-group btn-group-spaced">
          <button class="btn btn-primary" id="btn-refresh-usage">
            <i class="fas fa-sync"></i> åˆ·æ–°ä½¿ç”¨ç»Ÿè®¡
          </button>
          <button class="btn btn-secondary" id="btn-download-records">
            <i class="fas fa-download"></i> ä¸‹è½½è®¿é—®è®°å½•
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- è®¾ç½®æ¨¡æ€æ¡† -->
  <div class="modal" id="settings-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>è®¾ç½®</h3>
        <button class="close-btn" id="close-settings">&times;</button>
      </div>
      <div class="field">
        <label for="api-base">Cloudflare Worker API åœ°å€</label>
        <input type="text" id="api-base" placeholder="https://metro.tanzhouxiang.dpdns.org" />
      </div>
      <div class="field">
        <label for="api-token">è®¤è¯ Tokenï¼ˆå¯é€‰ï¼‰</label>
        <input type="password" id="api-token" placeholder="ä¸ CLOUD_TOKEN ä¸€è‡´" />
      </div>
      <div id="settings-check-status" class="field settings-check-status"></div>
      <div class="btn-group">
        <button class="btn btn-secondary" id="btn-check-api">
          <i class="fas fa-link"></i> æ ¡éªŒè¿æ¥
        </button>
        <button class="btn btn-primary" id="btn-save-settings">
          <i class="fas fa-save"></i> ä¿å­˜
        </button>
        <button class="btn btn-secondary" id="btn-cancel-settings">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <script>
    // é…ç½®ç®¡ç†
    const STORAGE_KEY = 'metro_pids_admin_config';
    
    function loadConfig() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : { apiBase: '', token: '' };
      } catch {
        return { apiBase: '', token: '' };
      }
    }
    
    function saveConfig(config) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(config));
    }
    
    function getConfig() {
      return {
        apiBase: document.getElementById('api-base').value.trim(),
        token: document.getElementById('api-token').value.trim()
      };
    }

    /** æ ¡éªŒ API è¿æ¥ï¼Œè¿”å› { ok: boolean, message?: string } */
    async function checkApiConnection() {
      const cfg = getConfig();
      if (!cfg.apiBase) return { ok: false, message: 'è¯·å…ˆå¡«å†™ API åœ°å€' };
      const url = cfg.apiBase.replace(/\/+$/, '') + '/';
      const headers = { 'Accept': 'application/json' };
      if (cfg.token) headers['Authorization'] = 'Bearer ' + cfg.token;
      try {
        const res = await fetch(url, { method: 'GET', headers });
        const text = await res.text();
        let data = null;
        try { data = text ? JSON.parse(text) : null; } catch (_) {}
        if (res.ok && data && data.ok) return { ok: true };
        const msg = (data && (data.error || data.message)) || ('HTTP ' + res.status);
        return { ok: false, message: msg };
      } catch (e) {
        return { ok: false, message: e.message || 'ç½‘ç»œé”™è¯¯' };
      }
    }
    
    // API è°ƒç”¨
    async function callApi(method, path, body = null) {
      const config = getConfig();
      if (!config.apiBase) {
        throw new Error('è¯·å…ˆè®¾ç½® API åœ°å€');
      }
      
      const url = config.apiBase.replace(/\/+$/, '') + path;
      const headers = {
        'Accept': 'application/json'
      };
      
      if (body) {
        headers['Content-Type'] = 'application/json';
      }
      
      if (config.token) {
        headers['Authorization'] = `Bearer ${config.token}`;
      }
      
      const response = await fetch(url, {
        method,
        headers,
        body: body ? JSON.stringify(body) : undefined
      });
      
      const text = await response.text();
      let data;
      try {
        data = text ? JSON.parse(text) : null;
      } catch {
        data = text;
      }
      
      if (!response.ok) {
        throw new Error(data.error || data.message || `HTTP ${response.status}: ${text}`);
      }
      
      return data;
    }
    
    // çŠ¶æ€æ˜¾ç¤º
    function showStatus(elementId, message, type = 'info') {
      const el = document.getElementById(elementId);
      if (!el) return;
      
      el.innerHTML = message ? `<span class="status ${type}">${message}</span>` : '';
    }
    
    // æ ‡ç­¾é¡µåˆ‡æ¢
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        
        // æ›´æ–°æ ‡ç­¾é¡µçŠ¶æ€
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // æ›´æ–°å†…å®¹æ˜¾ç¤º
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        document.getElementById(`tab-${tabName}`).classList.add('active');
        
        // æ ¹æ®æ ‡ç­¾é¡µè‡ªåŠ¨åŠ è½½æ•°æ®
        if (tabName === 'updates') {
          // åˆ‡æ¢åˆ°ç‰ˆæœ¬æ›´æ–°æ ‡ç­¾é¡µæ—¶ï¼Œè‡ªåŠ¨åŠ è½½æ›´æ–°æ—¥å¿—
          const cfg = getConfig();
          if (cfg.apiBase && changelogList.length === 0) {
            setTimeout(() => {
              document.getElementById('btn-get-changelog').click();
            }, 100);
          } else if (!cfg.apiBase) {
            showStatus('changelog-status', 'è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API åœ°å€', 'error');
          }
        } else if (tabName === 'stats') {
          // åˆ‡æ¢åˆ°ç»Ÿè®¡ä¿¡æ¯æ ‡ç­¾é¡µæ—¶ï¼Œè‡ªåŠ¨åˆ·æ–°ç»Ÿè®¡
          const cfg = getConfig();
          if (cfg.apiBase) {
            setTimeout(() => {
              document.getElementById('btn-refresh-stats').click();
              document.getElementById('btn-refresh-usage').click();
            }, 100);
          } else {
            showStatus('changelog-status', 'è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API åœ°å€', 'error');
          }
        }
      });
    });
    
    // è®¾ç½®æ¨¡æ€æ¡†
    const settingsModal = document.getElementById('settings-modal');
    const config = loadConfig();
    
    document.getElementById('btn-settings').addEventListener('click', () => {
      document.getElementById('api-base').value = config.apiBase || '';
      document.getElementById('api-token').value = config.token || '';
      document.getElementById('settings-check-status').innerHTML = '';
      settingsModal.classList.add('active');
    });
    
    document.getElementById('close-settings').addEventListener('click', () => {
      settingsModal.classList.remove('active');
    });
    
    document.getElementById('btn-cancel-settings').addEventListener('click', () => {
      settingsModal.classList.remove('active');
    });

    document.getElementById('btn-check-api').addEventListener('click', async () => {
      const el = document.getElementById('settings-check-status');
      const btn = document.getElementById('btn-check-api');
      el.innerHTML = '';
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> æ ¡éªŒä¸­...';
      try {
        const r = await checkApiConnection();
        if (r.ok) {
          el.innerHTML = '<span class="status success"><i class="fas fa-check-circle"></i> è¿æ¥æˆåŠŸ</span>';
        } else {
          el.innerHTML = '<span class="status error"><i class="fas fa-times-circle"></i> ' + (r.message || 'è¿æ¥å¤±è´¥') + '</span>';
        }
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-link"></i> æ ¡éªŒè¿æ¥';
      }
    });

    document.getElementById('btn-save-settings').addEventListener('click', async () => {
      const el = document.getElementById('settings-check-status');
      const saveBtn = document.getElementById('btn-save-settings');
      const newConfig = getConfig();
      el.innerHTML = '';
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<span class="loading"></span> æ ¡éªŒä¸­...';
      try {
        const r = await checkApiConnection();
        if (!r.ok) {
          el.innerHTML = '<span class="status error"><i class="fas fa-times-circle"></i> ' + (r.message || 'è¿æ¥å¤±è´¥') + 'ï¼Œæœªä¿å­˜</span>';
          return;
        }
        el.innerHTML = '<span class="status success"><i class="fas fa-check-circle"></i> æ ¡éªŒé€šè¿‡</span>';
        saveConfig(newConfig);
        Object.assign(config, newConfig);
        document.getElementById('api-base-display').textContent = config.apiBase || 'æœªè®¾ç½®';
        settingsModal.classList.remove('active');
        alert('è®¾ç½®å·²ä¿å­˜ï¼');
      } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save"></i> ä¿å­˜';
      }
    });
    
    // è¿æ§çº¿è·¯åŠŸèƒ½
    document.getElementById('btn-list-runtime').addEventListener('click', async () => {
      const tbody = document.getElementById('runtime-tbody');
      tbody.innerHTML = '<tr><td colspan="3" class="empty-state"><div class="loading"></div> åŠ è½½ä¸­...</td></tr>';
      
      try {
        const data = await callApi('GET', '/runtime/lines');
        const lines = data.lines || [];
        
        if (lines.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3" class="empty-state"><i class="fas fa-inbox"></i><div>æš‚æ— æ•°æ®</div></td></tr>';
          return;
        }
        
        tbody.innerHTML = lines.map(line => {
          const lineName = line.meta?.lineName || 'æœªçŸ¥';
          const stationCount = line.stations?.length || 0;
          return `
            <tr>
              <td><strong>${lineName}</strong></td>
              <td><span class="badge badge-info">${stationCount} ä¸ªç«™ç‚¹</span></td>
              <td>
                <button class="btn btn-secondary btn-small" onclick="loadRuntimeLine('${lineName}')">
                  <i class="fas fa-edit"></i> ç¼–è¾‘
                </button>
                <button class="btn btn-danger btn-small btn-small-spaced" onclick="deleteRuntimeLine('${lineName}')">
                  <i class="fas fa-trash"></i> åˆ é™¤
                </button>
              </td>
            </tr>
          `;
        }).join('');
      } catch (e) {
        tbody.innerHTML = `<tr><td colspan="3" class="empty-state"><i class="fas fa-exclamation-triangle"></i><div>åŠ è½½å¤±è´¥ï¼š${e.message}</div></td></tr>`;
      }
    });
    
    // è¿æ§çº¿è·¯æ–‡ä»¶ç®¡ç†
    let runtimeFiles = [];
    
    // å¤„ç†æ–‡ä»¶é€‰æ‹©
    document.getElementById('runtime-line-file-input').addEventListener('change', async (e) => {
      const files = Array.from(e.target.files);
      runtimeFiles = [];
      
      if (files.length === 0) {
        document.getElementById('runtime-files-list').style.display = 'none';
        return;
      }
      
      // æ˜¾ç¤ºå·²é€‰æ‹©çš„æ–‡ä»¶åˆ—è¡¨
      const filesList = document.getElementById('runtime-files-items');
      filesList.innerHTML = '';
      
      for (const file of files) {
        const li = document.createElement('li');
        li.innerHTML = `<code>${file.name}</code>`;
        filesList.appendChild(li);
        
        runtimeFiles.push(file);
      }
      
      document.getElementById('runtime-files-list').style.display = 'block';
      showStatus('runtime-status', `å·²é€‰æ‹© ${files.length} ä¸ªæ–‡ä»¶ï¼Œç‚¹å‡»"è§£æå¹¶ä¸Šä¼ æ–‡ä»¶"æŒ‰é’®å¤„ç†`, 'info');
    });
    
    // è§£æå¹¶ä¸Šä¼ æ–‡ä»¶
    document.getElementById('btn-parse-runtime-files').addEventListener('click', async () => {
      if (runtimeFiles.length === 0) {
        showStatus('runtime-status', 'è¯·å…ˆé€‰æ‹© JSON æ–‡ä»¶', 'error');
        return;
      }
      
      let successCount = 0;
      let failCount = 0;
      const errors = [];
      
      showStatus('runtime-status', `æ­£åœ¨å¤„ç† ${runtimeFiles.length} ä¸ªæ–‡ä»¶...`, 'info');
      
      for (const file of runtimeFiles) {
        try {
          const text = await file.text();
          const json = JSON.parse(text);
          
          // éªŒè¯ JSON æ ¼å¼
          if (!json.meta || !json.meta.lineName) {
            throw new Error(`æ–‡ä»¶ ${file.name} ç¼ºå°‘ meta.lineName å­—æ®µ`);
          }
          
          if (!Array.isArray(json.stations)) {
            throw new Error(`æ–‡ä»¶ ${file.name} ç¼ºå°‘ stations æ•°ç»„`);
          }
          
          const lineName = json.meta.lineName;
          
          // ä¸Šä¼ åˆ°æœåŠ¡å™¨
          await callApi('PUT', `/runtime/lines/${encodeURIComponent(lineName)}`, json);
          successCount++;
          
          // å¦‚æœåªæœ‰ä¸€ä¸ªæ–‡ä»¶ï¼Œè‡ªåŠ¨å¡«å……åˆ°é¢„è§ˆåŒºåŸŸ
          if (runtimeFiles.length === 1) {
            document.getElementById('runtime-line-name').value = lineName;
            document.getElementById('runtime-line-json').value = JSON.stringify(json, null, 2);
          }
        } catch (e) {
          failCount++;
          errors.push(`${file.name}: ${e.message}`);
          console.error(`å¤„ç†æ–‡ä»¶ ${file.name} å¤±è´¥:`, e);
        }
      }
      
      // æ˜¾ç¤ºç»“æœ
      if (failCount === 0) {
        showStatus('runtime-status', `âœ… æˆåŠŸä¸Šä¼  ${successCount} æ¡è¿æ§çº¿è·¯ï¼`, 'success');
        // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
        document.getElementById('runtime-line-file-input').value = '';
        document.getElementById('runtime-files-list').style.display = 'none';
        runtimeFiles = [];
        // åˆ·æ–°åˆ—è¡¨
        document.getElementById('btn-list-runtime').click();
      } else {
        const errorMsg = errors.join('; ');
        showStatus('runtime-status', `âš ï¸ æˆåŠŸ ${successCount} æ¡ï¼Œå¤±è´¥ ${failCount} æ¡ã€‚é”™è¯¯ï¼š${errorMsg}`, 'warn');
      }
    });
    
    window.loadRuntimeLine = async (lineName) => {
      document.getElementById('runtime-line-name').value = lineName;
      document.querySelector('.tab[data-tab="runtime"]').click();
      
      try {
        const data = await callApi('GET', `/runtime/lines/${encodeURIComponent(lineName)}`);
        document.getElementById('runtime-line-json').value = JSON.stringify(data.line || data, null, 2);
        showStatus('runtime-status', 'ä¸‹è½½æˆåŠŸ', 'success');
      } catch (e) {
        showStatus('runtime-status', `ä¸‹è½½å¤±è´¥ï¼š${e.message}`, 'error');
      }
    };

    window.deleteRuntimeLine = async (lineName) => {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤è¿æ§çº¿è·¯ "${lineName}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
        return;
      }
      try {
        await callApi('DELETE', `/runtime/lines/${encodeURIComponent(lineName)}`);
        showStatus('runtime-status', 'åˆ é™¤æˆåŠŸ', 'success');
        document.getElementById('btn-list-runtime').click();
      } catch (e) {
        showStatus('runtime-status', `åˆ é™¤å¤±è´¥ï¼š${e.message}`, 'error');
      }
    };
    
    document.getElementById('btn-get-runtime').addEventListener('click', async () => {
      const lineName = document.getElementById('runtime-line-name').value.trim();
      if (!lineName) {
        showStatus('runtime-status', 'è¯·å…ˆå¡«å†™çº¿è·¯åç§°', 'error');
        return;
      }
      
      try {
        const data = await callApi('GET', `/runtime/lines/${encodeURIComponent(lineName)}`);
        document.getElementById('runtime-line-json').value = JSON.stringify(data.line || data, null, 2);
        showStatus('runtime-status', 'ä¸‹è½½æˆåŠŸ', 'success');
      } catch (e) {
        showStatus('runtime-status', `ä¸‹è½½å¤±è´¥ï¼š${e.message}`, 'error');
      }
    });
    
    // æ‰‹åŠ¨ä¸Šä¼ ï¼ˆä» JSON æ–‡æœ¬æ¡†ï¼‰
    document.getElementById('runtime-line-json').addEventListener('change', () => {
      // å¦‚æœ JSON æ–‡æœ¬æ¡†æœ‰å†…å®¹ï¼Œå°è¯•è‡ªåŠ¨æå–çº¿è·¯åç§°
      const jsonText = document.getElementById('runtime-line-json').value.trim();
      if (jsonText && !document.getElementById('runtime-line-name').value.trim()) {
        try {
          const json = JSON.parse(jsonText);
          if (json.meta && json.meta.lineName) {
            document.getElementById('runtime-line-name').value = json.meta.lineName;
          }
        } catch (e) {
          // å¿½ç•¥è§£æé”™è¯¯
        }
      }
    });
    
    // æ·»åŠ æ‰‹åŠ¨ä¸Šä¼ æŒ‰é’®ï¼ˆå¯é€‰ï¼Œç”¨äºç¼–è¾‘å·²æœ‰çº¿è·¯ï¼‰
    const manualUploadBtn = document.createElement('button');
    manualUploadBtn.className = 'btn btn-primary';
    manualUploadBtn.innerHTML = '<i class="fas fa-upload"></i> æ‰‹åŠ¨ä¸Šä¼ ï¼ˆä»æ–‡æœ¬æ¡†ï¼‰';
    manualUploadBtn.style.marginTop = '8px';
    manualUploadBtn.addEventListener('click', async () => {
      const lineName = document.getElementById('runtime-line-name').value.trim();
      const jsonText = document.getElementById('runtime-line-json').value.trim();
      
      if (!lineName || !jsonText) {
        showStatus('runtime-status', 'è¯·å¡«å†™çº¿è·¯åç§°å’Œ JSON æ•°æ®', 'error');
        return;
      }
      
      try {
        const json = JSON.parse(jsonText);
        if (!json.meta) json.meta = {};
        json.meta.lineName = lineName;
        
        await callApi('PUT', `/runtime/lines/${encodeURIComponent(lineName)}`, json);
        showStatus('runtime-status', 'ä¸Šä¼ æˆåŠŸ', 'success');
        document.getElementById('btn-list-runtime').click();
      } catch (e) {
        showStatus('runtime-status', `ä¸Šä¼ å¤±è´¥ï¼š${e.message}`, 'error');
      }
    });
    
    // å°†æ‰‹åŠ¨ä¸Šä¼ æŒ‰é’®æ’å…¥åˆ° JSON æ–‡æœ¬æ¡†ä¸‹æ–¹
    const runtimeJsonField = document.getElementById('runtime-line-json').parentElement;
    runtimeJsonField.appendChild(manualUploadBtn);
    
    document.getElementById('btn-del-runtime').addEventListener('click', async () => {
      const lineName = document.getElementById('runtime-line-name').value.trim();
      if (!lineName) {
        showStatus('runtime-status', 'è¯·å…ˆå¡«å†™çº¿è·¯åç§°', 'error');
        return;
      }
      
      if (!confirm(`ç¡®å®šè¦åˆ é™¤è¿æ§çº¿è·¯ "${lineName}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
        return;
      }
      
      try {
        await callApi('DELETE', `/runtime/lines/${encodeURIComponent(lineName)}`);
        showStatus('runtime-status', 'åˆ é™¤æˆåŠŸ', 'success');
        document.getElementById('runtime-line-name').value = '';
        document.getElementById('runtime-line-json').value = '';
        document.getElementById('btn-list-runtime').click();
      } catch (e) {
        showStatus('runtime-status', `åˆ é™¤å¤±è´¥ï¼š${e.message}`, 'error');
      }
    });
    
    // å½©è›‹é…ç½®
    document.getElementById('btn-get-easter-eggs').addEventListener('click', async () => {
      try {
        const data = await callApi('GET', '/easter-eggs');
        document.getElementById('easter-eggs-json').value = JSON.stringify(data.config || data, null, 2);
        showStatus('easter-eggs-status', 'ä¸‹è½½æˆåŠŸ', 'success');
      } catch (e) {
        showStatus('easter-eggs-status', `ä¸‹è½½å¤±è´¥ï¼š${e.message}`, 'error');
      }
    });
    
    document.getElementById('btn-put-easter-eggs').addEventListener('click', async () => {
      const jsonText = document.getElementById('easter-eggs-json').value.trim();
      if (!jsonText) {
        showStatus('easter-eggs-status', 'è¯·å¡«å†™é…ç½® JSON', 'error');
        return;
      }
      
      try {
        const json = JSON.parse(jsonText);
        await callApi('PUT', '/easter-eggs', json);
        showStatus('easter-eggs-status', 'ä¸Šä¼ æˆåŠŸ', 'success');
      } catch (e) {
        showStatus('easter-eggs-status', `ä¸Šä¼ å¤±è´¥ï¼š${e.message}`, 'error');
      }
    });
    
    // æ›´æ–°å½“å‰æ—¥æœŸæ˜¾ç¤º
    function updateCurrentDate() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
      const weekday = weekdays[now.getDay()];
      const time = now.toLocaleTimeString('zh-CN', { hour12: false });
      document.getElementById('current-date-display').textContent = 
        `${year}å¹´${month}æœˆ${day}æ—¥ï¼ˆæ˜ŸæœŸ${weekday}ï¼‰ ${time} | æœˆä»½ï¼š${month}ï¼Œæ—¥æœŸï¼š${day}`;
    }
    updateCurrentDate();
    setInterval(updateCurrentDate, 1000);

    // èŠ‚æ—¥é…ç½®
    document.getElementById('btn-get-holidays').addEventListener('click', async () => {
      try {
        const data = await callApi('GET', '/holidays');
        document.getElementById('holidays-json').value = JSON.stringify(data.config || data, null, 2);
        showStatus('holidays-status', 'ä¸‹è½½æˆåŠŸ', 'success');
      } catch (e) {
        showStatus('holidays-status', `ä¸‹è½½å¤±è´¥ï¼š${e.message}`, 'error');
      }
    });
    
    document.getElementById('btn-put-holidays').addEventListener('click', async () => {
      const jsonText = document.getElementById('holidays-json').value.trim();
      if (!jsonText) {
        showStatus('holidays-status', 'è¯·å¡«å†™é…ç½® JSON', 'error');
        return;
      }
      
      try {
        const json = JSON.parse(jsonText);
        await callApi('PUT', '/holidays', json);
        showStatus('holidays-status', 'ä¸Šä¼ æˆåŠŸ', 'success');
      } catch (e) {
        showStatus('holidays-status', `ä¸Šä¼ å¤±è´¥ï¼š${e.message}`, 'error');
      }
    });
    
    document.getElementById('btn-get-active-holidays').addEventListener('click', async () => {
      try {
        const data = await callApi('GET', '/holidays/active');
        const active = data.active || [];
        if (active.length === 0) {
          alert('å½“å‰æ²¡æœ‰æ¿€æ´»çš„èŠ‚æ—¥');
        } else {
          alert('å½“å‰æ¿€æ´»çš„èŠ‚æ—¥ï¼š\n' + JSON.stringify(active, null, 2));
        }
        showStatus('holidays-status', 'æŸ¥è¯¢æˆåŠŸ', 'success');
      } catch (e) {
        showStatus('holidays-status', `æŸ¥è¯¢å¤±è´¥ï¼š${e.message}`, 'error');
      }
    });
    
    // ç‰ˆæœ¬æ›´æ–°ç®¡ç†ï¼ˆç®€åŒ–ç‰ˆï¼šåªä¿ç•™å¼ºåˆ¶æ›´æ–°è®¾ç½®ï¼‰
    
    // è·å–ç‰ˆæœ¬ä¿¡æ¯ï¼ˆç”¨äºæ˜¾ç¤ºå’Œè®¾ç½®å¼ºåˆ¶æ›´æ–°ï¼‰
    document.getElementById('btn-get-update-info').addEventListener('click', async () => {
      const platform = document.getElementById('update-platform-select').value;
      const [plat, arch] = platform.split(':');
      
      const cfg = getConfig();
      if (!cfg.apiBase) {
        showStatus('update-info-status', 'è¯·å…ˆé…ç½® API åœ°å€', 'error');
        return;
      }
      
      try {
        showStatus('update-info-status', 'æ­£åœ¨åŠ è½½ç‰ˆæœ¬ä¿¡æ¯...', 'info');
        // ä» Worker API è·å–ç‰ˆæœ¬ä¿¡æ¯
        const checkUrl = `${cfg.apiBase}/update/check?platform=${plat}&arch=${arch}`;
        const res = await fetch(checkUrl, {
          headers: { 'Accept': 'application/json' }
        });
        const data = await res.json();
        
        if (data.ok && data.updateInfo) {
          document.getElementById('update-info-json').value = JSON.stringify(data.updateInfo, null, 2);
          
          // è‡ªåŠ¨å¡«å……å¼ºåˆ¶æ›´æ–°è®¾ç½®
          if (data.updateInfo.minimumVersion) {
            document.getElementById('update-minimum-version').value = data.updateInfo.minimumVersion;
          } else {
            document.getElementById('update-minimum-version').value = '';
          }
          document.getElementById('update-force-update').checked = data.updateInfo.forceUpdate === true;
          
          // å¦‚æœæ›´æ–°æ—¥å¿—å·²åŠ è½½ï¼Œç¡®ä¿æœ€ä½ç‰ˆæœ¬ä¸‹æ‹‰èœå•åŒ…å«å½“å‰ç‰ˆæœ¬ä¿¡æ¯ä¸­çš„ minimumVersionï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if (data.updateInfo.minimumVersion && changelogList.length > 0) {
            updateMinimumVersionSelect();
            // æ¢å¤é€‰æ‹©çš„å€¼
            if (data.updateInfo.minimumVersion) {
              document.getElementById('update-minimum-version').value = data.updateInfo.minimumVersion;
            }
          }
          
          showStatus('update-info-status', 'âœ… ç‰ˆæœ¬ä¿¡æ¯åŠ è½½æˆåŠŸ', 'success');
        } else {
          document.getElementById('update-info-json').value = 'æš‚æ— ç‰ˆæœ¬ä¿¡æ¯ï¼ˆç‰ˆæœ¬ä¿¡æ¯ä¼šè‡ªåŠ¨ä» GitHub Releases åŒæ­¥ï¼‰';
          showStatus('update-info-status', 'âš ï¸ æš‚æ— ç‰ˆæœ¬ä¿¡æ¯ï¼Œè¯·å…ˆå‘å¸ƒ GitHub Release', 'warn');
        }
      } catch (e) {
        showStatus('update-info-status', `åŠ è½½å¤±è´¥ï¼š${e.message}`, 'error');
        console.error('åŠ è½½ç‰ˆæœ¬ä¿¡æ¯å¤±è´¥:', e);
      }
    });

    // ä» GitHub åŒæ­¥ç‰ˆæœ¬ä¿¡æ¯
    document.getElementById('btn-sync-from-github').addEventListener('click', async () => {
      const platform = document.getElementById('update-platform-select').value;
      const [plat, arch] = platform.split(':');
      
      const cfg = getConfig();
      if (!cfg.apiBase) {
        showStatus('update-info-status', 'è¯·å…ˆé…ç½® API åœ°å€', 'error');
        return;
      }
      
      try {
        showStatus('update-info-status', 'æ­£åœ¨ä» GitHub åŒæ­¥ç‰ˆæœ¬ä¿¡æ¯...', 'info');
        
        // è°ƒç”¨åŒæ­¥ APIï¼ˆå¼ºåˆ¶åŒæ­¥ï¼Œå¿½ç•¥èŠ‚æµï¼‰
        // ä½¿ç”¨ callApi å‡½æ•°ä»¥ç¡®ä¿è®¤è¯ token è¢«æ­£ç¡®ä¼ é€’
        const data = await callApi('POST', `/update/sync/github?platform=${plat}&arch=${arch}`);
        
        if (!data.ok) {
          throw new Error(data.error || 'åŒæ­¥å¤±è´¥');
        }
        
        // åŒæ­¥æˆåŠŸåï¼Œè‡ªåŠ¨åˆ·æ–°ç‰ˆæœ¬ä¿¡æ¯æ˜¾ç¤º
        showStatus('update-info-status', 'âœ… å·²ä» GitHub åŒæ­¥æˆåŠŸï¼Œæ­£åœ¨åˆ·æ–°...', 'success');
        
        // å»¶è¿Ÿä¸€ä¸‹å†åˆ·æ–°ï¼Œç¡®ä¿ KV å·²æ›´æ–°
        setTimeout(async () => {
          try {
            const checkUrl = `${cfg.apiBase}/update/check?platform=${plat}&arch=${arch}&noCache=1`;
            const checkRes = await fetch(checkUrl, {
              headers: { 'Accept': 'application/json' }
            });
            const checkData = await checkRes.json();
            
            if (checkData.ok && checkData.updateInfo) {
              document.getElementById('update-info-json').value = JSON.stringify(checkData.updateInfo, null, 2);
              
              // è‡ªåŠ¨å¡«å……å¼ºåˆ¶æ›´æ–°è®¾ç½®
              if (checkData.updateInfo.minimumVersion) {
                document.getElementById('update-minimum-version').value = checkData.updateInfo.minimumVersion;
              } else {
                document.getElementById('update-minimum-version').value = '';
              }
              document.getElementById('update-force-update').checked = checkData.updateInfo.forceUpdate === true;
              
              showStatus('update-info-status', `âœ… åŒæ­¥æˆåŠŸï¼å½“å‰ç‰ˆæœ¬: ${checkData.updateInfo.version}`, 'success');
            } else {
              showStatus('update-info-status', 'âš ï¸ åŒæ­¥å®Œæˆï¼Œä½†æ— æ³•è·å–ç‰ˆæœ¬ä¿¡æ¯', 'warn');
            }
          } catch (e) {
            showStatus('update-info-status', `åŒæ­¥æˆåŠŸï¼Œä½†åˆ·æ–°å¤±è´¥ï¼š${e.message}`, 'warn');
          }
        }, 500);
        
      } catch (e) {
        showStatus('update-info-status', `åŒæ­¥å¤±è´¥ï¼š${e.message}`, 'error');
        console.error('ä» GitHub åŒæ­¥å¤±è´¥:', e);
      }
    });

    // åº”ç”¨å¼ºåˆ¶æ›´æ–°è®¾ç½®ï¼ˆåªæ›´æ–°å¼ºåˆ¶æ›´æ–°ç›¸å…³å­—æ®µï¼Œä¸è¦†ç›–å…¶ä»–ç‰ˆæœ¬ä¿¡æ¯ï¼‰
    document.getElementById('btn-apply-force-update').addEventListener('click', async () => {
      const platform = document.getElementById('update-platform-select').value;
      const [plat, arch] = platform.split(':');
      const minimumVersion = document.getElementById('update-minimum-version').value;
      const forceUpdate = document.getElementById('update-force-update').checked;
      
      const cfg = getConfig();
      if (!cfg.apiBase) {
        showStatus('update-info-status', 'è¯·å…ˆé…ç½® API åœ°å€', 'error');
        return;
      }
      
      try {
        showStatus('update-info-status', 'æ­£åœ¨åº”ç”¨å¼ºåˆ¶æ›´æ–°è®¾ç½®...', 'info');
        
        // å…ˆè·å–å½“å‰ç‰ˆæœ¬ä¿¡æ¯
        const checkUrl = `${cfg.apiBase}/update/check?platform=${plat}&arch=${arch}`;
        const res = await fetch(checkUrl, {
          headers: { 'Accept': 'application/json' }
        });
        const data = await res.json();
        
        if (!data.ok || !data.updateInfo) {
          showStatus('update-info-status', 'âŒ æ— æ³•è·å–å½“å‰ç‰ˆæœ¬ä¿¡æ¯ï¼Œè¯·å…ˆå‘å¸ƒ GitHub Release', 'error');
          return;
        }
        
        // åˆå¹¶å¼ºåˆ¶æ›´æ–°è®¾ç½®åˆ°ç°æœ‰ç‰ˆæœ¬ä¿¡æ¯
        const updateInfo = {
          ...data.updateInfo,
          minimumVersion: minimumVersion || undefined,
          forceUpdate: forceUpdate || undefined
        };
        
        // å¦‚æœå–æ¶ˆæœ€ä½ç‰ˆæœ¬è¦æ±‚ï¼Œåˆ é™¤è¯¥å­—æ®µ
        if (!minimumVersion && updateInfo.minimumVersion) {
          delete updateInfo.minimumVersion;
        }
        // å¦‚æœå–æ¶ˆå¼ºåˆ¶æ›´æ–°ï¼Œåˆ é™¤è¯¥å­—æ®µ
        if (!forceUpdate && updateInfo.forceUpdate) {
          delete updateInfo.forceUpdate;
        }
        
        // ä¸Šä¼ æ›´æ–°åçš„ç‰ˆæœ¬ä¿¡æ¯
        await callApi('PUT', `/update/info?platform=${plat}&arch=${arch}`, updateInfo);
        
        // åˆ·æ–°æ˜¾ç¤º
        document.getElementById('update-info-json').value = JSON.stringify(updateInfo, null, 2);
        showStatus('update-info-status', 'âœ… å¼ºåˆ¶æ›´æ–°è®¾ç½®å·²åº”ç”¨æˆåŠŸï¼', 'success');
      } catch (e) {
        showStatus('update-info-status', `åº”ç”¨å¤±è´¥ï¼š${e.message}`, 'error');
        console.error('åº”ç”¨å¼ºåˆ¶æ›´æ–°è®¾ç½®å¤±è´¥:', e);
      }
    });
    

    // æ›´æ–°æ—¥å¿—ç®¡ç†ï¼ˆåˆ—è¡¨æ¨¡å¼ï¼‰
    let changelogList = [];
    let editingIndex = -1;
    const changelogModal = document.getElementById('changelog-edit-modal');
    
    // æ›´æ–°æœ€ä½ç‰ˆæœ¬ä¸‹æ‹‰èœå•
    function updateMinimumVersionSelect() {
      const select = document.getElementById('update-minimum-version');
      const currentValue = select.value;
      
      // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™ç¬¬ä¸€ä¸ª"ä¸è®¾ç½®"é€‰é¡¹ï¼‰
      select.innerHTML = '<option value="">ä¸è®¾ç½®æœ€ä½ç‰ˆæœ¬è¦æ±‚</option>';
      
      // ä»æ›´æ–°æ—¥å¿—åˆ—è¡¨ä¸­æå–ç‰ˆæœ¬å·
      const versions = changelogList.map(c => c.version).filter(v => v);
      
      // æŒ‰ç‰ˆæœ¬å·æ’åºï¼ˆä»é«˜åˆ°ä½ï¼‰
      versions.sort((a, b) => {
        const aParts = a.split('.').map(Number);
        const bParts = b.split('.').map(Number);
        for (let i = 0; i < Math.max(aParts.length, bParts.length); i++) {
          const aVal = aParts[i] || 0;
          const bVal = bParts[i] || 0;
          if (bVal !== aVal) return bVal - aVal;
        }
        return 0;
      });
      
      // æ·»åŠ ç‰ˆæœ¬é€‰é¡¹
      versions.forEach(version => {
        const option = document.createElement('option');
        option.value = version;
        option.textContent = `v${version}`;
        select.appendChild(option);
      });
      
      // æ¢å¤ä¹‹å‰é€‰æ‹©çš„å€¼ï¼ˆå¦‚æœè¿˜å­˜åœ¨ï¼‰
      if (currentValue && versions.includes(currentValue)) {
        select.value = currentValue;
      }
    }
    
    // ä»æ–‡ä»¶åæå–ç‰ˆæœ¬å·
    function extractVersionFromFilename(filename) {
      const patterns = [
        /(?:CHANGELOG|changelog)[-_]?v?(\d+\.\d+\.\d+(?:[-.]\w+)?)/i,
        /v?(\d+\.\d+\.\d+(?:[-.]\w+)?)\.md$/i,
        /(\d+\.\d+\.\d+(?:[-.]\w+)?)\.md$/i
      ];
      
      for (const pattern of patterns) {
        const match = filename.match(pattern);
        if (match && match[1]) {
          return match[1];
        }
      }
      return null;
    }
    
    // ä» Markdown å†…å®¹æå–æ ‡é¢˜
    function extractTitleFromMarkdown(content) {
      const lines = content.split('\n');
      for (const line of lines) {
        const trimmed = line.trim();
        if (trimmed.startsWith('# ')) {
          return trimmed.substring(2).trim();
        } else if (trimmed.startsWith('## ')) {
          return trimmed.substring(3).trim();
        }
      }
      return null;
    }
    
    // æ¸²æŸ“æ›´æ–°æ—¥å¿—åˆ—è¡¨
    function renderChangelogList() {
      const container = document.getElementById('changelog-list');
      const empty = document.getElementById('changelog-list-empty');
      
      if (changelogList.length === 0) {
        container.style.display = 'none';
        empty.style.display = 'block';
        return;
      }
      
      empty.style.display = 'none';
      container.style.display = 'block';
      container.innerHTML = '';
      
      // æŒ‰ç‰ˆæœ¬å·æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
      const sorted = [...changelogList].sort((a, b) => {
        const aParts = a.version.split('.').map(Number);
        const bParts = b.version.split('.').map(Number);
        for (let i = 0; i < Math.max(aParts.length, bParts.length); i++) {
          const aVal = aParts[i] || 0;
          const bVal = bParts[i] || 0;
          if (bVal !== aVal) return bVal - aVal;
        }
        return new Date(b.releaseDate) - new Date(a.releaseDate);
      });
      
      sorted.forEach((item, index) => {
        const actualIndex = changelogList.indexOf(item);
        const releaseDate = new Date(item.releaseDate).toLocaleString('zh-CN');
        const contentPreview = item.content.substring(0, 100).replace(/\n/g, ' ').trim() + (item.content.length > 100 ? '...' : '');
        
        const card = document.createElement('div');
        card.className = 'card';
        card.style.marginBottom = '12px';
        card.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:start;">
            <div style="flex:1;">
              <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
                <h3 style="margin:0; font-size:18px;">
                  ${item.prerelease ? '<span style="background:#ff9800; color:white; padding:2px 8px; border-radius:4px; font-size:12px; margin-right:8px;">é¢„å‘å¸ƒ</span>' : ''}
                  <span style="color:#667eea;">${item.title || `ç‰ˆæœ¬ ${item.version}`}</span>
                </h3>
                <code style="background:#f0f0f0; padding:2px 8px; border-radius:4px; font-size:12px;">v${item.version}</code>
              </div>
              <div style="color:#666; font-size:13px; margin-bottom:8px;">
                <i class="fas fa-calendar"></i> ${releaseDate}
              </div>
              <div style="color:#888; font-size:12px; line-height:1.5; max-height:60px; overflow:hidden;">
                ${contentPreview}
              </div>
            </div>
            <div style="display:flex; gap:8px; margin-left:16px;">
              <button class="btn btn-sm btn-secondary" onclick="editChangelog(${actualIndex})">
                <i class="fas fa-edit"></i> ç¼–è¾‘
              </button>
              <button class="btn btn-sm btn-danger" onclick="deleteChangelog(${actualIndex})">
                <i class="fas fa-trash"></i> åˆ é™¤
              </button>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }
    
    // ç¼–è¾‘æ›´æ–°æ—¥å¿—
    window.editChangelog = function(index) {
      editingIndex = index;
      const item = changelogList[index];
      
      document.getElementById('changelog-modal-title').textContent = 'ç¼–è¾‘æ›´æ–°æ—¥å¿—';
      document.getElementById('changelog-edit-version').value = item.version;
      document.getElementById('changelog-edit-title').value = item.title || '';
      document.getElementById('changelog-edit-content').value = item.content;
      document.getElementById('changelog-edit-prerelease').checked = item.prerelease || false;
      
      // è®¾ç½®å‘å¸ƒæ—¥æœŸ
      const date = new Date(item.releaseDate);
      const dateStr = date.toISOString().slice(0, 16);
      document.getElementById('changelog-edit-releasedate').value = dateStr;
      
      // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
      document.getElementById('changelog-edit-md-file').value = '';
      
      changelogModal.classList.add('active');
    };
    
    // åˆ é™¤æ›´æ–°æ—¥å¿—
    window.deleteChangelog = function(index) {
      if (confirm(`ç¡®å®šè¦åˆ é™¤ç‰ˆæœ¬ ${changelogList[index].version} çš„æ›´æ–°æ—¥å¿—å—ï¼Ÿ`)) {
        changelogList.splice(index, 1);
        renderChangelogList();
        updateMinimumVersionSelect(); // æ›´æ–°æœ€ä½ç‰ˆæœ¬ä¸‹æ‹‰èœå•
        showStatus('changelog-status', 'å·²åˆ é™¤', 'success');
      }
    };
    
    // æ‰“å¼€æ·»åŠ æ¨¡æ€æ¡†
    document.getElementById('btn-add-changelog-version').addEventListener('click', () => {
      editingIndex = -1;
      document.getElementById('changelog-modal-title').textContent = 'æ·»åŠ æ›´æ–°æ—¥å¿—';
      document.getElementById('changelog-edit-version').value = '';
      document.getElementById('changelog-edit-title').value = '';
      document.getElementById('changelog-edit-content').value = '';
      document.getElementById('changelog-edit-releasedate').value = '';
      document.getElementById('changelog-edit-prerelease').checked = false;
      document.getElementById('changelog-edit-md-file').value = '';
      changelogModal.classList.add('active');
    });
    
    // å…³é—­æ¨¡æ€æ¡†
    document.getElementById('changelog-modal-close').addEventListener('click', () => {
      changelogModal.classList.remove('active');
    });
    
    document.getElementById('changelog-modal-cancel').addEventListener('click', () => {
      changelogModal.classList.remove('active');
    });
    
    // å¤„ç† Markdown æ–‡ä»¶ä¸Šä¼ 
    document.getElementById('changelog-edit-md-file').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      try {
        const content = await file.text();
        const version = extractVersionFromFilename(file.name);
        const title = extractTitleFromMarkdown(content);
        
        if (version) {
          document.getElementById('changelog-edit-version').value = version;
        }
        if (title) {
          document.getElementById('changelog-edit-title').value = title;
        }
        document.getElementById('changelog-edit-content').value = content.trim();
        
        showStatus('changelog-status', 'Markdown æ–‡ä»¶å·²åŠ è½½', 'success');
      } catch (e) {
        showStatus('changelog-status', `è¯»å–æ–‡ä»¶å¤±è´¥ï¼š${e.message}`, 'error');
      }
    });
    
    // ä¿å­˜æ›´æ–°æ—¥å¿—æ¡ç›®
    document.getElementById('changelog-modal-save').addEventListener('click', () => {
      const version = document.getElementById('changelog-edit-version').value.trim();
      const title = document.getElementById('changelog-edit-title').value.trim();
      const content = document.getElementById('changelog-edit-content').value.trim();
      const releaseDate = document.getElementById('changelog-edit-releasedate').value;
      const prerelease = document.getElementById('changelog-edit-prerelease').checked;
      
      if (!version) {
        showStatus('changelog-status', 'è¯·å¡«å†™ç‰ˆæœ¬å·', 'error');
        return;
      }
      
      if (!content) {
        showStatus('changelog-status', 'è¯·å¡«å†™æ›´æ–°å†…å®¹', 'error');
        return;
      }
      
      // æ£€æŸ¥ç‰ˆæœ¬å·æ˜¯å¦é‡å¤ï¼ˆç¼–è¾‘æ—¶æ’é™¤è‡ªå·±ï¼‰
      if (editingIndex === -1) {
        const exists = changelogList.findIndex(c => c.version === version);
        if (exists >= 0) {
          if (!confirm(`ç‰ˆæœ¬ ${version} å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦è¦†ç›–ï¼Ÿ`)) {
            return;
          }
          changelogList[exists] = {
            version,
            title: title || `ç‰ˆæœ¬ ${version}`,
            content,
            releaseDate: releaseDate ? new Date(releaseDate).toISOString() : new Date().toISOString(),
            prerelease
          };
        } else {
          changelogList.unshift({
            version,
            title: title || `ç‰ˆæœ¬ ${version}`,
            content,
            releaseDate: releaseDate ? new Date(releaseDate).toISOString() : new Date().toISOString(),
            prerelease
          });
        }
      } else {
        changelogList[editingIndex] = {
          version,
          title: title || `ç‰ˆæœ¬ ${version}`,
          content,
          releaseDate: releaseDate ? new Date(releaseDate).toISOString() : changelogList[editingIndex].releaseDate,
          prerelease
        };
      }
      
      renderChangelogList();
      updateMinimumVersionSelect(); // æ›´æ–°æœ€ä½ç‰ˆæœ¬ä¸‹æ‹‰èœå•
      changelogModal.classList.remove('active');
      showStatus('changelog-status', editingIndex === -1 ? 'å·²æ·»åŠ ' : 'å·²æ›´æ–°', 'success');
    });
    
    // ä»æœåŠ¡å™¨åŠ è½½
    document.getElementById('btn-get-changelog').addEventListener('click', async () => {
      try {
        showStatus('changelog-status', 'æ­£åœ¨åŠ è½½...', 'info');
        const cfg = getConfig();
        if (!cfg.apiBase) {
          showStatus('changelog-status', 'è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API åœ°å€', 'error');
          return;
        }
        // çº¦å®šï¼šGET ${apiBase}/update/changelog?force=1ï¼Œä»æœåŠ¡å™¨ï¼ˆWorker ä»£ç† GitHubï¼‰æ‹‰å– { changelog }
        const data = await callApi('GET', '/update/changelog?force=1');
        changelogList = data.changelog || [];
        renderChangelogList();
        updateMinimumVersionSelect(); // æ›´æ–°æœ€ä½ç‰ˆæœ¬ä¸‹æ‹‰èœå•
        showStatus('changelog-status', `å·²åŠ è½½ ${changelogList.length} æ¡æ›´æ–°æ—¥å¿—`, 'success');
      } catch (e) {
        console.error('åŠ è½½æ›´æ–°æ—¥å¿—å¤±è´¥:', e);
        showStatus('changelog-status', `åŠ è½½å¤±è´¥ï¼š${e.message}`, 'error');
      }
    });

    // ä» GitHub åŒæ­¥æ›´æ–°æ—¥å¿—
    document.getElementById('btn-sync-changelog-from-github').addEventListener('click', async () => {
      const cfg = getConfig();
      if (!cfg.apiBase) {
        showStatus('changelog-status', 'è¯·å…ˆé…ç½® API åœ°å€', 'error');
        return;
      }
      
      try {
        showStatus('changelog-status', 'æ­£åœ¨ä» GitHub åŒæ­¥æ›´æ–°æ—¥å¿—...', 'info');
        
        // è°ƒç”¨åŒæ­¥ APIï¼ˆå¼ºåˆ¶åŒæ­¥ï¼Œå¿½ç•¥èŠ‚æµï¼‰
        const data = await callApi('POST', '/update/changelog/sync/github');
        
        if (!data.ok) {
          throw new Error(data.error || 'åŒæ­¥å¤±è´¥');
        }
        
        showStatus('changelog-status', 'âœ… å·²ä» GitHub åŒæ­¥æˆåŠŸï¼Œæ­£åœ¨åˆ·æ–°...', 'success');
        
        // å»¶è¿Ÿä¸€ä¸‹å†åˆ·æ–°ï¼Œç¡®ä¿ KV å·²æ›´æ–°
        setTimeout(async () => {
          try {
            const loadData = await callApi('GET', '/update/changelog?force=1');
            changelogList = loadData.changelog || [];
            renderChangelogList();
            updateMinimumVersionSelect();
            
            if (changelogList.length > 0) {
              const latestVersion = changelogList[0]?.version || 'unknown';
              showStatus('changelog-status', `âœ… åŒæ­¥æˆåŠŸï¼æœ€æ–°ç‰ˆæœ¬: ${latestVersion}ï¼Œå…± ${changelogList.length} æ¡æ›´æ–°æ—¥å¿—`, 'success');
            } else {
              showStatus('changelog-status', 'âš ï¸ åŒæ­¥å®Œæˆï¼Œä½†æš‚æ— æ›´æ–°æ—¥å¿—', 'warn');
            }
          } catch (e) {
            showStatus('changelog-status', `åŒæ­¥æˆåŠŸï¼Œä½†åˆ·æ–°å¤±è´¥ï¼š${e.message}`, 'warn');
          }
        }, 500);
        
      } catch (e) {
        showStatus('changelog-status', `åŒæ­¥å¤±è´¥ï¼š${e.message}`, 'error');
        console.error('ä» GitHub åŒæ­¥æ›´æ–°æ—¥å¿—å¤±è´¥:', e);
      }
    });

    // ä¿å­˜æ‰€æœ‰æ›´æ”¹
    document.getElementById('btn-put-changelog').addEventListener('click', async () => {
      if (changelogList.length === 0) {
        showStatus('changelog-status', 'æ²¡æœ‰æ›´æ–°æ—¥å¿—å¯ä¿å­˜', 'warn');
        return;
      }
      
      try {
        showStatus('changelog-status', 'æ­£åœ¨ä¿å­˜...', 'info');
        await callApi('PUT', '/update/changelog', { changelog: changelogList });
        showStatus('changelog-status', `âœ… ä¿å­˜æˆåŠŸï¼å…± ${changelogList.length} æ¡æ›´æ–°æ—¥å¿—`, 'success');
      } catch (e) {
        showStatus('changelog-status', `ä¿å­˜å¤±è´¥ï¼š${e.message}`, 'error');
      }
    });
    
    // ç»Ÿè®¡ä¿¡æ¯
    document.getElementById('btn-refresh-stats').addEventListener('click', async () => {
      try {
        const runtimeData = await callApi('GET', '/runtime/lines').catch(() => ({ lines: [] }));
        document.getElementById('stat-runtime-count').textContent = (runtimeData.lines || []).length;
      } catch (e) {
        console.error('åˆ·æ–°ç»Ÿè®¡å¤±è´¥:', e);
      }
    });

    // ä½¿ç”¨ç»Ÿè®¡ï¼šè®¿é—®æ¬¡æ•°ã€å…¨çƒåˆ†å¸ƒã€ä½¿ç”¨ç‰ˆæœ¬ã€è®¾å¤‡ç»Ÿè®¡ã€æœ€è¿‘è®°å½•
    document.getElementById('btn-refresh-usage').addEventListener('click', async () => {
      const cfg = getConfig();
      if (!cfg.apiBase) {
        showStatus('changelog-status', 'è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API åœ°å€', 'error');
        document.getElementById('stat-users').textContent = '-';
        document.getElementById('stat-unique-devices').textContent = '-';
        document.getElementById('stat-by-country').textContent = 'è¯·é…ç½® API åœ°å€';
        document.getElementById('stat-by-version').textContent = '-';
        document.getElementById('stat-by-os').textContent = '-';
        document.getElementById('stat-by-device').textContent = '-';
        document.getElementById('stat-recent-tbody').innerHTML = '<tr><td colspan="7" class="empty-state">è¯·å…ˆé…ç½® API åœ°å€</td></tr>';
        return;
      }
      try {
        showStatus('changelog-status', 'æ­£åœ¨åŠ è½½ä½¿ç”¨ç»Ÿè®¡...', 'info');
        const data = await callApi('GET', '/stats');
        document.getElementById('stat-users').textContent = (data.total || 0);
        document.getElementById('stat-unique-devices').textContent = (data.uniqueDevices || 0);
        // ç¾åŒ–å…¨çƒåˆ†å¸ƒæ˜¾ç¤º
        const byC = data.byCountry || {};
        const countryElement = document.getElementById('stat-by-country');
        if (Object.keys(byC).length) {
          const sortedCountries = Object.entries(byC).sort((a, b) => b[1] - a[1]);
          const totalCountry = sortedCountries.reduce((sum, [, v]) => sum + v, 0);
          countryElement.innerHTML = sortedCountries.map(([k, v]) => {
            const percent = ((v / totalCountry) * 100).toFixed(1);
            const flag = getCountryFlag(k);
            return `<span class="stat-tag stat-tag-country" title="${k}: ${v} æ¬¡è®¿é—® (${percent}%)">
              ${flag} <strong>${k}</strong> <span class="stat-value">${v}</span>
            </span>`;
          }).join('');
        } else {
          countryElement.textContent = '-';
        }
        
        // ç¾åŒ–ä½¿ç”¨ç‰ˆæœ¬æ˜¾ç¤º
        const byV = data.byVersion || {};
        const versionElement = document.getElementById('stat-by-version');
        if (Object.keys(byV).length) {
          const sortedVersions = Object.entries(byV).sort((a, b) => b[1] - a[1]);
          const totalVersion = sortedVersions.reduce((sum, [, v]) => sum + v, 0);
          versionElement.innerHTML = sortedVersions.map(([k, v]) => {
            const percent = ((v / totalVersion) * 100).toFixed(1);
            const isAdmin = k.toLowerCase() === 'admin';
            const tagClass = isAdmin ? 'stat-tag-admin' : 'stat-tag-version';
            const icon = isAdmin ? 'ğŸ‘¤' : 'ğŸ“¦';
            return `<span class="stat-tag ${tagClass}" title="ç‰ˆæœ¬ ${k}: ${v} æ¬¡è®¿é—® (${percent}%)">
              ${icon} <strong>${k}</strong> <span class="stat-value">${v}</span>
            </span>`;
          }).join('');
        } else {
          versionElement.textContent = '-';
        }
        
        // ç¾åŒ–æ“ä½œç³»ç»Ÿåˆ†å¸ƒæ˜¾ç¤º
        const byOS = data.byOS || {};
        const osElement = document.getElementById('stat-by-os');
        if (Object.keys(byOS).length) {
          const sortedOS = Object.entries(byOS).sort((a, b) => b[1] - a[1]);
          const totalOS = sortedOS.reduce((sum, [, v]) => sum + v, 0);
          osElement.innerHTML = sortedOS.map(([k, v]) => {
            const percent = ((v / totalOS) * 100).toFixed(1);
            const osIcon = getOSIconForStat(k);
            return `<span class="stat-tag stat-tag-os" title="${k}: ${v} æ¬¡è®¿é—® (${percent}%)">
              ${osIcon} <strong>${k}</strong> <span class="stat-value">${v}</span>
            </span>`;
          }).join('');
        } else {
          osElement.textContent = '-';
        }
        
        // ç¾åŒ–è®¾å¤‡ç»Ÿè®¡æ˜¾ç¤º
        const byD = data.byDevice || {};
        const deviceElement = document.getElementById('stat-by-device');
        const deviceEntries = Object.entries(byD)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10);
        if (deviceEntries.length) {
          const totalDevice = deviceEntries.reduce((sum, [, v]) => sum + v, 0);
          deviceElement.innerHTML = deviceEntries.map(([k, v], idx) => {
            const percent = ((v / totalDevice) * 100).toFixed(1);
            const shortId = k.length > 12 ? k.substring(0, 12) + '...' : k;
            const rankIcon = idx === 0 ? 'ğŸ¥‡' : idx === 1 ? 'ğŸ¥ˆ' : idx === 2 ? 'ğŸ¥‰' : 'ğŸ“±';
            const isUnknown = k === 'unknown';
            const tagClass = isUnknown ? 'stat-tag-device-unknown' : 'stat-tag-device';
            return `<span class="stat-tag ${tagClass}" title="è®¾å¤‡ ${k}: ${v} æ¬¡è®¿é—® (${percent}%)">
              ${rankIcon} <code>${shortId}</code> <span class="stat-value">${v}æ¬¡</span>
            </span>`;
          }).join('');
        } else {
          deviceElement.textContent = '-';
        }
        const allRecords = data.all || data.recent || [];
        const tbody = document.getElementById('stat-recent-tbody');
        if (allRecords.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="empty-state">æš‚æ— </td></tr>';
        } else {
          // æŒ‰æ—¥æœŸåˆ†ç»„
          const today = new Date();
          const todayStr = today.toISOString().split('T')[0];
          const groups = {};
          allRecords.forEach(r => {
            const date = r.ts ? new Date(r.ts).toISOString().split('T')[0] : 'unknown';
            if (!groups[date]) groups[date] = [];
            groups[date].push(r);
          });
          
          // æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
          const sortedDates = Object.keys(groups).sort((a, b) => {
            if (a === 'unknown') return 1;
            if (b === 'unknown') return -1;
            return b.localeCompare(a);
          });
          
          let html = '';
          sortedDates.forEach(date => {
            const records = groups[date];
            const isToday = date === todayStr;
            const dateLabel = date === 'unknown' ? 'æœªçŸ¥æ—¥æœŸ' : date;
            const dateDisplay = date === 'unknown' ? 'æœªçŸ¥æ—¥æœŸ' : 
              new Date(date + 'T00:00:00').toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
            
            // è¯¥æ—¥æœŸçš„è®°å½•è¡Œ - åˆå¹¶åŒä¸€è®¾å¤‡çŸ­æ—¶é—´å†…çš„é‡å¤è®¿é—®ï¼ˆå…ˆåˆå¹¶ï¼Œå†ä½¿ç”¨ï¼‰
            const mergedRecords = mergeRepeatedVisits(records, 5 * 60 * 1000); // 5åˆ†é’Ÿæ—¶é—´çª—å£
            
            // æ—¥æœŸåˆ†ç»„æ ‡é¢˜è¡Œ
            const totalVisits = records.length;
            const mergedCount = mergedRecords.length;
            html += `<tr class="date-group-header ${isToday ? '' : 'collapsed'}" data-date="${date}">
              <td colspan="7" style="padding: 8px 12px;">
                <span class="toggle-icon">â–¼</span>
                <strong>${dateDisplay}</strong> 
                <span style="color: #999; font-weight: normal;">
                  (${mergedCount} ç»„è®¾å¤‡ï¼Œå…± ${totalVisits} æ¬¡è®¿é—®${totalVisits > mergedCount ? 'ï¼Œå·²åˆå¹¶ ' + (totalVisits - mergedCount) + ' æ¡é‡å¤' : ''})
                </span>
              </td>
            </tr>`;
            
            mergedRecords.forEach(item => {
              const deviceId = item.deviceId || 'unknown';
              const deviceShort = deviceId.length > 12 ? deviceId.substring(0, 12) + '...' : deviceId;
              
              // æ„å»ºæ—¶é—´æ˜¾ç¤º
              let timeDisplay;
              if (item.count > 1) {
                const firstTime = new Date(item.firstTime).toLocaleTimeString('zh-CN');
                const duration = Math.floor((item.lastTime - item.firstTime) / 1000);
                const durationStr = duration < 60 ? `${duration}ç§’` : 
                  duration < 3600 ? `${Math.floor(duration / 60)}åˆ†é’Ÿ` : 
                  `${Math.floor(duration / 3600)}å°æ—¶`;
                timeDisplay = `${firstTime} <span style="color:#666; font-size:11px;">(${item.count}æ¬¡, æŒç»­${durationStr})</span>`;
              } else {
                timeDisplay = new Date(item.firstTime).toLocaleTimeString('zh-CN');
              }
              
              // é‡å¤è®¿é—®è¶…è¿‡3æ¬¡çš„è¡Œç”¨é»„è‰²èƒŒæ™¯é«˜äº®
              const highlightStyle = item.count > 3 ? 'background:#fff3cd;' : '';
              
              // è·å–æ“ä½œç³»ç»Ÿå›¾æ ‡
              const osIcon = getOSIcon(item.os);
              
              // åˆ é™¤æŒ‰é’®ï¼šå¦‚æœ count > 1ï¼ˆåˆå¹¶è®°å½•ï¼‰ï¼Œæ˜¾ç¤ºæ‰¹é‡åˆ é™¤ï¼›å¦åˆ™æ˜¾ç¤ºå•æ¡åˆ é™¤
              let deleteButton = '';
              if (item.recordIds && item.recordIds.length > 0) {
                if (item.count > 1) {
                  // åˆå¹¶è®°å½•ï¼šæ˜¾ç¤ºæ‰¹é‡åˆ é™¤æŒ‰é’®ï¼ˆåˆ é™¤è¯¥è®¾å¤‡çš„æ‰€æœ‰è®°å½•ï¼‰
                  deleteButton = `<button class="btn btn-sm btn-danger" onclick="deleteStatRecordsByDevice('${deviceId}')" title="åˆ é™¤è¯¥è®¾å¤‡çš„æ‰€æœ‰ ${item.count} æ¡è®°å½•">
                    <i class="fas fa-trash"></i> åˆ é™¤å…¨éƒ¨
                  </button>`;
                } else if (item.recordIds.length === 1) {
                  // å•æ¡è®°å½•ï¼šæ˜¾ç¤ºå•æ¡åˆ é™¤æŒ‰é’®
                  deleteButton = `<button class="btn btn-sm btn-danger" onclick="deleteStatRecord('${item.recordIds[0]}')" title="åˆ é™¤æ­¤è®°å½•">
                    <i class="fas fa-trash"></i>
                  </button>`;
                }
              }
              
              html += `<tr class="date-group-rows ${isToday ? '' : 'collapsed'}" data-date="${date}" style="${highlightStyle}">
                <td>${item.country || '-'}</td>
                <td>${item.city || '-'}</td>
                <td>${osIcon} ${item.os || 'Unknown'}</td>
                <td>${item.version || '-'}</td>
                <td title="${deviceId}">${deviceShort}</td>
                <td>${timeDisplay}</td>
                <td>${deleteButton || '-'}</td>
              </tr>`;
            });
          });
          
          tbody.innerHTML = html;
          
          // ç»‘å®šç‚¹å‡»äº‹ä»¶
          document.querySelectorAll('.date-group-header').forEach(header => {
            header.addEventListener('click', function() {
              const date = this.dataset.date;
              const isCollapsed = this.classList.contains('collapsed');
              this.classList.toggle('collapsed');
              document.querySelectorAll(`tr.date-group-rows[data-date="${date}"]`).forEach(row => {
                row.classList.toggle('collapsed');
              });
            });
          });
          
          // ä¿å­˜ allRecords åˆ°å…¨å±€å˜é‡ä¾›ä¸‹è½½ä½¿ç”¨
          window.allRecords = allRecords;
        }
        showStatus('changelog-status', 'ä½¿ç”¨ç»Ÿè®¡åŠ è½½æˆåŠŸ', 'success');
      } catch (e) {
        console.error('åŠ è½½ä½¿ç”¨ç»Ÿè®¡å¤±è´¥:', e);
        showStatus('changelog-status', `åŠ è½½ä½¿ç”¨ç»Ÿè®¡å¤±è´¥ï¼š${e.message}`, 'error');
        document.getElementById('stat-users').textContent = '-';
        document.getElementById('stat-unique-devices').textContent = '-';
        document.getElementById('stat-by-country').textContent = 'åŠ è½½å¤±è´¥';
        document.getElementById('stat-by-version').textContent = '-';
        document.getElementById('stat-by-os').textContent = '-';
        document.getElementById('stat-by-device').textContent = '-';
        document.getElementById('stat-recent-tbody').innerHTML = '<tr><td colspan="7" class="empty-state">åŠ è½½å¤±è´¥ï¼š' + e.message + '</td></tr>';
        window.allRecords = [];
      }
    });

    // è·å–æ“ä½œç³»ç»Ÿå¯¹åº”çš„å›¾æ ‡ï¼ˆç”¨äºç»Ÿè®¡æ˜¾ç¤ºï¼‰
    function getOSIconForStat(os) {
      if (!os) return 'ğŸ’»';
      const osLower = os.toLowerCase();
      
      if (osLower.includes('windows')) return 'ğŸªŸ';
      if (osLower.includes('mac') || osLower.includes('darwin')) return 'ğŸ';
      if (osLower.includes('linux')) return 'ğŸ§';
      if (osLower.includes('android')) return 'ğŸ¤–';
      if (osLower.includes('ios')) return 'ğŸ“±';
      
      return 'ğŸ’»';
    }
    
    // è·å–æ“ä½œç³»ç»Ÿå¯¹åº”çš„å›¾æ ‡ï¼ˆç”¨äºè¡¨æ ¼æ˜¾ç¤ºï¼‰
    function getOSIcon(os) {
      return getOSIconForStat(os);
    }
    
    // è·å–å›½å®¶/åœ°åŒºå¯¹åº”çš„å›½æ——å›¾æ ‡
    function getCountryFlag(countryCode) {
      const flags = {
        'HK': 'ğŸ‡­ğŸ‡°', 'CN': 'ğŸ‡¨ğŸ‡³', 'US': 'ğŸ‡ºğŸ‡¸', 'JP': 'ğŸ‡¯ğŸ‡µ', 'KR': 'ğŸ‡°ğŸ‡·',
        'GB': 'ğŸ‡¬ğŸ‡§', 'FR': 'ğŸ‡«ğŸ‡·', 'DE': 'ğŸ‡©ğŸ‡ª', 'CA': 'ğŸ‡¨ğŸ‡¦', 'AU': 'ğŸ‡¦ğŸ‡º',
        'SG': 'ğŸ‡¸ğŸ‡¬', 'TW': 'ğŸ‡¹ğŸ‡¼', 'MY': 'ğŸ‡²ğŸ‡¾', 'TH': 'ğŸ‡¹ğŸ‡­', 'VN': 'ğŸ‡»ğŸ‡³',
        'IN': 'ğŸ‡®ğŸ‡³', 'ID': 'ğŸ‡®ğŸ‡©', 'PH': 'ğŸ‡µğŸ‡­', 'BR': 'ğŸ‡§ğŸ‡·', 'MX': 'ğŸ‡²ğŸ‡½',
        'RU': 'ğŸ‡·ğŸ‡º', 'IT': 'ğŸ‡®ğŸ‡¹', 'ES': 'ğŸ‡ªğŸ‡¸', 'NL': 'ğŸ‡³ğŸ‡±', 'SE': 'ğŸ‡¸ğŸ‡ª',
        'NO': 'ğŸ‡³ğŸ‡´', 'DK': 'ğŸ‡©ğŸ‡°', 'FI': 'ğŸ‡«ğŸ‡®', 'PL': 'ğŸ‡µğŸ‡±', 'TR': 'ğŸ‡¹ğŸ‡·'
      };
      return flags[countryCode] || 'ğŸŒ';
    }
    
    // åˆå¹¶åŒä¸€è®¾å¤‡çŸ­æ—¶é—´å†…çš„é‡å¤è®¿é—®è®°å½•ï¼ˆä¿ç•™åŸå§‹è®°å½• ID åˆ—è¡¨ï¼‰
    function mergeRepeatedVisits(records, timeWindow) {
      if (!records || records.length === 0) return [];
      
      // æŒ‰æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
      const sorted = [...records].sort((a, b) => (b.ts || 0) - (a.ts || 0));
      
      const merged = [];
      let currentGroup = null;
      
      for (const record of sorted) {
        const deviceKey = `${record.deviceId}_${record.version}_${record.country}_${record.city}_${record.os || 'unknown'}`;
        
        // å¦‚æœæ˜¯æ–°è®¾å¤‡æˆ–æ—¶é—´é—´éš”è¶…è¿‡é˜ˆå€¼ï¼Œå¼€å§‹æ–°åˆ†ç»„
        if (!currentGroup || 
            currentGroup.key !== deviceKey || 
            (currentGroup.firstTime - (record.ts || 0) > timeWindow)) {
          // ä¿å­˜å½“å‰åˆ†ç»„
          if (currentGroup) {
            merged.push({
              deviceId: currentGroup.deviceId,
              version: currentGroup.version,
              country: currentGroup.country,
              city: currentGroup.city,
              os: currentGroup.os,
              firstTime: currentGroup.firstTime,
              lastTime: currentGroup.lastTime,
              count: currentGroup.count,
              recordIds: currentGroup.recordIds // ä¿ç•™åŸå§‹è®°å½• ID åˆ—è¡¨
            });
          }
          
          // å¼€å§‹æ–°åˆ†ç»„
          currentGroup = {
            key: deviceKey,
            deviceId: record.deviceId,
            version: record.version,
            country: record.country,
            city: record.city,
            os: record.os,
            firstTime: record.ts || 0,
            lastTime: record.ts || 0,
            count: 1,
            recordIds: [record.id || `${record.ts}_${record.deviceId.substring(0, 8)}`] // ä¿å­˜åŸå§‹è®°å½• IDï¼ˆå¦‚æœæ²¡æœ‰ idï¼Œä½¿ç”¨æ—¶é—´æˆ³+è®¾å¤‡IDå‰ç¼€ï¼‰
          };
        } else {
          // åˆå¹¶åˆ°å½“å‰åˆ†ç»„
          currentGroup.count++;
          currentGroup.lastTime = record.ts || 0; // æ›´æ–°æœ€åæ—¶é—´ï¼ˆç”±äºå·²æ’åºï¼Œè¿™æ˜¯æœ€æ—©çš„ï¼‰
          const recordId = record.id || `${record.ts}_${record.deviceId.substring(0, 8)}`;
          if (!currentGroup.recordIds.includes(recordId)) {
            currentGroup.recordIds.push(recordId);
          }
        }
      }
      
      // ä¿å­˜æœ€åä¸€ä¸ªåˆ†ç»„
      if (currentGroup) {
        merged.push({
          deviceId: currentGroup.deviceId,
          version: currentGroup.version,
          country: currentGroup.country,
          city: currentGroup.city,
          os: currentGroup.os,
          firstTime: currentGroup.firstTime,
          lastTime: currentGroup.lastTime,
          count: currentGroup.count,
          recordIds: currentGroup.recordIds // ä¿ç•™åŸå§‹è®°å½• ID åˆ—è¡¨
        });
      }
      
      return merged;
    }
    
    // åˆ é™¤ç»Ÿè®¡è®°å½•
    window.deleteStatRecord = async function(recordId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç»Ÿè®¡è®°å½•å—ï¼Ÿ')) return;
      
      const cfg = getConfig();
      if (!cfg.apiBase) {
        alert('è¯·å…ˆé…ç½® API åœ°å€');
        return;
      }
      
      try {
        await callApi('DELETE', `/stats/record/${encodeURIComponent(recordId)}`);
        showStatus('changelog-status', 'åˆ é™¤æˆåŠŸï¼Œæ­£åœ¨åˆ·æ–°...', 'success');
        // åˆ·æ–°ç»Ÿè®¡
        setTimeout(() => {
          document.getElementById('btn-refresh-usage').click();
        }, 500);
      } catch (e) {
        showStatus('changelog-status', `åˆ é™¤å¤±è´¥ï¼š${e.message}`, 'error');
      }
    };
    
    // æ‰¹é‡åˆ é™¤ç»Ÿè®¡è®°å½•ï¼ˆæŒ‰è®¾å¤‡IDï¼‰
    window.deleteStatRecordsByDevice = async function(deviceId) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤è®¾å¤‡ "${deviceId}" çš„æ‰€æœ‰ç»Ÿè®¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;
      
      const cfg = getConfig();
      if (!cfg.apiBase) {
        alert('è¯·å…ˆé…ç½® API åœ°å€');
        return;
      }
      
      try {
        const result = await callApi('DELETE', '/stats/records', { deviceId });
        showStatus('changelog-status', `å·²åˆ é™¤ ${result.deleted || 0} æ¡è®°å½•ï¼Œæ­£åœ¨åˆ·æ–°...`, 'success');
        setTimeout(() => {
          document.getElementById('btn-refresh-usage').click();
        }, 500);
      } catch (e) {
        showStatus('changelog-status', `åˆ é™¤å¤±è´¥ï¼š${e.message}`, 'error');
      }
    };

    // ä¸‹è½½è®¿é—®è®°å½•
    document.getElementById('btn-download-records').addEventListener('click', async () => {
      const cfg = getConfig();
      if (!cfg.apiBase) {
        alert('è¯·å…ˆè®¾ç½® API åœ°å€');
        return;
      }
      
      try {
        // è·å–æ‰€æœ‰è®°å½•
        const data = await callApi('GET', '/stats');
        const allRecords = data.all || data.recent || [];
        
        if (allRecords.length === 0) {
          alert('æš‚æ— è®¿é—®è®°å½•');
          return;
        }
        
        // å‡†å¤‡æ‰€æœ‰æ•°æ®ï¼ˆåŒ…å«ç»Ÿè®¡ä¿¡æ¯å’Œè®°å½•ï¼‰
        const statsData = {
          summary: {
            total: data.total || 0,
            uniqueDevices: data.uniqueDevices || 0,
            byCountry: data.byCountry || {},
            byVersion: data.byVersion || {},
            byOS: data.byOS || {},
            byDevice: data.byDevice || {}
          },
          records: allRecords
        };
        
        // è½¬æ¢ä¸º CSV æ ¼å¼ï¼ˆåŒ…å«ç»Ÿè®¡ä¿¡æ¯å’Œè®°å½•ï¼‰
        const csvLines = [];
        csvLines.push('=== ç»Ÿè®¡æ‘˜è¦ ===');
        csvLines.push(`æ€»è®¿é—®æ¬¡æ•°,${statsData.summary.total}`);
        csvLines.push(`ç‹¬ç«‹è®¾å¤‡æ•°,${statsData.summary.uniqueDevices}`);
        csvLines.push('');
        csvLines.push('=== æŒ‰å›½å®¶/åœ°åŒºç»Ÿè®¡ ===');
        csvLines.push('å›½å®¶/åœ°åŒº,è®¿é—®æ¬¡æ•°');
        Object.entries(statsData.summary.byCountry).forEach(([country, count]) => {
          csvLines.push(`"${country}",${count}`);
        });
        csvLines.push('');
        csvLines.push('=== æŒ‰ç‰ˆæœ¬ç»Ÿè®¡ ===');
        csvLines.push('ç‰ˆæœ¬,è®¿é—®æ¬¡æ•°');
        Object.entries(statsData.summary.byVersion).forEach(([version, count]) => {
          csvLines.push(`"${version}",${count}`);
        });
        csvLines.push('');
        csvLines.push('=== æŒ‰è®¾å¤‡ç»Ÿè®¡ ===');
        csvLines.push('è®¾å¤‡ID,è®¿é—®æ¬¡æ•°');
        Object.entries(statsData.summary.byDevice).forEach(([deviceId, count]) => {
          csvLines.push(`"${deviceId}",${count}`);
        });
        csvLines.push('');
        csvLines.push('=== è¯¦ç»†è®¿é—®è®°å½• ===');
        csvLines.push('æ—¶é—´,å›½å®¶/åœ°åŒº,åŸå¸‚,ç‰ˆæœ¬,è®¾å¤‡ID,IPåœ°å€');
        allRecords.forEach(r => {
          const t = r.ts ? new Date(r.ts).toISOString() : '';
          const row = [
            t,
            r.country || '',
            r.city || '',
            r.version || '',
            r.deviceId || 'unknown',
            r.ip || ''
          ].map(v => `"${String(v).replace(/"/g, '""')}"`).join(',');
          csvLines.push(row);
        });
        
        const csv = csvLines.join('\n');
        const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `metro-pids-all-data-${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        alert(`å·²ä¸‹è½½æ‰€æœ‰æ•°æ®ï¼ˆ${allRecords.length} æ¡è®¿é—®è®°å½• + ç»Ÿè®¡æ‘˜è¦ï¼‰`);
      } catch (e) {
        alert('ä¸‹è½½å¤±è´¥ï¼š' + e.message);
      }
    });
    
    // åˆå§‹åŒ–ï¼šå¯åŠ¨æ—¶è‡ªåŠ¨ä»æœåŠ¡å™¨åŠ è½½æ‰€æœ‰æ•°æ®
    window.addEventListener('DOMContentLoaded', () => {
      const savedConfig = loadConfig();
      document.getElementById('api-base').value = savedConfig.apiBase || '';
      document.getElementById('api-token').value = savedConfig.token || '';
      document.getElementById('api-base-display').textContent = savedConfig.apiBase || 'æœªè®¾ç½®';
      
      if (savedConfig.apiBase) {
        // å»¶è¿ŸåŠ è½½ï¼Œç¡®ä¿æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨å·²æ³¨å†Œ
        setTimeout(() => {
          console.log('[Admin] ğŸš€ å¼€å§‹è‡ªåŠ¨åŠ è½½æœåŠ¡å™¨æ•°æ®...');
          
          // 1. åŠ è½½è¿æ§çº¿è·¯åˆ—è¡¨
          try {
            document.getElementById('btn-list-runtime').click();
            console.log('[Admin] âœ… å·²è§¦å‘è¿æ§çº¿è·¯åˆ—è¡¨åŠ è½½');
          } catch (e) {
            console.warn('[Admin] âš ï¸ è¿æ§çº¿è·¯åˆ—è¡¨åŠ è½½å¤±è´¥:', e);
          }
          
          // 2. åŠ è½½æ›´æ–°æ—¥å¿—
          try {
            document.getElementById('btn-get-changelog').click();
            console.log('[Admin] âœ… å·²è§¦å‘æ›´æ–°æ—¥å¿—åŠ è½½');
          } catch (e) {
            console.warn('[Admin] âš ï¸ æ›´æ–°æ—¥å¿—åŠ è½½å¤±è´¥:', e);
          }
          
          // 3. åŠ è½½ç‰ˆæœ¬ä¿¡æ¯
          try {
            document.getElementById('btn-get-update-info').click();
            console.log('[Admin] âœ… å·²è§¦å‘ç‰ˆæœ¬ä¿¡æ¯åŠ è½½');
          } catch (e) {
            console.warn('[Admin] âš ï¸ ç‰ˆæœ¬ä¿¡æ¯åŠ è½½å¤±è´¥:', e);
          }
          
          // 4. åŠ è½½ç»Ÿè®¡ä¿¡æ¯
          try {
            document.getElementById('btn-refresh-stats').click();
            console.log('[Admin] âœ… å·²è§¦å‘ç»Ÿè®¡ä¿¡æ¯åŠ è½½');
          } catch (e) {
            console.warn('[Admin] âš ï¸ ç»Ÿè®¡ä¿¡æ¯åŠ è½½å¤±è´¥:', e);
          }
          
          // 5. åŠ è½½ä½¿ç”¨ç»Ÿè®¡
          try {
            document.getElementById('btn-refresh-usage').click();
            console.log('[Admin] âœ… å·²è§¦å‘ä½¿ç”¨ç»Ÿè®¡åŠ è½½');
          } catch (e) {
            console.warn('[Admin] âš ï¸ ä½¿ç”¨ç»Ÿè®¡åŠ è½½å¤±è´¥:', e);
          }
          
          // 6. åŠ è½½å½©è›‹é…ç½®
          try {
            document.getElementById('btn-get-easter-eggs').click();
            console.log('[Admin] âœ… å·²è§¦å‘å½©è›‹é…ç½®åŠ è½½');
          } catch (e) {
            console.warn('[Admin] âš ï¸ å½©è›‹é…ç½®åŠ è½½å¤±è´¥:', e);
          }
          
          // 7. åŠ è½½èŠ‚æ—¥é…ç½®
          try {
            document.getElementById('btn-get-holidays').click();
            console.log('[Admin] âœ… å·²è§¦å‘èŠ‚æ—¥é…ç½®åŠ è½½');
          } catch (e) {
            console.warn('[Admin] âš ï¸ èŠ‚æ—¥é…ç½®åŠ è½½å¤±è´¥:', e);
          }
          
          console.log('[Admin] âœ… æ‰€æœ‰æ•°æ®åŠ è½½ä»»åŠ¡å·²å¯åŠ¨');
        }, 800); // å»¶è¿Ÿ 800msï¼Œç¡®ä¿æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨å·²æ³¨å†Œ
      } else {
        console.log('[Admin] âš ï¸ API åœ°å€æœªé…ç½®ï¼Œè·³è¿‡è‡ªåŠ¨åŠ è½½');
      }
    });
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</body>
</html>
