<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Metro-PIDS äº‘æ§ç®¡ç†åå°</title>
<<<<<<< Updated upstream
=======
<<<<<<< HEAD
  <meta name="application-name" content="Metro-PIDS äº‘æ§ç®¡ç†åå°" />
=======
>>>>>>> 5e6badfcb798ff4bb795199c1cd04aeb2a4d3fcc
>>>>>>> Stashed changes
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Crect width='16' height='16' rx='3' fill='%23667eea'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='10' fill='%23fff' font-weight='bold'%3EMP%3C/text%3E%3C/svg%3E" type="image/svg+xml" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  
  <style>
    /* =========================================
       1. ä¸»é¢˜ç³»ç»Ÿ (CSS Variables)
       ========================================= */
    :root {
      /* æµ…è‰²æ¨¡å¼ */
      --bg-body: #f3f4f6;
      --bg-card: #ffffff;
      --bg-sidebar: #ffffff;
      --bg-header: rgba(255, 255, 255, 0.85);
      --bg-input: #ffffff;
      --bg-hover: #f9fafb;
      --bg-active: #eef2ff;
      
      --text-main: #1f2937;
      --text-secondary: #6b7280;
      --text-muted: #9ca3af;
      
      --border-color: #e5e7eb;
      
      --primary: #667eea;
      --primary-hover: #5a67d8;
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      
      --danger: #ef4444;
      --success: #10b981;
      --warning: #f59e0b;
      --info: #3b82f6;

      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      
      --radius: 12px;
      --header-height: 64px;
      --sidebar-width: 260px;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        /* æ·±è‰²æ¨¡å¼ */
        --bg-body: #111827;
        --bg-card: #1f2937;
        --bg-sidebar: #1f2937;
        --bg-header: rgba(31, 41, 55, 0.85);
        --bg-input: #374151;
        --bg-hover: #374151;
        --bg-active: #2d3748;
        
        --text-main: #f9fafb;
        --text-secondary: #d1d5db;
        --text-muted: #9ca3af;
        
        --border-color: #374151;
        
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
      }
    }

    /* =========================================
       2. åŸºç¡€é‡ç½®
       ========================================= */
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-body);
      color: var(--text-main);
      min-height: 100vh;
      line-height: 1.5;
      font-size: 14px;
      transition: background-color 0.3s, color 0.3s;
    }

    a { color: var(--primary); text-decoration: none; }
    ul { list-style: none; }

    /* æ»šåŠ¨æ¡ */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--text-muted); border-radius: 4px; opacity: 0.3; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); opacity: 0.8; }

    /* =========================================
       3. å¸ƒå±€ (Header & Sidebar)
       ========================================= */
    .app-layout { display: flex; flex-direction: column; min-height: 100vh; }

    .header {
      position: sticky; top: 0; z-index: 50;
      height: var(--header-height);
      background: var(--bg-header);
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border-color);
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 20px;
    }

    .header-brand { display: flex; align-items: center; gap: 12px; }
    .header-brand h1 {
      font-size: 18px; font-weight: 700;
      background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      margin: 0; white-space: nowrap;
    }

    .header-actions { display: flex; align-items: center; gap: 12px; }
    .api-info { font-size: 12px; color: var(--text-secondary); display: flex; align-items: center; gap: 8px; }
    .api-info code {
      background: var(--bg-hover); padding: 2px 6px; border-radius: 4px;
      font-family: monospace; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
      border: 1px solid var(--border-color);
    }

    .menu-toggle { display: none; background: none; border: none; font-size: 20px; color: var(--text-main); cursor: pointer; padding: 8px; }

    .main-wrapper {
      display: flex; flex: 1; max-width: 1600px; margin: 0 auto; width: 100%;
      padding: 20px; gap: 20px;
    }

    /* ä¾§è¾¹æ  */
    .sidebar {
      width: var(--sidebar-width); flex-shrink: 0;
      background: var(--bg-sidebar); border-radius: var(--radius);
      box-shadow: var(--shadow-sm); padding: 16px;
      height: fit-content; max-height: calc(100vh - 100px); overflow-y: auto;
      position: sticky; top: 84px; border: 1px solid var(--border-color);
    }

    .sidebar h2 { font-size: 12px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 12px; padding-left: 10px; }
    .sidebar-nav { display: flex; flex-direction: column; gap: 4px; }
    .sidebar-item {
      display: flex; align-items: center; gap: 12px; padding: 12px 16px;
      border-radius: 8px; color: var(--text-secondary); font-weight: 500;
      cursor: pointer; transition: all 0.2s; border: none; background: transparent;
      width: 100%; text-align: left; font-size: 14px;
    }
    .sidebar-item:hover { background: var(--bg-hover); color: var(--primary); }
    .sidebar-item.active { background: var(--primary); color: #fff; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }

    /* å†…å®¹åŒº */
    .content-area { flex: 1; min-width: 0; }
    .section-content { display: none; animation: fadeIn 0.3s ease; }
    .section-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* =========================================
       4. ç»„ä»¶ (Card, Form, Buttons)
       ========================================= */
    .card {
      background: var(--bg-card); border-radius: var(--radius);
      padding: 24px; margin-bottom: 20px;
      border: 1px solid var(--border-color); box-shadow: var(--shadow-sm);
    }
    .card h2 { font-size: 18px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; color: var(--text-main); }
    .card h2 i { color: var(--primary); }

    .field { margin-bottom: 20px; }
    .field label { display: block; font-size: 13px; font-weight: 600; color: var(--text-main); margin-bottom: 8px; }
    
    input[type="text"], input[type="password"], input[type="date"], input[type="datetime-local"], 
    textarea, select, input[type="file"] {
      width: 100%; padding: 10px 14px;
      border: 1px solid var(--border-color); border-radius: 8px;
      background: var(--bg-input); color: var(--text-main);
      font-size: 14px; transition: all 0.2s; font-family: inherit;
    }
    input:focus, textarea:focus, select:focus {
      outline: none; border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
    }

    .field-row-inline { display: flex; gap: 10px; align-items: center; }
    .inline-input { display: flex; gap: 8px; align-items: center; width: 100%; }
    .inline-input input { flex: 1; }

    .btn-group { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 16px; }
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 6px;
      padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 500;
      border: none; cursor: pointer; transition: all 0.2s; white-space: nowrap; user-select: none;
    }
    .btn:active { transform: translateY(1px); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-primary { background: var(--primary); color: #fff; box-shadow: 0 2px 6px rgba(102, 126, 234, 0.25); }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-secondary { background: var(--bg-hover); color: var(--text-main); border: 1px solid var(--border-color); }
    .btn-secondary:hover { background: var(--border-color); }
    .btn-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.2); }
    .btn-danger:hover { background: var(--danger); color: #fff; }
    .btn-success { background: var(--success); color: #fff; }
    .btn-info { background: var(--info); color: #fff; }
    .btn-sm { padding: 6px 12px; font-size: 12px; height: 32px; }

    .table-container { width: 100%; overflow-x: auto; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 16px; }
    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th {
      background: var(--bg-hover); padding: 12px 16px; text-align: left;
      font-weight: 600; color: var(--text-secondary); font-size: 13px;
      border-bottom: 1px solid var(--border-color); white-space: nowrap;
    }
    td {
      padding: 12px 16px; border-bottom: 1px solid var(--border-color);
      color: var(--text-main); vertical-align: middle;
    }
    tr:last-child td { border-bottom: none; }
    tr:hover { background-color: var(--bg-hover); }

    /* ç»Ÿè®¡é¡µ - æœ€è¿‘è®¿é—®è®°å½•è¡¨å¤´å›ºå®š & æŠ˜å æ ·å¼ */
    #stat-recent-container thead th {
      position: sticky;
      top: 0;
      background: var(--bg-card);
      z-index: 1;
    }
    #stat-recent-container tr.date-group-rows.collapsed {
      display: none;
    }
    #stat-recent-container tr.date-group-header {
      cursor: pointer;
      background: var(--bg-hover);
    }
    #stat-recent-container .toggle-icon {
      display: inline-block;
      margin-right: 6px;
      transition: transform 0.2s ease;
    }
    #stat-recent-container tr.date-group-header.collapsed .toggle-icon {
      transform: rotate(-90deg);
    }

    /* å¼€å…³ Toggle */
    .field-toggle-row { display: flex; align-items: center; justify-content: space-between; gap: 16px; padding: 8px 0; }
    .se-toggle-wrap { position: relative; width: 44px; height: 24px; cursor: pointer; flex-shrink: 0; display: inline-block; vertical-align: middle; }
    .se-toggle-input { opacity: 0; width: 0; height: 0; }
    .se-toggle-track {
      position: absolute; inset: 0; background-color: var(--border-color);
      border-radius: 24px; transition: 0.3s;
    }
    .se-toggle-thumb {
      position: absolute; height: 18px; width: 18px; left: 3px; bottom: 3px;
      background: #fff; border-radius: 50%; transition: 0.3s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .se-toggle-input:checked ~ .se-toggle-track { background-color: var(--success); }
    .se-toggle-input:checked ~ .se-toggle-thumb { transform: translateX(20px); }

    .badge { padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 500; display: inline-block; }
    .badge-success { background: rgba(16, 185, 129, 0.15); color: var(--success); }
    .badge-secondary { background: var(--bg-hover); color: var(--text-secondary); border: 1px solid var(--border-color); }
    .badge-info { background: rgba(59, 130, 246, 0.15); color: var(--info); }

    /* æ¨¡æ€æ¡† */
    .modal {
      display: none; position: fixed; inset: 0;
      background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
      z-index: 1000; padding: 20px; align-items: center; justify-content: center;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: var(--bg-card); width: 100%; max-width: 500px;
      border-radius: 16px; box-shadow: var(--shadow-md);
      display: flex; flex-direction: column; max-height: 90vh;
      border: 1px solid var(--border-color); animation: modalFadeIn 0.2s ease-out;
    }
    @keyframes modalFadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    .modal-header { padding: 16px 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
    .modal-body { padding: 24px; overflow-y: auto; flex: 1; }
    .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px; }
    .close-btn { font-size: 24px; color: var(--text-muted); background: none; border: none; cursor: pointer; }

    /* æ‚é¡¹ */
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; }
    .status { font-size: 13px; margin-top: 12px; display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 6px; width: 100%; }
    .status.success { color: var(--success); background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); }
    .status.error { color: var(--danger); background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); }
    
    .stat-card { color: white; padding: 24px; border-radius: var(--radius); position: relative; overflow: hidden; }
    .stat-card-primary { background: var(--primary-gradient); }
    .stat-card-secondary { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .stat-value { font-size: 32px; font-weight: 700; position: relative; z-index: 2; }
    
    .tag-list { display: flex; flex-wrap: wrap; gap: 8px; }
    .tag-chip { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 20px; background: var(--bg-hover); border: 1px solid var(--border-color); font-size: 12px; }
    .tag-chip-del { margin-left: 6px; cursor: pointer; color: var(--text-muted); border: none; background: none; }
    
    /* å…¨å±€åŠ è½½æ‚¬æµ®é€šçŸ¥ */
    .loading-toast {
      position: fixed;
      right: 20px;
      bottom: 20px;
      z-index: 2000;
      background: var(--bg-card);
      border-radius: 10px;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-color);
      min-width: 220px;
      max-width: 320px;
      padding: 12px 14px 10px;
      display: none;
    }
    .loading-toast-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    .loading-toast-title {
      font-weight: 600;
      color: var(--text-main);
    }
    .loading-toast-progress {
      position: relative;
      width: 100%;
      height: 4px;
      border-radius: 999px;
      background: var(--bg-hover);
      overflow: hidden;
    }
    .loading-toast-bar {
      position: absolute;
      inset: 0;
      width: 40%;
      background: var(--primary-gradient);
      animation: loadingBar 1.1s infinite ease-in-out;
    }
    @keyframes loadingBar {
      0% { transform: translateX(-100%); }
      50% { transform: translateX(30%); }
      100% { transform: translateX(120%); }
    }
    
    /* å·¥å…·æ ·å¼: ç«™ç‚¹é€‰æ‹©å™¨ */
    .station-select-box { margin-top: 8px; padding: 10px; background: var(--bg-hover); border: 1px solid var(--border-color); border-radius: 8px; display: none; }
    .station-select-box.active { display: block; }
    .station-checkbox-group { display: flex; flex-wrap: wrap; gap: 8px; max-height: 150px; overflow-y: auto; margin-top: 8px; }
    .station-checkbox-label { display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 4px; font-size: 12px; cursor: pointer; }
    .station-checkbox-label:hover { border-color: var(--primary); }
    .station-checkbox-label input:checked + span { color: var(--primary); font-weight: bold; }

    /* å›¾è¡¨å®¹å™¨ */
    .pie-chart-container { display: flex; flex-direction: column; align-items: flex-start; gap: 20px; margin-top: 12px; }
    .pie-chart-wrapper { position: relative; flex-shrink: 0; }
    .pie-chart-legend { flex: 1; display: flex; flex-direction: column; gap: 8px; }
    .pie-legend-item { display: flex; align-items: center; gap: 8px; font-size: 13px; }
    .pie-legend-color { width: 12px; height: 12px; border-radius: 2px; }
    .pie-legend-value { margin-left: auto; font-weight: 600; }

    @media (min-width: 600px) {
      .pie-chart-container { flex-direction: row; align-items: center; }
    }

    /* ç§»åŠ¨ç«¯é€‚é… */
    @media (max-width: 768px) {
      :root { --header-height: 56px; }
      .header { padding: 0 16px; }
      .menu-toggle { display: block; }
      .api-info, .hide-mobile { display: none; }
      .main-wrapper { flex-direction: column; padding: 12px; gap: 12px; display: block; }
      
      .sidebar {
        position: fixed; top: 0; left: 0; bottom: 0; width: 260px; max-height: none;
        border-radius: 0; border-right: 1px solid var(--border-color); z-index: 100;
        transform: translateX(-100%); opacity: 0; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s;
        box-shadow: 10px 0 20px rgba(0,0,0,0.1); padding-top: var(--header-height); background: var(--bg-card);
      }
      .sidebar.active { transform: translateX(0); opacity: 1; }
      .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99; backdrop-filter: blur(2px); }
      .sidebar-overlay.active { display: block; }

      .card { padding: 16px; margin-bottom: 16px; }
      .btn { padding: 8px 16px; font-size: 13px; width: 100%; }
      .btn-group { flex-direction: column; gap: 8px; }
      .grid { grid-template-columns: 1fr; }
      .field-row-inline { flex-direction: column; align-items: stretch; }
      .inline-input button { width: auto; flex-shrink: 0; }
    }
  </style>
</head>
<body>

  <div class="app-layout">
    <header class="header">
      <div class="header-brand">
        <button class="menu-toggle" id="menu-toggle"><i class="fas fa-bars"></i></button>
        <h1><i class="fas fa-subway" style="margin-right:8px; color:var(--primary);"></i>Metro-PIDS äº‘æ§</h1>
      </div>
      <div class="header-actions">
        <div class="api-info">
          <span>API:</span>
          <code id="api-base-display">æœªè®¾ç½®</code>
        </div>
        <button class="btn btn-secondary btn-sm" id="btn-settings"><i class="fas fa-cog"></i> <span class="hide-mobile">è®¾ç½®</span></button>
      </div>
    </header>

    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <div class="main-wrapper">
      <aside class="sidebar" id="sidebar">
        <h2>é…ç½®å¯¼èˆª</h2>
        <nav class="sidebar-nav">
          <button class="sidebar-item active" data-section="runtime"><i class="fas fa-train"></i> <span>äº‘æ§çº¿è·¯</span></button>
          <button class="sidebar-item" data-section="easter-eggs"><i class="fas fa-egg"></i> <span>å½©è›‹é…ç½®</span></button>
          <button class="sidebar-item" data-section="startup"><i class="fas fa-bullhorn"></i> <span>å¯åŠ¨å…¬å‘Š</span></button>
          <button class="sidebar-item" data-section="display-flags"><i class="fas fa-desktop"></i> <span>æ˜¾ç¤ºç«¯åŠŸèƒ½</span></button>
          <button class="sidebar-item" data-section="holidays"><i class="fas fa-calendar-alt"></i> <span>èŠ‚æ—¥é…ç½®</span></button>
          <button class="sidebar-item" data-section="updates"><i class="fas fa-sync-alt"></i> <span>ç‰ˆæœ¬æ›´æ–°</span></button>
          <button class="sidebar-item" data-section="stats"><i class="fas fa-chart-bar"></i> <span>ç»Ÿè®¡ä¿¡æ¯</span></button>
        </nav>
      </aside>

      <main class="content-area">
        
        <div class="section-content active" id="section-runtime">
          <div class="card">
            <h2><i class="fas fa-sync-alt"></i> äº‘æ§çº¿è·¯åˆ—è¡¨</h2>
            <div class="btn-group">
              <button class="btn btn-primary" id="btn-list-runtime"><i class="fas fa-sync"></i> åˆ·æ–°åˆ—è¡¨</button>
            </div>
            <div class="table-container">
              <table id="runtime-table">
                <thead><tr><th>çº¿è·¯åç§°</th><th>ç«™ç‚¹æ•°é‡</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="runtime-tbody"><tr><td colspan="3" class="empty-state">ç‚¹å‡»"åˆ·æ–°åˆ—è¡¨"åŠ è½½æ•°æ®</td></tr></tbody>
              </table>
            </div>
          </div>
          <div class="card">
            <h2><i class="fas fa-edit"></i> äº‘æ§çº¿è·¯ç¼–è¾‘</h2>
            <div style="background:var(--bg-active); padding:12px; border-radius:8px; margin-bottom:16px; font-size:13px; border:1px solid var(--border-color); color:var(--text-secondary);">
              <strong>ğŸ’¡ ä½¿ç”¨è¯´æ˜ï¼š</strong> é€‰æ‹© JSON æ–‡ä»¶ä¸Šä¼ ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¯»å–çº¿è·¯æ•°æ®ã€‚æ”¯æŒä¸€æ¬¡é€‰æ‹©å¤šä¸ªæ–‡ä»¶æ‰¹é‡ä¸Šä¼ ã€‚
            </div>
            <div class="field">
              <label>é€‰æ‹© JSON æ–‡ä»¶</label>
              <input type="file" id="runtime-line-file-input" accept=".json" multiple />
              <div id="runtime-files-list" style="margin-top:8px; display:none;"><ul id="runtime-files-items" style="font-size:12px; color:var(--text-secondary); padding-left:20px;"></ul></div>
            </div>
            <div class="btn-group">
              <button class="btn btn-info" id="btn-parse-runtime-files">è§£æå¹¶ä¸Šä¼ </button>
              <button class="btn btn-secondary" id="btn-get-runtime">ä¸‹è½½çº¿è·¯</button>
              <button class="btn btn-danger" id="btn-del-runtime">åˆ é™¤çº¿è·¯</button>
            </div>
            <div class="field" style="margin-top:16px;">
              <label>çº¿è·¯åç§°</label><input type="text" id="runtime-line-name" placeholder="ä¾‹å¦‚ï¼šæµå—åœ°é“1å·çº¿" />
            </div>
            <textarea id="runtime-line-json" style="display:none;"></textarea>
            <div class="field" id="runtime-station-editor" style="margin-top:20px; display:none;">
              <label>ç«™ç‚¹åˆ—è¡¨</label>
              <div id="runtime-station-list" class="station-list" style="max-height:300px; overflow-y:auto; border:1px solid var(--border-color); border-radius:8px; margin-bottom:10px; background:var(--bg-hover);"></div>
              <div class="btn-group">
                <button class="btn btn-secondary" id="btn-runtime-add-station"><i class="fas fa-plus"></i> æ–°å¢ç«™ç‚¹</button>
                <button class="btn btn-primary" id="btn-runtime-sync-json"><i class="fas fa-save"></i> ä¿å­˜åˆ° JSON</button>
              </div>
            </div>
            <div id="runtime-status"></div>
          </div>
        </div>

        <div class="section-content" id="section-easter-eggs">
          <div class="card">
            <h2><i class="fas fa-egg"></i> å½©è›‹åˆ—è¡¨</h2>
            <div class="btn-group">
              <button class="btn btn-primary" id="btn-list-easter-eggs"><i class="fas fa-sync"></i> åˆ·æ–°</button>
              <button class="btn btn-info" id="btn-add-easter-egg"><i class="fas fa-plus"></i> æ·»åŠ </button>
            </div>
            <div class="table-container">
              <table id="easter-eggs-table">
                <thead>
                  <tr>
                    <th style="width:60px;">åºå·</th>
                    <th>ID</th>
                    <th>åç§°</th>
                    <th style="width:80px;">ç«™ç‚¹æ•°</th>
                    <th style="width:80px;">æ¶ˆæ¯æ•°</th>
                    <th style="width:140px;">æ“ä½œ</th>
                    <th style="width:90px; text-align:right;">å¯ç”¨</th>
                  </tr>
                </thead>
                <tbody id="easter-eggs-list-tbody">
                  <tr><td colspan="7" class="empty-state">æš‚æ— æ•°æ®</td></tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="card">
            <h2><i class="fas fa-edit"></i> å½©è›‹é«˜çº§é…ç½®</h2>
            <div class="field-toggle-row">
              <div><span style="font-weight:600;">å¯ç”¨å…¨å±€å½©è›‹</span><div style="font-size:12px; color:var(--text-secondary);">æ€»å¼€å…³</div></div>
              <label class="se-toggle-wrap"><input type="checkbox" id="easter-eggs-enabled" class="se-toggle-input" /><span class="se-toggle-track"></span><span class="se-toggle-thumb"></span></label>
            </div>
            <div class="field" style="margin-top:16px;"><label>å¯¼å…¥ JSON æ–‡ä»¶</label><input type="file" id="easter-eggs-file-input" accept=".json" multiple /></div>
            <div class="field"><label>å®Œæ•´é…ç½® JSON</label><textarea id="easter-eggs-json" style="min-height:150px; font-family:monospace; font-size:12px;"></textarea></div>
            <div class="btn-group">
              <button class="btn btn-secondary" id="easter-eggs-sync-from-json">ä» JSON åŒæ­¥</button>
              <button class="btn btn-secondary" id="btn-get-easter-eggs">ä»æœåŠ¡å™¨åŠ è½½</button>
              <button class="btn btn-primary" id="btn-put-easter-eggs">ä¿å­˜åˆ°æœåŠ¡å™¨</button>
            </div>
            <div id="easter-eggs-status"></div>
          </div>
        </div>

        <div class="section-content" id="section-startup">
          <div class="card">
            <h2><i class="fas fa-bullhorn"></i> å¯åŠ¨å…¬å‘Š</h2>
            <div class="field-toggle-row">
              <div><span style="font-weight:600;">å¯ç”¨å¯åŠ¨å…¬å‘Š</span></div>
              <label class="se-toggle-wrap"><input type="checkbox" id="startup-enabled" class="se-toggle-input" /><span class="se-toggle-track"></span><span class="se-toggle-thumb"></span></label>
            </div>
            <div class="table-container" style="margin-top:16px;">
              <table>
                <thead>
                  <tr>
                    <th style="width:60px;">åºå·</th>
                    <th>æ ‡é¢˜</th>
                    <th>æ¨¡å¼</th>
                    <th style="width:140px;">æ“ä½œ</th>
                    <th style="width:100px; text-align:right;">å¯ç”¨</th>
                  </tr>
                </thead>
                <tbody id="startup-notices-tbody"></tbody>
              </table>
            </div>
            <div class="btn-group" style="margin-top:12px;"><button class="btn btn-secondary" id="startup-add-notice"><i class="fas fa-plus"></i> æ·»åŠ å…¬å‘Š</button></div>
            <div class="btn-group" style="margin-top:20px;">
              <button class="btn btn-secondary" id="btn-get-startup">åŠ è½½é…ç½®</button>
              <button class="btn btn-primary" id="btn-save-startup">ä¿å­˜é…ç½®</button>
            </div>
            <div id="startup-status"></div>
          </div>
        </div>

        <div class="section-content" id="section-display-flags">
          <div class="card">
            <h2><i class="fas fa-desktop"></i> æ˜¾ç¤ºç«¯åŠŸèƒ½å¼€å…³</h2>
            <div class="field-toggle-row">
              <div>
                <span style="font-weight:600;">åœ¨å®¢æˆ·ç«¯æ˜¾ç¤ºã€Œç³»ç»Ÿæ˜¾ç¤ºå™¨ã€å…¥å£</span>
                <div style="font-size:12px; color:var(--text-secondary);">è‹¥å…³é—­ï¼Œä¸»ç¨‹åºå°†éšè—è¯¥å¡ç‰‡ï¼Œä½†æœ¬åœ°ä¿æŠ¤æœºåˆ¶ä»ç„¶ç”Ÿæ•ˆ</div>
              </div>
              <label class="se-toggle-wrap">
                <input type="checkbox" id="display-show-system" class="se-toggle-input" />
                <span class="se-toggle-track"></span><span class="se-toggle-thumb"></span>
              </label>
            </div>
            <hr style="margin:20px 0; border:none; border-top:1px solid var(--border-color);">
            <h3>æ˜¾ç¤ºå™¨é…ç½®</h3>
            <div class="table-container">
              <table>
                <thead><tr><th>æ˜¾ç¤ºå™¨åç§°</th><th>åŠŸèƒ½è¯´æ˜</th><th style="text-align: right; width: 100px;">å¯ç”¨çŠ¶æ€</th></tr></thead>
                <tbody>
                  <tr>
                    <td><strong>æ˜¾ç¤ºå™¨ 1</strong></td><td style="color:var(--text-secondary);">ä¸»æ˜¾ç¤ºç«¯ (Standard)</td>
                    <td style="text-align: right;">
                      <label class="se-toggle-wrap"><input type="checkbox" id="display-1-enabled" class="se-toggle-input" /><span class="se-toggle-track"></span><span class="se-toggle-thumb"></span></label>
                    </td>
                  </tr>
                  <tr>
                    <td><strong>æ˜¾ç¤ºå™¨ 2</strong></td><td style="color:var(--text-secondary);">æµå—æ ·å¼ (Jinan)</td>
                    <td style="text-align: right;">
                      <label class="se-toggle-wrap"><input type="checkbox" id="display-2-enabled" class="se-toggle-input" /><span class="se-toggle-track"></span><span class="se-toggle-thumb"></span></label>
                    </td>
                  </tr>
                  <tr>
                    <td><strong>æ˜¾ç¤ºå™¨ 3</strong></td><td style="color:var(--text-secondary);">å¤‡ç”¨æ˜¾ç¤ºç«¯ (Display 3)</td>
                    <td style="text-align: right;">
                      <label class="se-toggle-wrap"><input type="checkbox" id="display-3-enabled" class="se-toggle-input" /><span class="se-toggle-track"></span><span class="se-toggle-thumb"></span></label>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="grid" style="margin-top:24px;">
              <div class="field">
                <label>å…è®¸çš„å›½å®¶ (ISO)</label>
                <div class="inline-input"><input id="display-allowed-country-input" placeholder="å¦‚ CN" /><button class="btn btn-secondary" id="btn-add-display-allowed-country">æ·»åŠ </button></div>
                <div id="display-allowed-countries-list" class="tag-list" style="margin-top:8px;"></div>
              </div>
              <div class="field">
                <label>ç¦æ­¢çš„å›½å®¶</label>
                <div class="inline-input"><input id="display-blocked-country-input" placeholder="å¦‚ XX" /><button class="btn btn-secondary" id="btn-add-display-blocked-country">æ·»åŠ </button></div>
                <div id="display-blocked-countries-list" class="tag-list" style="margin-top:8px;"></div>
              </div>
            </div>
            <hr style="margin: 24px 0; border: none; border-top: 1px solid var(--border-color);" />
            <h3 style="margin-top: 0;">æ—¶é—´èŒƒå›´æ§åˆ¶ï¼ˆå¯é€‰ï¼‰</h3>
            <div class="grid">
              <div class="field">
                <label for="display-start-time">å¼€å§‹æ—¶é—´ï¼ˆISO 8601ï¼Œå¦‚ï¼š2025-01-01T00:00:00Zï¼‰</label>
                <input type="datetime-local" id="display-start-time" />
                <div style="font-size:12px; color:var(--text-secondary); margin-top:4px;">
                  ç•™ç©ºè¡¨ç¤ºä¸é™åˆ¶å¼€å§‹æ—¶é—´
                </div>
              </div>
              <div class="field">
                <label for="display-end-time">ç»“æŸæ—¶é—´ï¼ˆISO 8601ï¼‰</label>
                <input type="datetime-local" id="display-end-time" />
                <div style="font-size:12px; color:var(--text-secondary); margin-top:4px;">
                  ç•™ç©ºè¡¨ç¤ºä¸é™åˆ¶ç»“æŸæ—¶é—´
                </div>
              </div>
            </div>
            <div class="grid">
              <div class="field">
                <label>å…è®¸çš„åŸå¸‚</label>
                <div class="inline-input"><input id="display-allowed-city-input" placeholder="å¦‚ Shanghai" /><button class="btn btn-secondary" id="btn-add-display-allowed-city">æ·»åŠ </button></div>
                <div id="display-allowed-cities-list" class="tag-list" style="margin-top:8px;"></div>
              </div>
              <div class="field">
                <label>ç¦æ­¢çš„åŸå¸‚</label>
                <div class="inline-input"><input id="display-blocked-city-input" placeholder="å¦‚ Tokyo" /><button class="btn btn-secondary" id="btn-add-display-blocked-city">æ·»åŠ </button></div>
                <div id="display-blocked-cities-list" class="tag-list" style="margin-top:8px;"></div>
              </div>
            </div>
            <div class="btn-group" style="margin-top:20px;">
              <button class="btn btn-secondary" id="btn-get-display-flags">ä»æœåŠ¡å™¨åŠ è½½</button>
              <button class="btn btn-primary" id="btn-save-display-flags">ä¿å­˜åˆ°æœåŠ¡å™¨</button>
            </div>
            <div id="display-flags-status"></div>
          </div>
        </div>

        <div class="section-content" id="section-holidays">
          <div class="card">
            <h2><i class="fas fa-calendar-alt"></i> èŠ‚æ—¥åˆ—è¡¨</h2>
            <div class="btn-group">
              <button class="btn btn-primary" id="btn-list-holidays"><i class="fas fa-sync"></i> åˆ·æ–°</button>
              <button class="btn btn-info" id="btn-add-holiday"><i class="fas fa-plus"></i> æ·»åŠ </button>
            </div>
            <div class="table-container">
              <table id="holidays-table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>åç§°</th>
                    <th>ç±»å‹</th>
                    <th>æ—¥æœŸ</th>
                    <th style="width:140px;">æ“ä½œ</th>
                    <th style="width:100px; text-align:right;">å¯ç”¨</th>
                  </tr>
                </thead>
                <tbody id="holidays-tbody">
                  <tr><td colspan="6" class="empty-state">æš‚æ— æ•°æ®</td></tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="card">
            <h2><i class="fas fa-search"></i> æŸ¥è¯¢ä¸å¯¼å…¥</h2>
            <div class="field">
              <label>æŸ¥è¯¢æŒ‡å®šæ—¥æœŸèŠ‚å‡æ—¥ (mxnzp)</label>
              <div class="field-row-inline"><input type="date" id="holiday-query-date" /><button class="btn btn-secondary" id="btn-query-holiday-single">æŸ¥è¯¢</button></div>
            </div>
            <div class="field" id="holiday-query-result-wrap" style="display:none;"><textarea id="holiday-query-result" readonly style="height:100px; font-family:monospace;"></textarea></div>
            <div class="field"><label>å¯¼å…¥ JSON æ–‡ä»¶</label><input type="file" id="holidays-file-input" accept=".json" multiple /></div>
            <textarea id="holidays-json" style="display:none;"></textarea>
            <div class="btn-group">
              <button class="btn btn-secondary" id="btn-get-active-holidays">æŸ¥çœ‹æ¿€æ´»èŠ‚æ—¥</button>
              <button class="btn btn-secondary" id="btn-get-holidays">åŠ è½½é…ç½®</button>
              <button class="btn btn-primary" id="btn-put-holidays">ä¿å­˜é…ç½®</button>
            </div>
            <div id="holidays-status"></div>
          </div>
        </div>

        <div class="section-content" id="section-updates">
          <div class="card">
            <h2><i class="fas fa-shield-alt"></i> å¼ºåˆ¶æ›´æ–°è®¾ç½®</h2>
            <div class="grid">
              <div class="field">
                <label>å¹³å°/æ¶æ„</label>
                <select id="update-platform-select">
                  <option value="win32:x64">Windows x64</option><option value="win32:arm64">Windows ARM64</option>
                  <option value="darwin:x64">macOS Intel</option><option value="darwin:arm64">macOS Apple Silicon</option>
                </select>
              </div>
              <div class="field">
                <label>æœ€ä½ç‰ˆæœ¬è¦æ±‚</label>
                <select id="update-minimum-version">
                  <option value="">ä¸è®¾ç½®</option>
                </select>
              </div>
            </div>
            <div class="field-toggle-row">
              <div><span style="font-weight:600;">å¼ºåˆ¶æ‰€æœ‰ç‰ˆæœ¬æ›´æ–°</span></div>
              <label class="se-toggle-wrap"><input type="checkbox" id="update-force-update" class="se-toggle-input" /><span class="se-toggle-track"></span><span class="se-toggle-thumb"></span></label>
            </div>
            <div class="btn-group">
              <button class="btn btn-secondary" id="btn-get-update-info">æŸ¥çœ‹å½“å‰ç‰ˆæœ¬ä¿¡æ¯</button>
              <button class="btn btn-primary" id="btn-sync-from-github">ä» GitHub åŒæ­¥</button>
              <button class="btn btn-success" id="btn-apply-force-update">åº”ç”¨å¼ºåˆ¶æ›´æ–°è®¾ç½®</button>
            </div>
            <div id="update-info-status"></div>
          </div>

          <div class="card">
            <h2><i class="fas fa-info-circle"></i> å½“å‰ç‰ˆæœ¬ä¿¡æ¯ï¼ˆåªè¯»ï¼‰</h2>
            <div class="field">
              <label>ç‰ˆæœ¬ä¿¡æ¯ JSON</label>
              <textarea id="update-info-json" readonly style="height:180px; font-family:monospace; font-size:12px;"></textarea>
            </div>
            <div style="font-size:12px; color:var(--text-secondary);">
              æç¤ºï¼šç‰ˆæœ¬ä¿¡æ¯ä¼šè‡ªåŠ¨ä» GitHub Releases åŒæ­¥ï¼Œæ— éœ€æ‰‹åŠ¨ä¸Šä¼ ã€‚
            </div>
          </div>

          <div class="card">
            <h2><i class="fas fa-book"></i> æ›´æ–°æ—¥å¿—</h2>
            <div class="btn-group">
              <button class="btn btn-success" id="btn-add-changelog-version"><i class="fas fa-plus"></i> æ·»åŠ ç‰ˆæœ¬</button>
              <button class="btn btn-secondary" id="btn-get-changelog"><i class="fas fa-download"></i> åŠ è½½</button>
              <button class="btn btn-primary" id="btn-sync-changelog-from-github">GitHub åŒæ­¥</button>
              <button class="btn btn-primary" id="btn-put-changelog"><i class="fas fa-save"></i> ä¿å­˜æ›´æ”¹</button>
            </div>
            <div id="changelog-list-container" style="margin-top:20px;">
              <div id="changelog-list-empty" style="text-align:center; padding:20px; color:var(--text-muted);">æš‚æ— æ—¥å¿—</div>
              <div id="changelog-list"></div>
            </div>
            <div id="changelog-status"></div>
          </div>
        </div>

        <div class="section-content" id="section-stats">
          <div class="grid">
            <div class="card stat-card stat-card-secondary"><div class="stat-value" id="stat-runtime-count">-</div><div class="stat-label">äº‘æ§çº¿è·¯</div></div>
            <div class="card stat-card stat-card-primary"><div class="stat-value" id="stat-users">-</div><div class="stat-label">ç‹¬ç«‹è®¾å¤‡</div></div>
          </div>
          <div class="card">
            <h2><i class="fas fa-globe"></i> è¯¦ç»†ç»Ÿè®¡</h2>
            <div class="field"><label>å…¨çƒåˆ†å¸ƒ</label><div id="stat-by-country" style="font-size:13px;">-</div></div>
            <div class="field"><label>ä½¿ç”¨ç‰ˆæœ¬</label><div id="stat-by-version" style="font-size:13px;">-</div></div>
            <div class="field"><label>æ“ä½œç³»ç»Ÿ</label><div id="stat-by-os" style="font-size:13px;">-</div></div>
            <div class="field"><label>è®¾å¤‡ç»Ÿè®¡</label><div id="stat-by-device" style="font-size:13px;">-</div></div>
            <div class="field">
              <label>æ’é™¤çš„è®¾å¤‡IDï¼ˆæ¯è¡Œä¸€ä¸ªï¼Œä¸å‚ä¸ç»Ÿè®¡å’Œåˆ—è¡¨ï¼‰</label>
              <textarea id="stat-excluded-devices" rows="2" style="font-family:monospace;font-size:12px;" placeholder="device-id-1&#10;device-id-2"></textarea>
            </div>
            <div class="field">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <label style="font-weight:600;">
                  æœ€è¿‘è®¿é—®è®°å½• <span id="stat-truncated-hint" style="font-size:12px;color:var(--warning);display:none;"></span>
                </label>
                <div class="btn-group" style="margin:0;">
                  <button class="btn btn-primary" id="btn-refresh-stats">åˆ·æ–°æ•°æ®</button>
                  <button class="btn btn-primary" id="btn-refresh-usage">åˆ·æ–°ä½¿ç”¨ç»Ÿè®¡</button>
                </div>
              </div>
              <div class="table-container" id="stat-recent-container" style="max-height: 400px; overflow-y: auto;">
                <table style="font-size:12px;">
                  <thead><tr><th>åœ°åŒº</th><th>åŸå¸‚</th><th>ç³»ç»Ÿ</th><th>ç‰ˆæœ¬</th><th>è®¾å¤‡ID</th><th>æ—¶é•¿</th></tr></thead>
                  <tbody id="stat-recent-tbody"></tbody>
                </table>
              </div>
            </div>
            <div class="btn-group">
              <button class="btn btn-secondary" id="btn-download-records">ä¸‹è½½ CSV</button>
              <button class="btn btn-secondary" id="btn-migrate-kv-to-d1" style="display:none;">KVè¿ç§»</button>
            </div>
          </div>
        </div>

      </main>
    </div>
  </div>

  <!-- å…¨å±€åŠ è½½æ‚¬æµ®é€šçŸ¥ -->
  <div class="loading-toast" id="global-loading-toast">
    <div class="loading-toast-header">
      <i class="fas fa-circle-notch fa-spin" style="color:var(--primary);"></i>
      <div>
        <div class="loading-toast-title" id="global-loading-title">æ­£åœ¨åŠ è½½</div>
        <div id="global-loading-desc" style="font-size:12px; color:var(--text-secondary);">è¯·ç¨å€™...</div>
      </div>
    </div>
    <div class="loading-toast-progress">
      <div class="loading-toast-bar"></div>
    </div>
  </div>

  <div class="modal" id="runtime-station-modal">
    <div class="modal-content">
      <div class="modal-header"><h3 id="runtime-station-modal-title">ç¼–è¾‘ç«™ç‚¹</h3><button class="close-btn" id="runtime-station-modal-close">&times;</button></div>
      <div class="modal-body">
        <div class="field"><label>ç«™å (ä¸­æ–‡)</label><input type="text" id="runtime-station-name" /></div>
        <div class="field"><label>ç«™å (è‹±æ–‡)</label><input type="text" id="runtime-station-en" /></div>
        <div class="grid">
          <div class="field"><label>åœé æ–¹å‘</label><select id="runtime-station-dock"><option value="both">åŒå‘</option><option value="up">ä»…ä¸Šè¡Œ</option><option value="down">ä»…ä¸‹è¡Œ</option></select></div>
          <div class="field" style="display:flex; flex-direction:column; justify-content:center;">
             <label><input type="checkbox" id="runtime-station-skip" /> è·³ç«™</label>
             <label><input type="checkbox" id="runtime-station-express" /> å¤§ç«™åœé </label>
          </div>
        </div>
        <div class="field">
          <label>æ¢ä¹˜</label><div id="runtime-station-xfer-list"></div>
          <button class="btn btn-sm btn-secondary" id="runtime-station-add-xfer" style="margin-top:8px;">æ·»åŠ æ¢ä¹˜</button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="runtime-station-modal-cancel">å–æ¶ˆ</button>
        <button class="btn btn-primary" id="runtime-station-modal-save">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <div class="modal" id="easter-egg-edit-modal">
    <div class="modal-content">
      <div class="modal-header"><h3 id="easter-egg-edit-modal-title">å½©è›‹</h3><button class="close-btn" id="easter-egg-edit-modal-close">&times;</button></div>
      <div class="modal-body">
        <div class="field"><label>ID</label><input type="text" id="easter-egg-edit-id" readonly style="background:var(--bg-hover);" /></div>
        <div class="field"><label>åç§°</label><input type="text" id="easter-egg-edit-name" /></div>
        <div class="field"><label><input type="checkbox" id="easter-egg-edit-enabled" /> å¯ç”¨</label></div>
        
        <div class="field">
          <label style="display:flex; justify-content:space-between; align-items:center;">
            è§¦å‘ç«™ç‚¹ (æ¯è¡Œä¸€ä¸ª)
            <button class="btn btn-sm btn-info" id="btn-egg-load-lines" type="button"><i class="fas fa-bolt"></i> ä»çº¿è·¯æ·»åŠ </button>
          </label>
          <div id="egg-line-selector" class="station-select-box">
             <div style="display:flex; gap:8px;">
               <select id="egg-line-select" style="flex:1;"><option value="">-- é€‰æ‹©çº¿è·¯ --</option></select>
               <button class="btn btn-sm btn-secondary" id="btn-egg-load-stations" type="button">åŠ è½½</button>
             </div>
             <div id="egg-station-checkboxes" class="station-checkbox-group"></div>
          </div>
          <textarea id="easter-egg-edit-stations" rows="3" placeholder="æ‰‹åŠ¨è¾“å…¥æˆ–ä¸Šæ–¹é€‰æ‹©..."></textarea>
        </div>
        
        <div class="field"><label>æ¶ˆæ¯å†…å®¹ (æ¯è¡Œä¸€æ¡)</label><textarea id="easter-egg-edit-messages" rows="3"></textarea></div>
        <div class="field"><label>æ—¥æœŸ (å¯é€‰ yyyyMMdd)</label><input type="date" id="easter-egg-edit-date" /></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="easter-egg-edit-cancel">å–æ¶ˆ</button>
        <button class="btn btn-primary" id="easter-egg-edit-save">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <div class="modal" id="startup-notice-modal">
    <div class="modal-content">
      <div class="modal-header"><h3 id="startup-notice-modal-title">å…¬å‘Š</h3><button class="close-btn" id="startup-notice-modal-close">&times;</button></div>
      <div class="modal-body">
        <div class="field">
           <label>ID</label>
           <div class="inline-input"><input type="text" id="startup-modal-id" /><button class="btn btn-secondary" id="startup-modal-generate-id">ç”Ÿæˆ</button></div>
        </div>
        <div class="field"><label>æ¨¡å¼</label><select id="startup-modal-mode"><option value="everyRun">æ¯æ¬¡è¿è¡Œ</option><option value="oncePerDay">æ¯å¤©ä¸€æ¬¡</option></select></div>
        <div class="field"><label><input type="checkbox" id="startup-modal-enabled" /> å¯ç”¨</label></div>
        <div class="field"><label>æ ‡é¢˜</label><input type="text" id="startup-modal-title" /></div>
        <div class="field"><label>å†…å®¹</label><textarea id="startup-modal-message" rows="3"></textarea></div>
        <div class="grid">
          <div class="field"><label>å¼€å§‹æ—¶é—´</label><input type="datetime-local" id="startup-modal-start-time" /></div>
          <div class="field"><label>ç»“æŸæ—¶é—´</label><input type="datetime-local" id="startup-modal-end-time" /></div>
        </div>
        <div class="field"><label>å…è®¸/ç¦æ­¢å›½å®¶</label><textarea id="startup-modal-allowed-countries" placeholder="å…è®¸..."></textarea><textarea id="startup-modal-blocked-countries" placeholder="ç¦æ­¢..." style="margin-top:5px;"></textarea></div>
        <div class="field"><label>å…è®¸/ç¦æ­¢åŸå¸‚</label><textarea id="startup-modal-allowed-cities" placeholder="å…è®¸..."></textarea><textarea id="startup-modal-blocked-cities" placeholder="ç¦æ­¢..." style="margin-top:5px;"></textarea></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="startup-notice-modal-cancel">å–æ¶ˆ</button>
        <button class="btn btn-primary" id="startup-notice-modal-save">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <div class="modal" id="holiday-edit-modal">
    <div class="modal-content">
      <div class="modal-header"><h3 id="holiday-edit-modal-title">èŠ‚æ—¥</h3><button class="close-btn" id="holiday-edit-modal-close">&times;</button></div>
      <div class="modal-body">
        <input type="hidden" id="holiday-edit-key" />
        <div class="field"><label>åç§°</label><input type="text" id="holiday-edit-name" /></div>
<<<<<<< Updated upstream
        <div class="field"><label>ç±»å‹</label><select id="holiday-edit-typeDes"><option value="å…¨éƒ¨">å…¨éƒ¨</option><option value="å·¥ä½œæ—¥">å·¥ä½œæ—¥</option><option value="å‘¨æœ«">å‘¨æœ«</option><option value="å…¶ä»–">å…¶ä»–</option></select></div>
=======
<<<<<<< HEAD
        <div class="field">
          <label>ç±»å‹</label>
          <select id="holiday-edit-typeDes">
            <option value="å…¨éƒ¨">å…¨éƒ¨ï¼ˆä»…æŒ‰æ—¥æœŸèŒƒå›´ï¼‰</option>
            <option value="å·¥ä½œæ—¥">å·¥ä½œæ—¥</option>
            <option value="å‘¨æœ«">å‘¨æœ«</option>
            <option value="æ˜¥èŠ‚">æ˜¥èŠ‚</option>
            <option value="æ¸…æ˜èŠ‚">æ¸…æ˜èŠ‚</option>
            <option value="åŠ³åŠ¨èŠ‚">åŠ³åŠ¨èŠ‚</option>
            <option value="ç«¯åˆèŠ‚">ç«¯åˆèŠ‚</option>
            <option value="ä¸­ç§‹èŠ‚">ä¸­ç§‹èŠ‚</option>
            <option value="å›½åº†èŠ‚">å›½åº†èŠ‚</option>
            <option value="å…¶ä»–">å…¶ä»–ï¼ˆä¸ API ä¸åŒ¹é…æ—¶ä¸ä¼šè‡ªåŠ¨å¼¹çª—ï¼‰</option>
          </select>
        </div>
=======
        <div class="field"><label>ç±»å‹</label><select id="holiday-edit-typeDes"><option value="å…¨éƒ¨">å…¨éƒ¨</option><option value="å·¥ä½œæ—¥">å·¥ä½œæ—¥</option><option value="å‘¨æœ«">å‘¨æœ«</option><option value="å…¶ä»–">å…¶ä»–</option></select></div>
>>>>>>> 5e6badfcb798ff4bb795199c1cd04aeb2a4d3fcc
>>>>>>> Stashed changes
        <div class="field"><label>å†…å®¹</label><textarea id="holiday-edit-content" rows="2"></textarea></div>
        <div class="field"><label><input type="checkbox" id="holiday-edit-enabled" checked /> å¯ç”¨</label></div>
        <div class="grid">
          <div class="field"><label>å¼€å§‹æ—¥æœŸ</label><input type="date" id="holiday-edit-dateStart" /></div>
          <div class="field"><label>ç»“æŸæ—¥æœŸ</label><input type="date" id="holiday-edit-dateEnd" /></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="holiday-edit-cancel">å–æ¶ˆ</button>
        <button class="btn btn-primary" id="holiday-edit-save">ä¿å­˜</button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="changelog-edit-modal">
    <div class="modal-content" style="max-width:800px;">
      <div class="modal-header"><h3 id="changelog-modal-title">æ›´æ–°æ—¥å¿—</h3><button class="close-btn" id="changelog-modal-close">&times;</button></div>
      <div class="modal-body">
        <div class="field"><label>ç‰ˆæœ¬å·</label><input type="text" id="changelog-edit-version" placeholder="1.0.0" /></div>
        <div class="field"><label>æ ‡é¢˜</label><input type="text" id="changelog-edit-title" /></div>
        <div class="field"><label>ä¸Šä¼ MDæ–‡ä»¶</label><input type="file" id="changelog-edit-md-file" accept=".md" /></div>
        <div class="field"><label>å†…å®¹</label><textarea id="changelog-edit-content" rows="10" style="font-family:monospace;"></textarea></div>
        <div class="field"><label>å‘å¸ƒæ—¥æœŸ</label><input type="datetime-local" id="changelog-edit-releasedate" /></div>
        <div class="field"><label><input type="checkbox" id="changelog-edit-prerelease" /> é¢„å‘å¸ƒ</label></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="changelog-modal-cancel">å–æ¶ˆ</button>
        <button class="btn btn-primary" id="changelog-modal-save">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <div class="modal" id="settings-modal">
    <div class="modal-content">
      <div class="modal-header"><h3>ç³»ç»Ÿè®¾ç½®</h3><button class="close-btn" id="close-settings">&times;</button></div>
      <div class="modal-body">
        <div class="field"><label>API åœ°å€</label><input type="text" id="api-base" /></div>
        <div class="field"><label>Token (å¯é€‰)</label><input type="password" id="api-token" /></div>
        <div id="settings-check-status"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="btn-check-api">æ ¡éªŒ</button>
        <button class="btn btn-primary" id="btn-save-settings">ä¿å­˜</button>
        <button class="btn btn-secondary" id="btn-cancel-settings">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <!-- å¯åŠ¨è‡ªåŠ¨åŠ è½½è¿›åº¦å¼¹çª— -->
  <div class="modal" id="auto-load-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>æ­£åœ¨åˆå§‹åŒ–äº‘æ§æ•°æ®</h3>
      </div>
      <div class="modal-body">
        <p style="font-size:13px; color:var(--text-secondary); margin-bottom:12px;">
          æ­£åœ¨ä»æœåŠ¡å™¨åŠ è½½é…ç½®ä¿¡æ¯ï¼Œè¯·ç¨å€™â€¦â€¦
        </p>
        <div style="width:100%; height:10px; background:var(--bg-muted); border-radius:999px; overflow:hidden;">
          <div id="auto-load-progress-bar" style="width:0%; height:100%; background:linear-gradient(90deg,#667eea,#764ba2); transition:width 0.3s ease;"></div>
        </div>
        <div id="auto-load-progress-text" style="margin-top:8px; font-size:12px; color:var(--text-secondary); text-align:right;">
          0%
        </div>
      </div>
    </div>
  </div>
  <script>
    // ä¾§è¾¹æ åˆ‡æ¢ï¼ˆå«ç§»åŠ¨ç«¯æŠ½å±‰ï¼‰
    function initSidebarNavigation() {
      const items = document.querySelectorAll('.sidebar-item');
      const sections = document.querySelectorAll('.section-content');
      const sidebar = document.getElementById('sidebar');
      const sidebarOverlay = document.getElementById('sidebar-overlay');
      const menuToggle = document.getElementById('menu-toggle');

      function openSidebar() {
        if (sidebar) sidebar.classList.add('active');
        if (sidebarOverlay) sidebarOverlay.classList.add('active');
      }

      function closeSidebar() {
        if (sidebar) sidebar.classList.remove('active');
        if (sidebarOverlay) sidebarOverlay.classList.remove('active');
      }
      
      function activateSection(sectionId) {
        items.forEach(btn => {
          const sec = btn.getAttribute('data-section');
          btn.classList.toggle('active', sec === sectionId);
        });
        sections.forEach(sec => {
          if (sec.id === `section-${sectionId}`) {
            sec.style.display = '';
            sec.classList.add('active');
          } else {
            sec.style.display = 'none';
            sec.classList.remove('active');
          }
        });

        // åœ¨ç§»åŠ¨ç«¯ç‚¹å‡»èœå•åè‡ªåŠ¨æ”¶èµ·ä¾§è¾¹æ 
        if (window.innerWidth <= 768) {
          closeSidebar();
        }
      }

      // ä¾§è¾¹æ èœå•ç‚¹å‡»
      items.forEach(btn => {
        btn.addEventListener('click', () => {
          const section = btn.getAttribute('data-section');
          if (section) {
            activateSection(section);
          }
        });
      });

      // é¡¶éƒ¨æ±‰å ¡æŒ‰é’®ï¼ˆç§»åŠ¨ç«¯ï¼‰
      if (menuToggle) {
        menuToggle.addEventListener('click', () => {
          if (sidebar && sidebar.classList.contains('active')) {
            closeSidebar();
          } else {
            openSidebar();
          }
        });
      }

      // ç‚¹å‡»é®ç½©å…³é—­ä¾§è¾¹æ 
      if (sidebarOverlay) {
        sidebarOverlay.addEventListener('click', () => {
          closeSidebar();
        });
      }
      
      // é»˜è®¤æ¿€æ´»è¿æ§çº¿è·¯
      activateSection('runtime');
    }

    // é…ç½®ç®¡ç†
    const STORAGE_KEY = 'metro_pids_admin_config';
    
    function loadConfig() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : { apiBase: '', token: '' };
      } catch {
        return { apiBase: '', token: '' };
      }
    }
    
    function saveConfig(config) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(config));
    }

    // å¯åŠ¨è‡ªåŠ¨åŠ è½½è¿›åº¦å¼¹çª—
    function showAutoLoadModal() {
      const modal = document.getElementById('auto-load-modal');
      if (modal) modal.classList.add('active');
      updateAutoLoadProgress(0, 'å‡†å¤‡åŠ è½½â€¦');
    }

    function hideAutoLoadModal() {
      const modal = document.getElementById('auto-load-modal');
      if (modal) modal.classList.remove('active');
    }

    function updateAutoLoadProgress(percent, label) {
      const bar = document.getElementById('auto-load-progress-bar');
      const text = document.getElementById('auto-load-progress-text');
      const p = Math.max(0, Math.min(100, Math.round(percent)));
      if (bar) bar.style.width = p + '%';
      if (text) text.textContent = (label || '') + ' ' + p + '%';
    }
    
    function getConfig() {
      const base = document.getElementById('api-base')?.value?.trim() || '';
      const token = document.getElementById('api-token')?.value?.trim() || '';
      const excludedDevices = document.getElementById('stat-excluded-devices')?.value || '';
      return {
        apiBase: base,
        token,
        excludedDevices
      };
    }

    /** æ ¡éªŒ API è¿æ¥ï¼Œè¿”å› { ok: boolean, message?: string } */
    async function checkApiConnection() {
      const cfg = getConfig();
      if (!cfg.apiBase) return { ok: false, message: 'è¯·å…ˆå¡«å†™ API åœ°å€' };
      const url = cfg.apiBase.replace(/\/+$/, '') + '/';
      const headers = { 'Accept': 'application/json' };
      if (cfg.token) headers['Authorization'] = 'Bearer ' + cfg.token;
      try {
        const res = await fetch(url, { method: 'GET', headers });
        const text = await res.text();
        let data = null;
        try { data = text ? JSON.parse(text) : null; } catch (_) {}
        if (res.ok && data && data.ok) return { ok: true };
        const msg = (data && (data.error || data.message)) || ('HTTP ' + res.status);
        return { ok: false, message: msg };
      } catch (e) {
        return { ok: false, message: e.message || 'ç½‘ç»œé”™è¯¯' };
      }
    }
    
    // API è°ƒç”¨
    async function callApi(method, path, body = null) {
      const config = getConfig();
      if (!config.apiBase) {
        throw new Error('è¯·å…ˆè®¾ç½® API åœ°å€');
      }
      
      const url = config.apiBase.replace(/\/+$/, '') + path;
      const headers = {
        'Accept': 'application/json'
      };
      
      if (body) {
        headers['Content-Type'] = 'application/json';
      }
      
      if (config.token) {
        headers['Authorization'] = `Bearer ${config.token}`;
      }
      
      const response = await fetch(url, {
        method,
        headers,
        body: body ? JSON.stringify(body) : undefined
      });
      
      const text = await response.text();
      let data;
      try {
        data = text ? JSON.parse(text) : null;
      } catch {
        data = text;
      }
      
      if (!response.ok) {
        throw new Error(data.error || data.message || `HTTP ${response.status}: ${text}`);
      }
      
      return data;
    }
    
    // çŠ¶æ€æ˜¾ç¤º
    function showStatus(elementId, message, type = 'info') {
      const el = document.getElementById(elementId);
      if (!el) return;
      
      el.innerHTML = message ? `<span class="status ${type}">${message}</span>` : '';
    }

    function escapeHtml(s) {
      if (s == null) return '';
      const t = String(s);
      return t.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }
    
    // æ ‡ç­¾é¡µåˆ‡æ¢
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        
        // æ›´æ–°æ ‡ç­¾é¡µçŠ¶æ€
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // æ›´æ–°å†…å®¹æ˜¾ç¤º
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        const targetTab = document.getElementById(`tab-${tabName}`);
        if (targetTab) {
          targetTab.classList.add('active');
        } else {
          console.error(`Tab content not found: tab-${tabName}`);
        }
        
        // æ ¹æ®æ ‡ç­¾é¡µè‡ªåŠ¨åŠ è½½æ•°æ®
        if (tabName === 'updates') {
          // åˆ‡æ¢åˆ°ç‰ˆæœ¬æ›´æ–°æ ‡ç­¾é¡µæ—¶ï¼Œè‡ªåŠ¨åŠ è½½æ›´æ–°æ—¥å¿—
          const cfg = getConfig();
          if (cfg.apiBase && changelogList.length === 0) {
            setTimeout(() => {
              document.getElementById('btn-get-changelog').click();
            }, 100);
          } else if (!cfg.apiBase) {
            showStatus('changelog-status', 'è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API åœ°å€', 'error');
          }
        } else if (tabName === 'stats') {
          // åˆ‡æ¢åˆ°ç»Ÿè®¡ä¿¡æ¯æ ‡ç­¾é¡µæ—¶ï¼Œè‡ªåŠ¨åˆ·æ–°ç»Ÿè®¡
          const cfg = getConfig();
          if (cfg.apiBase) {
            setTimeout(() => {
              document.getElementById('btn-refresh-stats').click();
              document.getElementById('btn-refresh-usage').click();
            }, 100);
          } else {
            showStatus('changelog-status', 'è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API åœ°å€', 'error');
          }
        }
      });
    });
    
    // è®¾ç½®æ¨¡æ€æ¡†
    const settingsModal = document.getElementById('settings-modal');
    const config = loadConfig();
    
    document.getElementById('btn-settings').addEventListener('click', () => {
      document.getElementById('api-base').value = config.apiBase || '';
      document.getElementById('api-token').value = config.token || '';
      document.getElementById('settings-check-status').innerHTML = '';
      settingsModal.classList.add('active');
    });
    
    document.getElementById('close-settings').addEventListener('click', () => {
      settingsModal.classList.remove('active');
    });
    
    document.getElementById('btn-cancel-settings').addEventListener('click', () => {
      settingsModal.classList.remove('active');
    });

    document.getElementById('btn-check-api').addEventListener('click', async () => {
      const el = document.getElementById('settings-check-status');
      const btn = document.getElementById('btn-check-api');
      el.innerHTML = '';
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> æ ¡éªŒä¸­...';
      try {
        const r = await checkApiConnection();
        if (r.ok) {
          el.innerHTML = '<span class="status success"><i class="fas fa-check-circle"></i> è¿æ¥æˆåŠŸ</span>';
        } else {
          el.innerHTML = '<span class="status error"><i class="fas fa-times-circle"></i> ' + (r.message || 'è¿æ¥å¤±è´¥') + '</span>';
        }
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-link"></i> æ ¡éªŒè¿æ¥';
      }
    });

    document.getElementById('btn-save-settings').addEventListener('click', async () => {
      const el = document.getElementById('settings-check-status');
      const saveBtn = document.getElementById('btn-save-settings');
      const newConfig = getConfig();
      el.innerHTML = '';
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<span class="loading"></span> æ ¡éªŒä¸­...';
      try {
        const r = await checkApiConnection();
        if (!r.ok) {
          el.innerHTML = '<span class="status error"><i class="fas fa-times-circle"></i> ' + (r.message || 'è¿æ¥å¤±è´¥') + 'ï¼Œæœªä¿å­˜</span>';
          return;
        }
        el.innerHTML = '<span class="status success"><i class="fas fa-check-circle"></i> æ ¡éªŒé€šè¿‡</span>';
        saveConfig(newConfig);
        Object.assign(config, newConfig);
        document.getElementById('api-base-display').textContent = config.apiBase || 'æœªè®¾ç½®';
        settingsModal.classList.remove('active');
        alert('è®¾ç½®å·²ä¿å­˜ï¼');
      } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save"></i> ä¿å­˜';
      }
    });
    
    // è¿æ§çº¿è·¯åŠŸèƒ½
    document.getElementById('btn-list-runtime').addEventListener('click', async () => {
      const tbody = document.getElementById('runtime-tbody');
      tbody.innerHTML = '<tr><td colspan="3" class="empty-state"><div class="loading"></div> åŠ è½½ä¸­...</td></tr>';
      
      try {
        const data = await callApi('GET', '/runtime/lines');
        const lines = data.lines || [];
        
        if (lines.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3" class="empty-state"><i class="fas fa-inbox"></i><div>æš‚æ— æ•°æ®</div></td></tr>';
          return;
        }
        
        tbody.innerHTML = lines.map(line => {
          const lineName = line.meta?.lineName || 'æœªçŸ¥';
          const stationCount = line.stations?.length || 0;
          return `
            <tr>
              <td><strong>${lineName}</strong></td>
              <td><span class="badge badge-info">${stationCount} ä¸ªç«™ç‚¹</span></td>
              <td>
                <button class="btn btn-secondary btn-small" onclick="loadRuntimeLine('${lineName}')">
                  <i class="fas fa-edit"></i> ç¼–è¾‘
                </button>
                <button class="btn btn-danger btn-small btn-small-spaced" onclick="deleteRuntimeLine('${lineName}')">
                  <i class="fas fa-trash"></i> åˆ é™¤
                </button>
              </td>
            </tr>
          `;
        }).join('');
      } catch (e) {
        tbody.innerHTML = `<tr><td colspan="3" class="empty-state"><i class="fas fa-exclamation-triangle"></i><div>åŠ è½½å¤±è´¥ï¼š${e.message}</div></td></tr>`;
      }
    });
    
    // è¿æ§çº¿è·¯æ–‡ä»¶ç®¡ç† & ç«™ç‚¹å¯è§†åŒ–ç¼–è¾‘
    let runtimeFiles = [];
    let runtimeStations = [];
    
    // å¤„ç†æ–‡ä»¶é€‰æ‹©
    document.getElementById('runtime-line-file-input').addEventListener('change', async (e) => {
      const files = Array.from(e.target.files);
      runtimeFiles = [];
      
      if (files.length === 0) {
        document.getElementById('runtime-files-list').style.display = 'none';
        return;
      }
      
      // æ˜¾ç¤ºå·²é€‰æ‹©çš„æ–‡ä»¶åˆ—è¡¨
      const filesList = document.getElementById('runtime-files-items');
      filesList.innerHTML = '';
      
      for (const file of files) {
        const li = document.createElement('li');
        li.innerHTML = `<code>${file.name}</code>`;
        filesList.appendChild(li);
        
        runtimeFiles.push(file);
      }
      
      document.getElementById('runtime-files-list').style.display = 'block';
      showStatus('runtime-status', `å·²é€‰æ‹© ${files.length} ä¸ªæ–‡ä»¶ï¼Œç‚¹å‡»"è§£æå¹¶ä¸Šä¼ æ–‡ä»¶"æŒ‰é’®å¤„ç†`, 'info');
    });
    
    // è§£æå¹¶ä¸Šä¼ æ–‡ä»¶
    document.getElementById('btn-parse-runtime-files').addEventListener('click', async () => {
      if (runtimeFiles.length === 0) {
        showStatus('runtime-status', 'è¯·å…ˆé€‰æ‹© JSON æ–‡ä»¶', 'error');
        return;
      }
      
      let successCount = 0;
      let failCount = 0;
      const errors = [];
      
      showStatus('runtime-status', `æ­£åœ¨å¤„ç† ${runtimeFiles.length} ä¸ªæ–‡ä»¶...`, 'info');
      
      // ä¸ Worker ä¸€è‡´çš„çº¿è·¯åè§„èŒƒåŒ–ï¼Œä¿è¯åŒä¸€æ¡çº¿è·¯å§‹ç»ˆè¦†ç›–åŒä¸€ key
      function normalizeRuntimeLineName(name) {
        if (name == null || typeof name !== 'string') return '';
        const s = String(name).trim();
        if (!s) return '';
        try {
          return s.normalize('NFC');
        } catch {
          return s;
        }
      }

      for (const file of runtimeFiles) {
        try {
          const text = await file.text();
          const json = JSON.parse(text);
          
          // éªŒè¯ JSON æ ¼å¼
          if (!json.meta || !json.meta.lineName) {
            throw new Error(`æ–‡ä»¶ ${file.name} ç¼ºå°‘ meta.lineName å­—æ®µ`);
          }
          
          if (!Array.isArray(json.stations)) {
            throw new Error(`æ–‡ä»¶ ${file.name} ç¼ºå°‘ stations æ•°ç»„`);
          }
          
          const lineName = normalizeRuntimeLineName(json.meta.lineName);
          if (!lineName) {
            throw new Error(`æ–‡ä»¶ ${file.name} çš„ meta.lineName ä¸ºç©º`);
          }
          json.meta.lineName = lineName;
          
          // ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼ˆè§„èŒƒåŒ–åçš„åç§°ä¿è¯è¦†ç›–è€ç‰ˆæœ¬ï¼‰
          await callApi('PUT', `/runtime/lines/${encodeURIComponent(lineName)}`, json);
          successCount++;
          
          // å¦‚æœåªæœ‰ä¸€ä¸ªæ–‡ä»¶ï¼Œè‡ªåŠ¨å¡«å……åˆ°é¢„è§ˆåŒºåŸŸå¹¶åŠ è½½å¯è§†åŒ–ç¼–è¾‘å™¨
          if (runtimeFiles.length === 1) {
            document.getElementById('runtime-line-name').value = lineName;
            document.getElementById('runtime-line-json').value = JSON.stringify(json, null, 2);
            loadRuntimeStationsFromJson();
          }
        } catch (e) {
          failCount++;
          errors.push(`${file.name}: ${e.message}`);
          console.error(`å¤„ç†æ–‡ä»¶ ${file.name} å¤±è´¥:`, e);
        }
      }
      
      // æ˜¾ç¤ºç»“æœ
      if (failCount === 0) {
        showStatus('runtime-status', `âœ… æˆåŠŸä¸Šä¼  ${successCount} æ¡è¿æ§çº¿è·¯ï¼`, 'success');
        // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
        document.getElementById('runtime-line-file-input').value = '';
        document.getElementById('runtime-files-list').style.display = 'none';
        runtimeFiles = [];
        // åˆ·æ–°åˆ—è¡¨
        document.getElementById('btn-list-runtime').click();
      } else {
        const errorMsg = errors.join('; ');
        showStatus('runtime-status', `âš ï¸ æˆåŠŸ ${successCount} æ¡ï¼Œå¤±è´¥ ${failCount} æ¡ã€‚é”™è¯¯ï¼š${errorMsg}`, 'warn');
      }
    });
    
    let runtimeEditingIndex = -1;

    function openRuntimeStationModal(index) {
      const modal = document.getElementById('runtime-station-modal');
      if (!modal) return;
      
      const titleEl = document.getElementById('runtime-station-modal-title');
      const nameInput = document.getElementById('runtime-station-name');
      const enInput = document.getElementById('runtime-station-en');
      const skipInput = document.getElementById('runtime-station-skip');
      const dockSelect = document.getElementById('runtime-station-dock');
      const expressInput = document.getElementById('runtime-station-express');
      const xferListEl = document.getElementById('runtime-station-xfer-list');
      
      if (index >= 0 && runtimeStations[index]) {
        const st = runtimeStations[index];
        runtimeEditingIndex = index;
        titleEl.textContent = 'ç¼–è¾‘ç«™ç‚¹';
        nameInput.value = st.name || '';
        enInput.value = st.en || '';
        skipInput.checked = !!st.skip;
        dockSelect.value = st.dock || 'both';
        expressInput.checked = st.expressStop !== false;
        const xfers = Array.isArray(st.xfer) ? st.xfer : [];
        renderRuntimeStationXfers(xfers);
      } else {
        runtimeEditingIndex = -1;
        titleEl.textContent = 'æ–°å¢ç«™ç‚¹';
        nameInput.value = '';
        enInput.value = '';
        skipInput.checked = false;
        dockSelect.value = 'both';
        expressInput.checked = true;
        if (xferListEl) xferListEl.innerHTML = '<div class="empty-state" style="padding:4px 0;">æš‚æ— æ¢ä¹˜</div>';
      }
      
      modal.classList.add('active');
    }

    function closeRuntimeStationModal() {
      const modal = document.getElementById('runtime-station-modal');
      if (modal) {
        modal.classList.remove('active');
      }
      runtimeEditingIndex = -1;
    }

    function saveRuntimeStationFromModal() {
      const nameInput = document.getElementById('runtime-station-name');
      const enInput = document.getElementById('runtime-station-en');
      const skipInput = document.getElementById('runtime-station-skip');
      const dockSelect = document.getElementById('runtime-station-dock');
      const expressInput = document.getElementById('runtime-station-express');
      const xferListEl = document.getElementById('runtime-station-xfer-list');
      
      const name = nameInput.value.trim();
      if (!name) {
        alert('è¯·å¡«å†™ç«™åï¼ˆä¸­æ–‡ï¼‰');
        return;
      }
      const en = enInput.value.trim();
      const skip = !!skipInput.checked;
      const dock = dockSelect.value || 'both';
      const expressStop = !!expressInput.checked;

       // æ”¶é›†æ¢ä¹˜ä¿¡æ¯
      const xfers = [];
      if (xferListEl) {
        xferListEl.querySelectorAll('.runtime-xfer-row').forEach(row => {
          const lineInput = row.querySelector('.runtime-xfer-line');
          const colorInput = row.querySelector('.runtime-xfer-color');
          const exitCheckbox = row.querySelector('.runtime-xfer-exit');
          const suspendedCheckbox = row.querySelector('.runtime-xfer-suspended');
          const line = (lineInput?.value || '').trim();
          if (!line) return;
          xfers.push({
            line,
            color: colorInput?.value || '#808080',
            exitTransfer: !!(exitCheckbox && exitCheckbox.checked),
            suspended: !!(suspendedCheckbox && suspendedCheckbox.checked)
          });
        });
      }
      
      if (runtimeEditingIndex >= 0 && runtimeStations[runtimeEditingIndex]) {
        runtimeStations[runtimeEditingIndex] = {
          ...runtimeStations[runtimeEditingIndex],
          name,
          en,
          skip,
          dock,
          expressStop,
          xfer: xfers
        };
      } else {
        runtimeStations.push({
          name,
          en,
          skip,
          dock,
          xfer: xfers,
          expressStop
        });
      }
      
      closeRuntimeStationModal();
      renderRuntimeStationList();
    }

    document.getElementById('runtime-station-modal-close').addEventListener('click', closeRuntimeStationModal);
    document.getElementById('runtime-station-modal-cancel').addEventListener('click', closeRuntimeStationModal);
    document.getElementById('runtime-station-modal-save').addEventListener('click', saveRuntimeStationFromModal);

    function renderRuntimeStationXfers(xfers) {
      const listEl = document.getElementById('runtime-station-xfer-list');
      if (!listEl) return;
      
      listEl.innerHTML = '';
      if (!Array.isArray(xfers) || xfers.length === 0) {
        listEl.innerHTML = '<div class="empty-state" style="padding:4px 0;">æš‚æ— æ¢ä¹˜</div>';
        return;
      }
      
      xfers.forEach((xf, idx) => {
        const row = document.createElement('div');
        row.className = 'runtime-xfer-row';
        row.innerHTML = `
          <input class="runtime-xfer-line" type="text" placeholder="çº¿è·¯åç§°/ç¼–å·" value="${xf.line || ''}" />
          <input class="runtime-xfer-color" type="text" placeholder="#RRGGBB" value="${xf.color || '#808080'}" />
          <div class="runtime-xfer-flags">
            <label><input type="checkbox" class="runtime-xfer-exit" ${xf.exitTransfer ? 'checked' : ''}/> å‡ºç«™æ¢ä¹˜</label>
            <label><input type="checkbox" class="runtime-xfer-suspended" ${xf.suspended ? 'checked' : ''}/> æš‚ç¼“</label>
          </div>
          <div class="runtime-xfer-actions">
            <button class="btn btn-secondary btn-small" data-action="remove">åˆ é™¤</button>
          </div>
        `;
        row.querySelector('[data-action="remove"]').addEventListener('click', () => {
          const current = Array.from(document.querySelectorAll('#runtime-station-xfer-list .runtime-xfer-row'));
          current.splice(idx, 1);
          const newXfers = current.map(r => {
            const lineInput = r.querySelector('.runtime-xfer-line');
            const colorInput = r.querySelector('.runtime-xfer-color');
            const exitCheckbox = r.querySelector('.runtime-xfer-exit');
            const suspendedCheckbox = r.querySelector('.runtime-xfer-suspended');
            return {
              line: (lineInput?.value || '').trim(),
              color: colorInput?.value || '#808080',
              exitTransfer: !!(exitCheckbox && exitCheckbox.checked),
              suspended: !!(suspendedCheckbox && suspendedCheckbox.checked)
            };
          }).filter(x => x.line);
          renderRuntimeStationXfers(newXfers);
        });
        listEl.appendChild(row);
      });
    }

    document.getElementById('runtime-station-add-xfer').addEventListener('click', () => {
      const listEl = document.getElementById('runtime-station-xfer-list');
      const current = [];
      if (listEl) {
        listEl.querySelectorAll('.runtime-xfer-row').forEach(row => {
          const lineInput = row.querySelector('.runtime-xfer-line');
          const colorInput = row.querySelector('.runtime-xfer-color');
          const exitCheckbox = row.querySelector('.runtime-xfer-exit');
          const suspendedCheckbox = row.querySelector('.runtime-xfer-suspended');
          const line = (lineInput?.value || '').trim();
          if (!line) return;
          current.push({
            line,
            color: colorInput?.value || '#808080',
            exitTransfer: !!(exitCheckbox && exitCheckbox.checked),
            suspended: !!(suspendedCheckbox && suspendedCheckbox.checked)
          });
        });
      }
      current.push({ line: '', color: '#808080', exitTransfer: false, suspended: false });
      renderRuntimeStationXfers(current);
    });

    function renderRuntimeStationList() {
      const editor = document.getElementById('runtime-station-editor');
      const listEl = document.getElementById('runtime-station-list');
      if (!editor || !listEl) return;
      
      if (!Array.isArray(runtimeStations) || runtimeStations.length === 0) {
        editor.style.display = 'none';
        listEl.innerHTML = '<div class="empty-state" style="padding:12px;">æš‚æ— ç«™ç‚¹æ•°æ®ï¼Œè¯·å…ˆä» JSON å¯¼å…¥æˆ–ä¸Šä¼ æ–‡ä»¶ã€‚</div>';
        return;
      }
      
      editor.style.display = 'block';
      listEl.innerHTML = '';
      
      runtimeStations.forEach((st, idx) => {
        const item = document.createElement('div');
        item.className = 'station-item';
        
        const skipTag = st.skip ? '<span class="station-tag" style="background:#ffe6e6;color:#d63031;">è·³ç«™</span>' : '';
        const dockTag = st.dock === 'up'
          ? '<span class="station-tag" style="background:#e3f2fd;color:#2980b9;">ä»…ä¸Šè¡Œ</span>'
          : st.dock === 'down'
          ? '<span class="station-tag" style="background:#e8f8f5;color:#16a085;">ä»…ä¸‹è¡Œ</span>'
          : '';
        
        item.innerHTML = `
          <div class="station-main">
            <div class="station-index">[${idx + 1}]</div>
            <div class="station-names">
              <span class="station-name-cn">${st.name || '(æœªå‘½å)'}</span>
              <span class="station-name-en">${st.en || ''}</span>
              <div class="station-tags">
                ${dockTag}
                ${skipTag}
              </div>
            </div>
          </div>
          <div class="station-actions">
            <button class="btn btn-secondary btn-small" data-action="edit">ç¼–è¾‘</button>
            <button class="btn btn-secondary btn-small" data-action="up">ä¸Šç§»</button>
            <button class="btn btn-secondary btn-small" data-action="down">ä¸‹ç§»</button>
            <button class="btn btn-danger btn-small" data-action="delete">åˆ é™¤</button>
          </div>
        `;
        
        item.querySelectorAll('.station-actions button').forEach(btn => {
          btn.addEventListener('click', () => {
            const action = btn.getAttribute('data-action');
            if (action === 'edit') {
              openRuntimeStationModal(idx);
            } else if (action === 'up' && idx > 0) {
              const tmp = runtimeStations[idx - 1];
              runtimeStations[idx - 1] = runtimeStations[idx];
              runtimeStations[idx] = tmp;
              renderRuntimeStationList();
            } else if (action === 'down' && idx < runtimeStations.length - 1) {
              const tmp = runtimeStations[idx + 1];
              runtimeStations[idx + 1] = runtimeStations[idx];
              runtimeStations[idx] = tmp;
              renderRuntimeStationList();
            } else if (action === 'delete') {
              if (confirm(`ç¡®å®šè¦åˆ é™¤ç«™ç‚¹ "${st.name || '(æœªå‘½å)'}" å—ï¼Ÿ`)) {
                runtimeStations.splice(idx, 1);
                renderRuntimeStationList();
              }
            }
          });
        });
        
        listEl.appendChild(item);
      });
    }

    function loadRuntimeStationsFromJson() {
      const editor = document.getElementById('runtime-station-editor');
      if (!editor) return;
      const text = document.getElementById('runtime-line-json').value.trim();
      if (!text) {
        runtimeStations = [];
        renderRuntimeStationList();
        return;
      }
      try {
        const json = JSON.parse(text);
        const stations = Array.isArray(json?.stations) ? json.stations : [];
        runtimeStations = stations.map(st => ({
          name: st.name || '',
          en: st.en || '',
          skip: !!st.skip,
          dock: st.dock || st.platform || undefined,
          xfer: Array.isArray(st.xfer) ? st.xfer : [],
          expressStop: st.expressStop !== false
        }));
        renderRuntimeStationList();
      } catch (e) {
        console.warn('è§£æè¿æ§çº¿è·¯ JSON å¤±è´¥ï¼Œæ— æ³•åŠ è½½ç«™ç‚¹ç¼–è¾‘å™¨:', e);
        runtimeStations = [];
        renderRuntimeStationList();
      }
    }

    function syncRuntimeStationsToJson() {
      const text = document.getElementById('runtime-line-json').value.trim();
      let obj;
      try {
        obj = text ? JSON.parse(text) : {};
      } catch {
        obj = {};
      }
      if (!obj.meta) obj.meta = {};
      if (!obj.stations || !Array.isArray(obj.stations)) obj.stations = [];
      obj.stations = runtimeStations.map(st => ({
        name: st.name || '',
        en: st.en || '',
        skip: !!st.skip,
        dock: st.dock || undefined,
        xfer: Array.isArray(st.xfer) ? st.xfer : [],
        expressStop: st.expressStop !== false
      }));
      document.getElementById('runtime-line-json').value = JSON.stringify(obj, null, 2);
    }

    document.getElementById('btn-runtime-add-station').addEventListener('click', () => {
      openRuntimeStationModal(-1);
    });

    document.getElementById('btn-runtime-sync-json').addEventListener('click', () => {
      syncRuntimeStationsToJson();
      showStatus('runtime-status', 'å·²å°†ç«™ç‚¹åˆ—è¡¨åŒæ­¥å› JSON æ–‡æœ¬æ¡†', 'success');
    });

    window.loadRuntimeLine = async (lineName) => {
      document.getElementById('runtime-line-name').value = lineName;
      // åˆ‡æ¢åˆ°è¿æ§çº¿è·¯ä¾§è¾¹æ 
      const runtimeSidebarBtn = document.querySelector('.sidebar-item[data-section="runtime"]');
      if (runtimeSidebarBtn) runtimeSidebarBtn.click();
      
      try {
        const data = await callApi('GET', `/runtime/lines/${encodeURIComponent(lineName)}`);
        document.getElementById('runtime-line-json').value = JSON.stringify(data.line || data, null, 2);
        showStatus('runtime-status', 'ä¸‹è½½æˆåŠŸ', 'success');
        loadRuntimeStationsFromJson();
      } catch (e) {
        showStatus('runtime-status', `ä¸‹è½½å¤±è´¥ï¼š${e.message}`, 'error');
      }
    };

    window.deleteRuntimeLine = async (lineName) => {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤è¿æ§çº¿è·¯ "${lineName}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
        return;
      }
      try {
        await callApi('DELETE', `/runtime/lines/${encodeURIComponent(lineName)}`);
        showStatus('runtime-status', 'åˆ é™¤æˆåŠŸ', 'success');
        document.getElementById('btn-list-runtime').click();
      } catch (e) {
        showStatus('runtime-status', `åˆ é™¤å¤±è´¥ï¼š${e.message}`, 'error');
      }
    };
    
    document.getElementById('btn-get-runtime').addEventListener('click', async () => {
      const lineName = document.getElementById('runtime-line-name').value.trim();
      if (!lineName) {
        showStatus('runtime-status', 'è¯·å…ˆå¡«å†™çº¿è·¯åç§°', 'error');
        return;
      }
      
      try {
        const data = await callApi('GET', `/runtime/lines/${encodeURIComponent(lineName)}`);
        document.getElementById('runtime-line-json').value = JSON.stringify(data.line || data, null, 2);
        showStatus('runtime-status', 'ä¸‹è½½æˆåŠŸ', 'success');
        loadRuntimeStationsFromJson();
      } catch (e) {
        showStatus('runtime-status', `ä¸‹è½½å¤±è´¥ï¼š${e.message}`, 'error');
      }
    });
    
    // æ‰‹åŠ¨ä¸Šä¼ ï¼ˆä» JSON æ–‡æœ¬æ¡†ï¼‰
    document.getElementById('runtime-line-json').addEventListener('change', () => {
      // å¦‚æœ JSON æ–‡æœ¬æ¡†æœ‰å†…å®¹ï¼Œå°è¯•è‡ªåŠ¨æå–çº¿è·¯åç§°
      const jsonText = document.getElementById('runtime-line-json').value.trim();
      if (jsonText && !document.getElementById('runtime-line-name').value.trim()) {
        try {
          const json = JSON.parse(jsonText);
          if (json.meta && json.meta.lineName) {
            document.getElementById('runtime-line-name').value = json.meta.lineName;
          }
        } catch (e) {
          // å¿½ç•¥è§£æé”™è¯¯
        }
      }
      // æ–‡æœ¬å˜åŒ–æ—¶å°è¯•æ›´æ–°ç«™ç‚¹åˆ—è¡¨
      loadRuntimeStationsFromJson();
    });

    // åˆå§‹åŒ–æ—¶ï¼Œå¦‚ JSON ä¸­å·²æœ‰æ•°æ®ï¼Œä¹Ÿå°è¯•åŠ è½½ç«™ç‚¹ç¼–è¾‘å™¨
    (() => {
      const text = document.getElementById('runtime-line-json').value.trim();
      if (text) {
        loadRuntimeStationsFromJson();
      }
    })();
    
    // æ·»åŠ æ‰‹åŠ¨ä¸Šä¼ æŒ‰é’®ï¼ˆå¯é€‰ï¼Œç”¨äºç¼–è¾‘å·²æœ‰çº¿è·¯ï¼‰
    const manualUploadBtn = document.createElement('button');
    manualUploadBtn.className = 'btn btn-primary';
    manualUploadBtn.innerHTML = '<i class="fas fa-upload"></i> æ‰‹åŠ¨ä¸Šä¼ ï¼ˆä»æ–‡æœ¬æ¡†ï¼‰';
    manualUploadBtn.style.marginTop = '8px';
    manualUploadBtn.addEventListener('click', async () => {
      const lineName = document.getElementById('runtime-line-name').value.trim();
      const jsonText = document.getElementById('runtime-line-json').value.trim();
      
      if (!lineName || !jsonText) {
        showStatus('runtime-status', 'è¯·å¡«å†™çº¿è·¯åç§°å’Œ JSON æ•°æ®', 'error');
        return;
      }
      
      try {
        const json = JSON.parse(jsonText);
        if (!json.meta) json.meta = {};
        json.meta.lineName = lineName;
        
        await callApi('PUT', `/runtime/lines/${encodeURIComponent(lineName)}`, json);
        showStatus('runtime-status', 'ä¸Šä¼ æˆåŠŸ', 'success');
        document.getElementById('btn-list-runtime').click();
      } catch (e) {
        showStatus('runtime-status', `ä¸Šä¼ å¤±è´¥ï¼š${e.message}`, 'error');
      }
    });
    
    // å°†æ‰‹åŠ¨ä¸Šä¼ æŒ‰é’®æ’å…¥åˆ° JSON æ–‡æœ¬æ¡†ä¸‹æ–¹
    const runtimeJsonField = document.getElementById('runtime-line-json').parentElement;
    runtimeJsonField.appendChild(manualUploadBtn);
    
    document.getElementById('btn-del-runtime').addEventListener('click', async () => {
      const lineName = document.getElementById('runtime-line-name').value.trim();
      if (!lineName) {
        showStatus('runtime-status', 'è¯·å…ˆå¡«å†™çº¿è·¯åç§°', 'error');
        return;
      }
      
      if (!confirm(`ç¡®å®šè¦åˆ é™¤è¿æ§çº¿è·¯ "${lineName}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
        return;
      }
      
      try {
        await callApi('DELETE', `/runtime/lines/${encodeURIComponent(lineName)}`);
        showStatus('runtime-status', 'åˆ é™¤æˆåŠŸ', 'success');
        document.getElementById('runtime-line-name').value = '';
        document.getElementById('runtime-line-json').value = '';
        document.getElementById('btn-list-runtime').click();
      } catch (e) {
        showStatus('runtime-status', `åˆ é™¤å¤±è´¥ï¼š${e.message}`, 'error');
      }
    });
    
    // å½©è›‹é…ç½® - items åˆ—è¡¨ï¼šæ¯é¡¹ idã€nameã€stations[]ã€messages[]
    let easterItems = [];

    function generateEasterId() {
      return 'egg-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2, 6);
    }

    function normalizeEasterConfig(cfg) {
      if (Array.isArray(cfg.items) && cfg.items.length > 0) {
        return cfg.items.map((it) => {
          const o = {
            id: it.id != null ? String(it.id) : generateEasterId(),
            name: it.name != null ? String(it.name) : '',
            enabled: it.enabled !== false,
            stations: Array.isArray(it.stations) ? it.stations.map((s) => String(s).trim()).filter(Boolean) : [],
            messages: Array.isArray(it.messages) ? it.messages.map((m) => String(m).trim()).filter(Boolean) : []
          };
          if (it.date != null && String(it.date).trim()) o.date = String(it.date).trim().slice(0, 8);
          return o;
        });
      }
      const stations = Array.isArray(cfg.stations) ? cfg.stations.map((s) => String(s).trim()).filter(Boolean) : [];
      const messages = Array.isArray(cfg.messages) ? cfg.messages.map((m) => String(m).trim()).filter(Boolean) : [];
      if (stations.length || messages.length) {
        return [{ id: 'default', name: 'é»˜è®¤', enabled: true, stations, messages }];
      }
      return [];
    }

    function renderEasterEggsList() {
      const tbody = document.getElementById('easter-eggs-list-tbody');
      if (easterItems.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><i class="fas fa-inbox"></i><div>æš‚æ— æ•°æ®ï¼Œè¯·ä»æœåŠ¡å™¨åŠ è½½æˆ–ä¸‹æ–¹ç¼–è¾‘åä¿å­˜</div></td></tr>';
        return;
      }
      tbody.innerHTML = easterItems.map((it, i) => {
        const idEsc = escapeHtml(it.id || '-');
        const nameEsc = escapeHtml(it.name || '-');
        const enabled = it.enabled !== false;
        const stationsCount = (it.stations && it.stations.length) || 0;
        const messagesCount = (it.messages && it.messages.length) || 0;
        return `
          <tr>
            <td>${i + 1}</td>
            <td><code>${idEsc}</code></td>
            <td><strong>${nameEsc}</strong></td>
            <td><span class="badge badge-info">${stationsCount}</span></td>
            <td><span class="badge badge-info">${messagesCount}</span></td>
            <td>
              <button type="button" class="btn btn-secondary btn-small" data-action="edit-easter" data-index="${i}">
                <i class="fas fa-edit"></i> ç¼–è¾‘
              </button>
              <button type="button" class="btn btn-danger btn-small btn-small-spaced" data-action="delete-easter" data-index="${i}">
                <i class="fas fa-trash"></i> åˆ é™¤
              </button>
            </td>
            <td style="text-align:right;">
              <label class="se-toggle-wrap">
                <input type="checkbox" class="se-toggle-input" data-role="toggle-easter-enabled" data-index="${i}" ${enabled ? 'checked' : ''} />
                <span class="se-toggle-track"></span>
                <span class="se-toggle-thumb"></span>
              </label>
            </td>
          </tr>
        `;
      }).join('');
    }

    function syncEasterJsonFromList() {
      document.getElementById('easter-eggs-json').value = JSON.stringify({
        enabled: document.getElementById('easter-eggs-enabled').checked,
        items: easterItems.map((it) => {
          const o = { id: it.id, name: it.name, enabled: it.enabled !== false, stations: it.stations || [], messages: it.messages || [] };
          if (it.date) o.date = String(it.date).slice(0, 8);
          return o;
        })
      }, null, 2);
    }

    async function loadEasterEggsFromServer() {
      const tbody = document.getElementById('easter-eggs-list-tbody');
      tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><div class="loading"></div> åŠ è½½ä¸­...</td></tr>';
      try {
        const data = await callApi('GET', '/easter-eggs');
        const cfg = data.config || data;
        document.getElementById('easter-eggs-enabled').checked = !!cfg.enabled;
        easterItems = normalizeEasterConfig(cfg);
        syncEasterJsonFromList();
        renderEasterEggsList();
        showStatus('easter-eggs-status', 'åŠ è½½æˆåŠŸ', 'success');
      } catch (e) {
        tbody.innerHTML = `<tr><td colspan="6" class="empty-state"><i class="fas fa-exclamation-triangle"></i><div>åŠ è½½å¤±è´¥ï¼š${e.message}</div></td></tr>`;
        showStatus('easter-eggs-status', `åŠ è½½å¤±è´¥ï¼š${e.message}`, 'error');
      }
    }

    document.getElementById('btn-list-easter-eggs').addEventListener('click', loadEasterEggsFromServer);

    document.getElementById('btn-add-easter-egg').addEventListener('click', () => {
      openEasterEggEditModal(null);
    });

    const easterTbodyEl = document.getElementById('easter-eggs-list-tbody');

    easterTbodyEl.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-action="edit-easter"], [data-action="delete-easter"]');
      if (!btn) return;
      const index = parseInt(btn.getAttribute('data-index'), 10);
      if (Number.isNaN(index) || index < 0) return;
      if (btn.getAttribute('data-action') === 'delete-easter') {
        if (!confirm(`ç¡®å®šè¦åˆ é™¤ã€Œ${easterItems[index].name || easterItems[index].id}ã€å—ï¼Ÿ`)) return;
        easterItems.splice(index, 1);
        syncEasterJsonFromList();
        renderEasterEggsList();
        showStatus('easter-eggs-status', 'å·²åˆ é™¤', 'success');
      } else {
        openEasterEggEditModal(index);
      }
    });

    easterTbodyEl.addEventListener('change', (e) => {
      const input = e.target.closest('[data-role="toggle-easter-enabled"]');
      if (!input) return;
      const index = parseInt(input.getAttribute('data-index'), 10);
      if (Number.isNaN(index) || !easterItems[index]) return;
      easterItems[index].enabled = input.checked;
      showStatus('easter-eggs-status', 'å·²æ›´æ–°å¯ç”¨çŠ¶æ€ï¼Œè®°å¾—ç‚¹å‡»ã€Œä¿å­˜åˆ°æœåŠ¡å™¨ã€', 'info');
    });

    let easterEggEditIndex = null;

    function openEasterEggEditModal(index) {
      easterEggEditIndex = index;
      document.getElementById('easter-egg-edit-modal-title').textContent = index === null ? 'æ·»åŠ å½©è›‹' : 'ç¼–è¾‘å½©è›‹';
      if (index === null) {
        document.getElementById('easter-egg-edit-id').value = generateEasterId();
        document.getElementById('easter-egg-edit-name').value = '';
        document.getElementById('easter-egg-edit-enabled').checked = true;
        document.getElementById('easter-egg-edit-stations').value = '';
        document.getElementById('easter-egg-edit-messages').value = '';
        document.getElementById('easter-egg-edit-date').value = '';
      } else {
        const it = easterItems[index];
        document.getElementById('easter-egg-edit-id').value = it.id || '';
        document.getElementById('easter-egg-edit-name').value = it.name || '';
        document.getElementById('easter-egg-edit-enabled').checked = it.enabled !== false;
        document.getElementById('easter-egg-edit-stations').value = (it.stations || []).join('\n');
        document.getElementById('easter-egg-edit-messages').value = (it.messages || []).join('\n');
        const dateYyyyMMdd = it.date ? String(it.date).trim().slice(0, 8) : '';
        document.getElementById('easter-egg-edit-date').value = dateYyyyMMdd.length === 8
          ? dateYyyyMMdd.slice(0, 4) + '-' + dateYyyyMMdd.slice(4, 6) + '-' + dateYyyyMMdd.slice(6, 8)
          : '';
      }
      document.getElementById('easter-egg-edit-modal').classList.add('active');
    }

    function closeEasterEggEditModal() {
      document.getElementById('easter-egg-edit-modal').classList.remove('active');
      easterEggEditIndex = null;
    }

    document.getElementById('easter-egg-edit-modal-close').addEventListener('click', closeEasterEggEditModal);
    document.getElementById('easter-egg-edit-cancel').addEventListener('click', closeEasterEggEditModal);

    document.getElementById('easter-egg-edit-save').addEventListener('click', () => {
      const id = document.getElementById('easter-egg-edit-id').value.trim() || generateEasterId();
      const name = document.getElementById('easter-egg-edit-name').value.trim();
      const enabled = document.getElementById('easter-egg-edit-enabled').checked;
      const stationsText = document.getElementById('easter-egg-edit-stations').value || '';
      const messagesText = document.getElementById('easter-egg-edit-messages').value || '';
      const stations = stationsText.split(/\n/).map((s) => s.trim()).filter(Boolean);
      const messages = messagesText.split(/\n/).map((m) => m.trim()).filter(Boolean);
      const dateInput = document.getElementById('easter-egg-edit-date').value.trim();
      const dateYyyyMMdd = dateInput ? dateInput.replace(/-/g, '') : '';
      const item = { id, name, enabled, stations, messages };
      if (dateYyyyMMdd.length === 8) item.date = dateYyyyMMdd;
      if (easterEggEditIndex === null) {
        easterItems.push(item);
      } else {
        easterItems[easterEggEditIndex] = item;
      }
      syncEasterJsonFromList();
      renderEasterEggsList();
      closeEasterEggEditModal();
      showStatus('easter-eggs-status', 'å·²æ›´æ–°åˆ—è¡¨ï¼Œè¯·ç‚¹å‡»ã€Œä¿å­˜åˆ°æœåŠ¡å™¨ã€æŒä¹…åŒ–', 'success');
    });

    document.getElementById('btn-get-easter-eggs').addEventListener('click', loadEasterEggsFromServer);

    document.getElementById('easter-eggs-sync-from-json').addEventListener('click', () => {
      const jsonText = document.getElementById('easter-eggs-json').value.trim();
      if (!jsonText) {
        showStatus('easter-eggs-status', 'JSON ä¸ºç©º', 'error');
        return;
      }
      try {
        const cfg = JSON.parse(jsonText);
        if (cfg.enabled !== undefined) document.getElementById('easter-eggs-enabled').checked = !!cfg.enabled;
        easterItems = normalizeEasterConfig(cfg);
        syncEasterJsonFromList();
        renderEasterEggsList();
        showStatus('easter-eggs-status', 'å·²ä» JSON åŒæ­¥åˆ°åˆ—è¡¨', 'success');
      } catch (e) {
        showStatus('easter-eggs-status', `JSON è§£æå¤±è´¥ï¼š${e.message}`, 'error');
      }
    });

    document.getElementById('easter-eggs-file-input').addEventListener('change', async function () {
      const files = this.files;
      if (!files || files.length === 0) return;
      let config = { enabled: document.getElementById('easter-eggs-enabled').checked, items: [] };
      try {
        const jsonText = document.getElementById('easter-eggs-json').value.trim();
        if (jsonText) {
          const parsed = JSON.parse(jsonText);
          config.items = normalizeEasterConfig(parsed);
        }
      } catch (e) {
        showStatus('easter-eggs-status', 'å½“å‰ JSON æ— æ•ˆï¼Œå°†åœ¨æ­¤åŸºç¡€ä¸Šè¿½åŠ ', 'info');
      }
      for (let i = 0; i < files.length; i++) {
        const text = await files[i].text();
        try {
          const parsed = JSON.parse(text);
          if (parsed && typeof parsed === 'object') {
            const item = {
              id: parsed.id != null ? String(parsed.id) : generateEasterId(),
              name: parsed.name != null ? String(parsed.name) : '',
              enabled: parsed.enabled !== false,
              stations: Array.isArray(parsed.stations) ? parsed.stations.map((s) => String(s).trim()).filter(Boolean) : (parsed.station != null ? [String(parsed.station)] : []),
              messages: Array.isArray(parsed.messages) ? parsed.messages.map((m) => String(m).trim()).filter(Boolean) : (parsed.message != null ? [String(parsed.message)] : [])
            };
            if (parsed.date != null && String(parsed.date).trim()) item.date = String(parsed.date).trim().slice(0, 8);
            config.items.push(item);
          }
        } catch (_) {
          config.items.push({ id: generateEasterId(), name: '', stations: [], messages: [text.trim()] });
        }
      }
      document.getElementById('easter-eggs-enabled').checked = config.enabled;
      easterItems = config.items;
      syncEasterJsonFromList();
      renderEasterEggsList();
      showStatus('easter-eggs-status', `å·²å¯¼å…¥ ${files.length} ä¸ªæ–‡ä»¶`, 'success');
      document.getElementById('easter-eggs-file-input').value = '';
    });

    document.getElementById('btn-put-easter-eggs').addEventListener('click', async () => {
      try {
        const payload = {
          enabled: document.getElementById('easter-eggs-enabled').checked,
          items: easterItems.map((it) => {
            const o = { id: it.id, name: it.name, enabled: it.enabled !== false, stations: it.stations || [], messages: it.messages || [] };
            if (it.date) o.date = String(it.date).slice(0, 8);
            return o;
          })
        };
        await callApi('PUT', '/easter-eggs', payload);
        syncEasterJsonFromList();
        renderEasterEggsList();
        showStatus('easter-eggs-status', 'ä¿å­˜æˆåŠŸ', 'success');
      } catch (e) {
        showStatus('easter-eggs-status', `ä¿å­˜å¤±è´¥ï¼š${e.message}`, 'error');
      }
    });

    // è¾…åŠ©å‡½æ•°ï¼šè§£ææ—¶é—´å­—ç¬¦ä¸²ï¼ˆISO 8601ï¼‰ä¸º datetime-local æ ¼å¼
    function isoToLocalDateTime(isoString) {
      if (!isoString) return '';
      try {
        const date = new Date(isoString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}`;
      } catch (e) {
        return '';
      }
    }
    
    // è¾…åŠ©å‡½æ•°ï¼šå°† datetime-local æ ¼å¼è½¬æ¢ä¸º ISO 8601
    function localDateTimeToIso(localDateTime) {
      if (!localDateTime) return null;
      try {
        const date = new Date(localDateTime);
        return date.toISOString();
      } catch (e) {
        return null;
      }
    }
    
    // è¾…åŠ©å‡½æ•°ï¼šè§£ææ–‡æœ¬åŒºåŸŸå†…å®¹ï¼ˆæ”¯æŒæ¢è¡Œå’Œé€—å·åˆ†éš”ï¼‰
    function parseTextArea(text) {
      if (!text || !text.trim()) return null;
      const lines = text.split(/[\n,ï¼Œ]/).map(s => s.trim()).filter(s => s);
      return lines.length > 0 ? lines : null;
    }
    
    // è¾…åŠ©å‡½æ•°ï¼šå°†æ•°ç»„æ ¼å¼åŒ–ä¸ºæ–‡æœ¬åŒºåŸŸå†…å®¹ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰
    function formatTextArea(arr) {
      if (!arr || !Array.isArray(arr) || arr.length === 0) return '';
      return arr.join('\n');
    }

    // ç”Ÿæˆå…¬å‘Šç¼–å·ï¼ˆ32 ä½åå…­è¿›åˆ¶ï¼‰
    function generateAnnouncementId() {
      const bytes = new Uint8Array(16);
      crypto.getRandomValues(bytes);
      return Array.from(bytes).map((b) => b.toString(16).padStart(2, '0')).join('');
    }

    // å¯åŠ¨å…¬å‘Šé…ç½® - åˆ—è¡¨å¢åˆ æŸ¥æ”¹
    let startupNotices = [];
    let startupNoticeEditIndex = -1;

    function renderStartupNotices() {
      const tbody = document.getElementById('startup-notices-tbody');
      tbody.innerHTML = '';
      if (startupNotices.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><i class="fas fa-inbox"></i> æš‚æ— å…¬å‘Šï¼Œç‚¹å‡»ã€Œæ·»åŠ å…¬å‘Šã€</td></tr>';
        return;
      }
      startupNotices.forEach((n, i) => {
        const enabled = n.enabled !== false;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i + 1}</td>
          <td>${escapeHtml(n.title || '')}</td>
          <td>${n.mode === 'oncePerDay' ? 'æ¯å¤©ä¸€æ¬¡' : 'æ¯æ¬¡è¿è¡Œ'}</td>
          <td>
            <button type="button" class="btn btn-secondary btn-sm startup-edit-notice" data-i="${i}"><i class="fas fa-edit"></i> ç¼–è¾‘</button>
            <button type="button" class="btn btn-danger btn-sm startup-del-notice" data-i="${i}"><i class="fas fa-trash"></i> åˆ é™¤</button>
          </td>
          <td style="text-align:right;">
            <label class="se-toggle-wrap">
              <input type="checkbox" class="se-toggle-input" data-role="toggle-startup-enabled" data-index="${i}" ${enabled ? 'checked' : ''} />
              <span class="se-toggle-track"></span>
              <span class="se-toggle-thumb"></span>
            </label>
          </td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('.startup-edit-notice').forEach((btn) => {
        btn.addEventListener('click', function () { openStartupNoticeModal(parseInt(this.dataset.i, 10)); });
      });
      tbody.querySelectorAll('.startup-del-notice').forEach((btn) => {
        btn.addEventListener('click', function () {
          startupNotices.splice(parseInt(this.dataset.i, 10), 1);
          renderStartupNotices();
        });
      });
    }

    function openStartupNoticeModal(index) {
      startupNoticeEditIndex = index;
      const modal = document.getElementById('startup-notice-modal');
      document.getElementById('startup-notice-modal-title').textContent = index >= 0 ? 'ç¼–è¾‘å…¬å‘Š' : 'æ·»åŠ å…¬å‘Š';
      const n = index >= 0 ? startupNotices[index] : {};
      document.getElementById('startup-modal-id').value = n.id || '';
      document.getElementById('startup-modal-mode').value = n.mode === 'oncePerDay' ? 'oncePerDay' : 'everyRun';
      document.getElementById('startup-modal-enabled').checked = n.enabled !== false;
      document.getElementById('startup-modal-title').value = n.title || '';
      document.getElementById('startup-modal-message').value = n.message || '';
      document.getElementById('startup-modal-start-time').value = isoToLocalDateTime(n.startTime);
      document.getElementById('startup-modal-end-time').value = isoToLocalDateTime(n.endTime);
      document.getElementById('startup-modal-allowed-countries').value = formatTextArea(n.allowedCountries);
      document.getElementById('startup-modal-blocked-countries').value = formatTextArea(n.blockedCountries);
      document.getElementById('startup-modal-allowed-cities').value = formatTextArea(n.allowedCities);
      document.getElementById('startup-modal-blocked-cities').value = formatTextArea(n.blockedCities);
      modal.style.display = 'flex';
    }

    function closeStartupNoticeModal() {
      document.getElementById('startup-notice-modal').style.display = 'none';
      startupNoticeEditIndex = -1;
    }

    document.getElementById('startup-modal-generate-id').addEventListener('click', () => {
      document.getElementById('startup-modal-id').value = generateAnnouncementId();
    });
    document.getElementById('startup-add-notice').addEventListener('click', () => { startupNoticeEditIndex = -1; openStartupNoticeModal(-1); });
    document.getElementById('startup-notice-modal-close').addEventListener('click', closeStartupNoticeModal);
    document.getElementById('startup-notice-modal-cancel').addEventListener('click', closeStartupNoticeModal);
    document.getElementById('startup-notice-modal-save').addEventListener('click', () => {
      const n = {
        id: document.getElementById('startup-modal-id').value.trim() || null,
        mode: document.getElementById('startup-modal-mode').value,
        enabled: document.getElementById('startup-modal-enabled').checked,
        title: document.getElementById('startup-modal-title').value,
        message: document.getElementById('startup-modal-message').value,
        startTime: localDateTimeToIso(document.getElementById('startup-modal-start-time').value),
        endTime: localDateTimeToIso(document.getElementById('startup-modal-end-time').value),
        allowedCountries: parseTextArea(document.getElementById('startup-modal-allowed-countries').value),
        blockedCountries: parseTextArea(document.getElementById('startup-modal-blocked-countries').value),
        allowedCities: parseTextArea(document.getElementById('startup-modal-allowed-cities').value),
        blockedCities: parseTextArea(document.getElementById('startup-modal-blocked-cities').value)
      };
      if (startupNoticeEditIndex >= 0) {
        startupNotices[startupNoticeEditIndex] = n;
      } else {
        startupNotices.push(n);
      }
      renderStartupNotices();
      closeStartupNoticeModal();
    });

    document.getElementById('startup-notices-tbody').addEventListener('change', (e) => {
      const input = e.target.closest('[data-role="toggle-startup-enabled"]');
      if (!input) return;
      const index = parseInt(input.getAttribute('data-index'), 10);
      if (Number.isNaN(index) || !startupNotices[index]) return;
      startupNotices[index].enabled = input.checked;
      showStatus('startup-status', 'å·²æ›´æ–°å¯ç”¨çŠ¶æ€ï¼Œè®°å¾—ç‚¹å‡»ã€Œä¿å­˜é…ç½®ã€', 'info');
    });

    document.getElementById('btn-get-startup').addEventListener('click', async () => {
      try {
        const data = await callApi('GET', '/startup-notice?t=' + Date.now());
        const cfg = data.config || data;
        document.getElementById('startup-enabled').checked = !!cfg.enabled;
        startupNotices = Array.isArray(cfg.notices) ? cfg.notices.map((n) => ({ ...n, enabled: n.enabled !== false })) : [];
        renderStartupNotices();
        showStatus('startup-status', 'åŠ è½½æˆåŠŸ', 'success');
      } catch (e) {
        showStatus('startup-status', `åŠ è½½å¤±è´¥ï¼š${e.message}`, 'error');
      }
    });

    document.getElementById('btn-save-startup').addEventListener('click', async () => {
      try {
        await callApi('PUT', '/startup-notice', {
          enabled: document.getElementById('startup-enabled').checked,
          notices: startupNotices
        });
        showStatus('startup-status', 'ä¿å­˜æˆåŠŸ', 'success');
      } catch (e) {
        showStatus('startup-status', `ä¿å­˜å¤±è´¥ï¼š${e.message}`, 'error');
      }
    });

    // ==================== æ˜¾ç¤ºç«¯åŠŸèƒ½å¼€å…³ ====================
    // å†…å­˜ä¸­çš„åœ°ç†ä½ç½®åˆ—è¡¨
    let displayFlagsAllowedCountries = [];
    let displayFlagsBlockedCountries = [];
    let displayFlagsAllowedCities = [];
    let displayFlagsBlockedCities = [];

    // æ¸²æŸ“åˆ—è¡¨çš„é€šç”¨å‡½æ•°
    function renderTagList(containerId, items) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      if (!items || items.length === 0) {
        container.innerHTML = '<div style="font-size:12px; color:#999;">å½“å‰åˆ—è¡¨ä¸ºç©º</div>';
        return;
      }
      items.forEach((item, index) => {
        const chip = document.createElement('span');
        chip.className = 'tag-chip';
        chip.textContent = item;
        const del = document.createElement('button');
        del.type = 'button';
        del.className = 'tag-chip-del';
        del.textContent = 'Ã—';
        del.addEventListener('click', () => {
          items.splice(index, 1);
          renderAllDisplayGeoLists();
        });
        chip.appendChild(del);
        container.appendChild(chip);
      });
    }

    function renderAllDisplayGeoLists() {
      renderTagList('display-allowed-countries-list', displayFlagsAllowedCountries);
      renderTagList('display-blocked-countries-list', displayFlagsBlockedCountries);
      renderTagList('display-allowed-cities-list', displayFlagsAllowedCities);
      renderTagList('display-blocked-cities-list', displayFlagsBlockedCities);
    }

    // ç®€å•çš„â€œæ·»åŠ â€åŠ©æ‰‹
    function addItemToList(inputId, listRef) {
      const el = document.getElementById(inputId);
      const val = (el.value || '').trim();
      if (!val) return;
      if (!listRef.includes(val)) {
        listRef.push(val);
        renderAllDisplayGeoLists();
      }
      el.value = '';
    }

    document.getElementById('btn-add-display-allowed-country').addEventListener('click', () => {
      addItemToList('display-allowed-country-input', displayFlagsAllowedCountries);
    });
    document.getElementById('btn-add-display-blocked-country').addEventListener('click', () => {
      addItemToList('display-blocked-country-input', displayFlagsBlockedCountries);
    });
    document.getElementById('btn-add-display-allowed-city').addEventListener('click', () => {
      addItemToList('display-allowed-city-input', displayFlagsAllowedCities);
    });
    document.getElementById('btn-add-display-blocked-city').addEventListener('click', () => {
      addItemToList('display-blocked-city-input', displayFlagsBlockedCities);
    });

    // æ˜¾ç¤ºç«¯åŠŸèƒ½å¼€å…³
    document.getElementById('btn-get-display-flags').addEventListener('click', async () => {
      try {
        const data = await callApi('GET', '/display-flags');
        const cfg = data.config || data;

        // å…¨å±€ç³»ç»Ÿæ˜¾ç¤ºå¼€å…³
        const val = (typeof cfg.showSystemDisplayOption === 'boolean') ? cfg.showSystemDisplayOption : true;
        document.getElementById('display-show-system').checked = val;

        // æ¯ä¸ªæ˜¾ç¤ºå™¨çš„å¯ç”¨çŠ¶æ€ï¼ˆcheckbox è¦ç”¨ checkedï¼Œä¸è¦ç”¨ valueï¼‰
        const displays = cfg.displays || {};
        const d1 = displays['display-1'] || {};
        const d2 = displays['display-2'] || {};
        const d3 = displays['display-3'] || {};
        document.getElementById('display-1-enabled').checked = d1.enabled === false ? false : true;
        document.getElementById('display-2-enabled').checked = d2.enabled === false ? false : true;
        document.getElementById('display-3-enabled').checked = d3.enabled === false ? false : true;

        // æ—¶é—´èŒƒå›´
        document.getElementById('display-start-time').value = isoToLocalDateTime(cfg.startTime);
        document.getElementById('display-end-time').value = isoToLocalDateTime(cfg.endTime);

        // åœ°ç†ä½ç½®åˆ—è¡¨
        displayFlagsAllowedCountries = Array.isArray(cfg.allowedCountries) ? [...cfg.allowedCountries] : [];
        displayFlagsBlockedCountries = Array.isArray(cfg.blockedCountries) ? [...cfg.blockedCountries] : [];
        displayFlagsAllowedCities    = Array.isArray(cfg.allowedCities)    ? [...cfg.allowedCities]    : [];
        displayFlagsBlockedCities    = Array.isArray(cfg.blockedCities)    ? [...cfg.blockedCities]    : [];
        renderAllDisplayGeoLists();

        showStatus('display-flags-status', 'åŠ è½½æˆåŠŸ', 'success');
      } catch (e) {
        showStatus('display-flags-status', `åŠ è½½å¤±è´¥ï¼š${e.message}`, 'error');
      }
    });

    document.getElementById('btn-save-display-flags').addEventListener('click', async () => {
      const showSystem = document.getElementById('display-show-system').checked;
      const d1Enabled  = document.getElementById('display-1-enabled').checked;
      const d2Enabled  = document.getElementById('display-2-enabled').checked;
      const d3Enabled  = document.getElementById('display-3-enabled').checked;
      const startTime = localDateTimeToIso(document.getElementById('display-start-time').value);
      const endTime = localDateTimeToIso(document.getElementById('display-end-time').value);

      const payload = {
        showSystemDisplayOption: !!showSystem,
        displays: {
          'display-1': { enabled: d1Enabled },
          'display-2': { enabled: d2Enabled },
          'display-3': { enabled: d3Enabled }
        },
        startTime,
        endTime,
        allowedCountries: displayFlagsAllowedCountries,
        blockedCountries: displayFlagsBlockedCountries,
        allowedCities: displayFlagsAllowedCities,
        blockedCities: displayFlagsBlockedCities
      };
      try {
        await callApi('PUT', '/display-flags', payload);
        showStatus('display-flags-status', 'ä¿å­˜æˆåŠŸ', 'success');
      } catch (e) {
        showStatus('display-flags-status', `ä¿å­˜å¤±è´¥ï¼š${e.message}`, 'error');
      }
    });
    
    // æŸ¥è¯¢æŒ‡å®šæ—¥æœŸèŠ‚å‡æ—¥ï¼ˆmxnzp æ¥å£ï¼‰
    document.getElementById('btn-query-holiday-single').addEventListener('click', async () => {
      const dateInput = document.getElementById('holiday-query-date').value;
      if (!dateInput) {
        showStatus('holidays-status', 'è¯·å…ˆé€‰æ‹©æ—¥æœŸ', 'error');
        return;
      }
      const yyyyMMdd = dateInput.replace(/-/g, '');
      const resultEl = document.getElementById('holiday-query-result');
      const wrapEl = document.getElementById('holiday-query-result-wrap');
      try {
        showStatus('holidays-status', 'æŸ¥è¯¢ä¸­...', 'info');
        const data = await callApi('GET', `/holiday/single/${yyyyMMdd}`);
        wrapEl.style.display = 'block';
        if (data.ok && data.data) {
          resultEl.value = JSON.stringify(data.data, null, 2);
          showStatus('holidays-status', 'æŸ¥è¯¢æˆåŠŸ', 'success');
        } else {
          resultEl.value = JSON.stringify({ ok: false, error: data.error || data.msg || 'æœªçŸ¥é”™è¯¯' }, null, 2);
          showStatus('holidays-status', data.error || 'æŸ¥è¯¢å¤±è´¥', 'error');
        }
      } catch (e) {
        wrapEl.style.display = 'block';
        resultEl.value = JSON.stringify({ ok: false, error: e.message }, null, 2);
        showStatus('holidays-status', `æŸ¥è¯¢å¤±è´¥ï¼š${e.message}`, 'error');
      }
    });

    // èŠ‚æ—¥é…ç½® - åˆ—è¡¨æ•°æ®æºï¼ˆä¸è¿æ§çº¿è·¯åˆ—è¡¨åŒæ„ï¼‰
    let holidaysConfig = {};

    function syncHolidaysJsonFromConfig() {
      document.getElementById('holidays-json').value = JSON.stringify(holidaysConfig, null, 2);
    }

    function renderHolidaysList() {
      const tbody = document.getElementById('holidays-tbody');
      const keys = Object.keys(holidaysConfig);
      if (keys.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><i class="fas fa-inbox"></i><div>æš‚æ— æ•°æ®ï¼Œè¯·ä»æœåŠ¡å™¨åŠ è½½æˆ–ä¸‹æ–¹ç¼–è¾‘ JSON åä¿å­˜</div></td></tr>';
        return;
      }
      tbody.innerHTML = keys.map(key => {
        const item = holidaysConfig[key];
        const name = (item && item.name) ? item.name : key;
        const typeDes = (item && item.typeDes) ? item.typeDes : '';
        const enabled = item && item.enabled;
        const dateStart = (item && item.dateStart) ? String(item.dateStart) : '';
        const dateEnd = (item && item.dateEnd) ? String(item.dateEnd) : '';
        const dateStr = dateStart ? (dateEnd && dateEnd !== dateStart ? `${dateStart}ï½${dateEnd}` : dateStart) : '-';
        const keyEsc = key.replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const typeEsc = (typeDes + '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return `
          <tr>
            <td><code>${keyEsc}</code></td>
            <td><strong>${(name + '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</strong></td>
            <td><span class="badge badge-info">${typeEsc || '-'}</span></td>
            <td>${dateStr}</td>
            <td>
              <button type="button" class="btn btn-secondary btn-small" data-action="edit-holiday" data-key="${keyEsc}">
                <i class="fas fa-edit"></i> ç¼–è¾‘
              </button>
              <button type="button" class="btn btn-danger btn-small btn-small-spaced" data-action="delete-holiday" data-key="${keyEsc}">
                <i class="fas fa-trash"></i> åˆ é™¤
              </button>
            </td>
            <td style="text-align:right;">
              <label class="se-toggle-wrap">
                <input type="checkbox" class="se-toggle-input" data-role="toggle-holiday-enabled" data-key="${keyEsc}" ${enabled ? 'checked' : ''} />
                <span class="se-toggle-track"></span>
                <span class="se-toggle-thumb"></span>
              </label>
            </td>
          </tr>
        `;
      }).join('');
    }

    async function loadHolidaysFromServer() {
      const tbody = document.getElementById('holidays-tbody');
      tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><div class="loading"></div> åŠ è½½ä¸­...</td></tr>';
      try {
        const data = await callApi('GET', '/holidays');
        const cfg = data.config || data;
        holidaysConfig = typeof cfg === 'object' && cfg !== null ? { ...cfg } : {};
        syncHolidaysJsonFromConfig();
        renderHolidaysList();
        showStatus('holidays-status', 'åŠ è½½æˆåŠŸ', 'success');
      } catch (e) {
        tbody.innerHTML = `<tr><td colspan="6" class="empty-state"><i class="fas fa-exclamation-triangle"></i><div>åŠ è½½å¤±è´¥ï¼š${e.message}</div></td></tr>`;
        showStatus('holidays-status', `åŠ è½½å¤±è´¥ï¼š${e.message}`, 'error');
      }
    }

    document.getElementById('btn-list-holidays').addEventListener('click', loadHolidaysFromServer);

    document.getElementById('btn-add-holiday').addEventListener('click', () => {
      openHolidayEditModal(null);
    });

    const holidaysTbodyEl = document.getElementById('holidays-tbody');

    holidaysTbodyEl.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-action="edit-holiday"], [data-action="delete-holiday"]');
      if (!btn) return;
      const key = btn.getAttribute('data-key');
      if (!key) return;
      if (btn.getAttribute('data-action') === 'delete-holiday') {
        if (!confirm(`ç¡®å®šè¦åˆ é™¤èŠ‚æ—¥ã€Œ${key}ã€å—ï¼Ÿ`)) return;
        delete holidaysConfig[key];
        syncHolidaysJsonFromConfig();
        renderHolidaysList();
        showStatus('holidays-status', 'å·²åˆ é™¤', 'success');
      } else {
        openHolidayEditModal(key);
      }
    });

    holidaysTbodyEl.addEventListener('change', (e) => {
      const input = e.target.closest('[data-role="toggle-holiday-enabled"]');
      if (!input) return;
      const key = input.getAttribute('data-key');
      if (!key || !holidaysConfig[key]) return;
      holidaysConfig[key].enabled = input.checked;
      syncHolidaysJsonFromConfig();
      showStatus('holidays-status', 'å·²æ›´æ–°å¯ç”¨çŠ¶æ€ï¼Œè®°å¾—ç‚¹å‡»ã€Œä¿å­˜é…ç½®ã€', 'info');
    });

    let holidayEditCurrentKey = null;

    function generateHolidayId() {
      return 'holiday-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2, 6);
    }

    function openHolidayEditModal(key) {
      holidayEditCurrentKey = key;
      const id = key || generateHolidayId();
      document.getElementById('holiday-edit-key').value = id;
      document.getElementById('holiday-edit-modal-title').textContent = key ? 'ç¼–è¾‘èŠ‚æ—¥' : 'æ·»åŠ èŠ‚æ—¥';
      const item = holidaysConfig[key] || {};
      document.getElementById('holiday-edit-name').value = item.name || '';
      document.getElementById('holiday-edit-typeDes').value = item.typeDes || '';
      document.getElementById('holiday-edit-content').value = item.content || '';
      document.getElementById('holiday-edit-enabled').checked = item.enabled !== false;
      if (item.dateStart != null || item.dateEnd != null) {
        const startStr = item.dateStart != null ? String(item.dateStart).slice(0, 8) : '';
        const endStr = item.dateEnd != null ? String(item.dateEnd).slice(0, 8) : '';
        document.getElementById('holiday-edit-dateStart').value = startStr.length === 8 ? startStr.slice(0, 4) + '-' + startStr.slice(4, 6) + '-' + startStr.slice(6, 8) : '';
        document.getElementById('holiday-edit-dateEnd').value = endStr.length === 8 ? endStr.slice(0, 4) + '-' + endStr.slice(4, 6) + '-' + endStr.slice(6, 8) : '';
      } else if (item.date && item.date.month != null && item.date.day != null) {
        const y = new Date().getFullYear();
        const m = String(item.date.month).padStart(2, '0');
        const d = String(item.date.day).padStart(2, '0');
        const dateVal = y + '-' + m + '-' + d;
        document.getElementById('holiday-edit-dateStart').value = dateVal;
        document.getElementById('holiday-edit-dateEnd').value = dateVal;
      } else {
        document.getElementById('holiday-edit-dateStart').value = '';
        document.getElementById('holiday-edit-dateEnd').value = '';
      }
      document.getElementById('holiday-edit-modal').classList.add('active');
    }

    function closeHolidayEditModal() {
      document.getElementById('holiday-edit-modal').classList.remove('active');
      holidayEditCurrentKey = null;
    }

    document.getElementById('holiday-edit-modal-close').addEventListener('click', closeHolidayEditModal);
    document.getElementById('holiday-edit-cancel').addEventListener('click', closeHolidayEditModal);

    document.getElementById('holiday-edit-save').addEventListener('click', () => {
      const newKey = document.getElementById('holiday-edit-key').value.trim();
      if (!newKey) {
        showStatus('holidays-status', 'ID æœªç”Ÿæˆï¼Œè¯·é‡è¯•', 'error');
        return;
      }
      const name = document.getElementById('holiday-edit-name').value.trim();
      const typeDes = document.getElementById('holiday-edit-typeDes').value.trim();
      const content = document.getElementById('holiday-edit-content').value.trim();
      const enabled = document.getElementById('holiday-edit-enabled').checked;
      const dateStartInput = document.getElementById('holiday-edit-dateStart').value.trim();
      const dateEndInput = document.getElementById('holiday-edit-dateEnd').value.trim();
      const dateStart = dateStartInput ? dateStartInput.replace(/-/g, '').slice(0, 8) : '';
      let dateEnd = dateEndInput ? dateEndInput.replace(/-/g, '').slice(0, 8) : '';
      if (dateStart && !dateEnd) dateEnd = dateStart;
      if (holidayEditCurrentKey && holidayEditCurrentKey !== newKey) {
        delete holidaysConfig[holidayEditCurrentKey];
      }
      const payload = {
        name: name || newKey,
        typeDes: typeDes || undefined,
        content: content || undefined,
        enabled
      };
      if (dateStart) payload.dateStart = dateStart;
      if (dateEnd) payload.dateEnd = dateEnd;
      holidaysConfig[newKey] = payload;
      syncHolidaysJsonFromConfig();
      renderHolidaysList();
      closeHolidayEditModal();
      showStatus('holidays-status', 'å·²æ›´æ–°åˆ—è¡¨ï¼Œè¯·ç‚¹å‡»ã€Œä¿å­˜åˆ°æœåŠ¡å™¨ã€æŒä¹…åŒ–', 'success');
    });

    // ä»æœåŠ¡å™¨åŠ è½½ï¼ˆä¸åˆ·æ–°åˆ—è¡¨ä¸€è‡´ï¼Œå¹¶æ›´æ–°ä¸‹æ–¹ JSONï¼‰
    document.getElementById('btn-get-holidays').addEventListener('click', loadHolidaysFromServer);

    document.getElementById('holidays-file-input').addEventListener('change', async function () {
      const files = this.files;
      if (!files || files.length === 0) return;
      let config = {};
      try {
        const jsonText = document.getElementById('holidays-json').value.trim();
        if (jsonText) config = JSON.parse(jsonText);
      } catch (e) {
        showStatus('holidays-status', 'å½“å‰ JSON æ— æ•ˆï¼Œå°†ç”¨å¯¼å…¥å†…å®¹è¦†ç›–', 'info');
      }
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const key = file.name.replace(/\.json$/i, '') || `holiday-${i}`;
        const text = await file.text();
        try {
          config[key] = JSON.parse(text);
        } catch (_) {
          config[key] = { name: key, enabled: true, message: text };
        }
      }
      document.getElementById('holidays-json').value = JSON.stringify(config, null, 2);
      holidaysConfig = typeof config === 'object' && config !== null ? { ...config } : {};
      renderHolidaysList();
      showStatus('holidays-status', `å·²å¯¼å…¥ ${files.length} ä¸ªæ–‡ä»¶ï¼Œæ¯ä¸ªæ–‡ä»¶è¯†åˆ«ä¸ºä¸€æ¡èŠ‚æ—¥`, 'success');
      document.getElementById('holidays-file-input').value = '';
    });

    document.getElementById('btn-put-holidays').addEventListener('click', async () => {
      const jsonText = document.getElementById('holidays-json').value.trim();
      if (!jsonText) {
        showStatus('holidays-status', 'è¯·å¡«å†™é…ç½® JSON', 'error');
        return;
      }
      try {
        const json = JSON.parse(jsonText);
        await callApi('PUT', '/holidays', json);
        holidaysConfig = typeof json === 'object' && json !== null ? { ...json } : {};
        syncHolidaysJsonFromConfig();
        renderHolidaysList();
        showStatus('holidays-status', 'ä¿å­˜æˆåŠŸ', 'success');
      } catch (e) {
        showStatus('holidays-status', `ä¿å­˜å¤±è´¥ï¼š${e.message}`, 'error');
      }
    });

    // æ ¹æ®å½“å‰åˆ—è¡¨ï¼ˆholidaysConfigï¼‰å’Œå½“å‰æ—¥æœŸè®¡ç®—æ¿€æ´»èŠ‚æ—¥ï¼Œä¸ Worker é€»è¾‘ä¸€è‡´
    // todayTypeDesï¼šå¯é€‰ï¼Œå½“æ—¥ API è¿”å›çš„ typeDesï¼›ä¼ å…¥æ—¶éã€Œå…¨éƒ¨ã€çš„èŠ‚æ—¥éœ€ä¸ä¹‹ä¸€è‡´æ‰è®¡å…¥æ¿€æ´»
    function computeActiveHolidaysFromConfig(config, todayTypeDes) {
      if (!config || typeof config !== 'object') return {};
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, '0');
      const d = String(now.getDate()).padStart(2, '0');
      const today = y + m + d;
      const currentMonth = now.getMonth() + 1;
      const currentDay = now.getDate();
      const active = {};
      for (const [key, holiday] of Object.entries(config)) {
        if (!holiday || holiday.enabled !== true) continue;
        const typeDes = holiday.typeDes != null ? String(holiday.typeDes).trim() : '';
        const isTypeAll = typeDes === 'å…¨éƒ¨'; // å…¨éƒ¨ï¼šä¸åŒºåˆ†èŠ‚å‡æ—¥/å·¥ä½œæ—¥ï¼Œä»…æŒ‰æ—¥æœŸèŒƒå›´
        let isActive = false;
        if (holiday.dateStart != null && holiday.dateEnd != null) {
          const start = String(holiday.dateStart).trim().slice(0, 8);
          const end = String(holiday.dateEnd).trim().slice(0, 8);
          if (start.length === 8 && end.length === 8 && today >= start && today <= end) isActive = true;
        } else if (holiday.dateStart != null) {
          const start = String(holiday.dateStart).trim().slice(0, 8);
          if (start.length === 8 && today === start) isActive = true;
        } else if (holiday.date && holiday.date.month != null && holiday.date.day != null) {
          if (holiday.date.month === currentMonth && holiday.date.day === currentDay) isActive = true;
        } else if (holiday.startDate && holiday.endDate) {
          const start = new Date(holiday.startDate);
          const end = new Date(holiday.endDate);
          if (now >= start && now <= end) isActive = true;
        } else if (holiday.duration && holiday.date) {
          const startMonth = holiday.date.month;
          const startDay = holiday.date.day;
          const startDate = new Date(y, startMonth - 1, startDay);
          const endDate = new Date(startDate);
          endDate.setDate(endDate.getDate() + (holiday.duration - 1));
          if (now >= startDate && now <= endDate) isActive = true;
        }
        // typeDes ä¸ºã€Œå…¨éƒ¨ã€æ—¶ä»…æŒ‰æ—¥æœŸèŒƒå›´ï¼›éå…¨éƒ¨æ—¶éœ€ä¸å½“æ—¥ API typeDes ä¸€è‡´æ‰å¼¹çª—
        if (isTypeAll) {
          if (isActive) active[key] = holiday;
        } else if (isActive && typeDes) {
          if (todayTypeDes != null && todayTypeDes === typeDes) {
            active[key] = holiday;
          }
        } else if (isActive) {
          active[key] = holiday;
        }
      }
      return active;
    }

    // è®¡ç®—ã€Œä»Šæ—¥åœ¨æ—¥æœŸèŒƒå›´å†…ä½†å›  typeDes ä¸ API ä¸ä¸€è‡´è€Œæœªæ¿€æ´»ã€çš„èŠ‚æ—¥ï¼Œç”¨äºå¼¹çª—æç¤º
    function computeSkippedByTypeDes(config, todayTypeDes) {
      if (!config || typeof config !== 'object') return [];
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, '0');
      const d = String(now.getDate()).padStart(2, '0');
      const today = y + m + d;
      const currentMonth = now.getMonth() + 1;
      const currentDay = now.getDate();
      const skipped = [];
      for (const [key, holiday] of Object.entries(config)) {
        if (!holiday || holiday.enabled !== true) continue;
        const typeDes = holiday.typeDes != null ? String(holiday.typeDes).trim() : '';
        if (!typeDes || typeDes === 'å…¨éƒ¨') continue;
        let inRange = false;
        if (holiday.dateStart != null && holiday.dateEnd != null) {
          const start = String(holiday.dateStart).trim().slice(0, 8);
          const end = String(holiday.dateEnd).trim().slice(0, 8);
          if (start.length === 8 && end.length === 8 && today >= start && today <= end) inRange = true;
        } else if (holiday.dateStart != null) {
          const start = String(holiday.dateStart).trim().slice(0, 8);
          if (start.length === 8 && today === start) inRange = true;
        } else if (holiday.date && holiday.date.month != null && holiday.date.day != null) {
          if (holiday.date.month === currentMonth && holiday.date.day === currentDay) inRange = true;
        } else if (holiday.startDate && holiday.endDate) {
          const start = new Date(holiday.startDate);
          const end = new Date(holiday.endDate);
          if (now >= start && now <= end) inRange = true;
        } else if (holiday.duration && holiday.date) {
          const startMonth = holiday.date.month;
          const startDay = holiday.date.day;
          const startDate = new Date(y, startMonth - 1, startDay);
          const endDate = new Date(startDate);
          endDate.setDate(endDate.getDate() + (holiday.duration - 1));
          if (now >= startDate && now <= endDate) inRange = true;
        }
        if (inRange && (todayTypeDes == null || todayTypeDes !== typeDes)) {
          skipped.push({ key, name: holiday.name || key, typeDes });
        }
      }
      return skipped;
    }

    document.getElementById('btn-get-active-holidays').addEventListener('click', async () => {
      const today = new Date();
      const yyyyMMdd = today.getFullYear() + String(today.getMonth() + 1).padStart(2, '0') + String(today.getDate()).padStart(2, '0');
      let todayTypeDes = null;
      try {
        const data = await callApi('GET', `/holiday/single/${yyyyMMdd}`);
        if (data.ok && data.data && data.data.typeDes != null) {
          todayTypeDes = String(data.data.typeDes).trim();
        }
      } catch (_) {
        // æœªè·å–åˆ°å½“æ—¥ typeDes æ—¶æŒ‰ä»…æ—¥æœŸèŒƒå›´è®¡ç®—ï¼Œä¸å¼¹ã€Œä¸ä¸€è‡´ã€æç¤º
      }
      const active = computeActiveHolidaysFromConfig(holidaysConfig, todayTypeDes);
      const skipped = computeSkippedByTypeDes(holidaysConfig, todayTypeDes);
      if (skipped.length > 0) {
        const apiLabel = todayTypeDes != null ? 'ã€Œ' + todayTypeDes + 'ã€' : 'ã€Œæœªè·å–åˆ°ã€';
        const list = skipped.map(s => s.name + 'ï¼ˆé…ç½® typeDesï¼š' + s.typeDes + 'ï¼‰').join('\n');
        alert('ä»Šæ—¥ API è¿”å›çš„ typeDes ä¸º ' + apiLabel + 'ï¼Œä¸ä»¥ä¸‹èŠ‚æ—¥çš„ç±»å‹ä¸ä¸€è‡´ï¼Œè¿™äº›èŠ‚æ—¥ä»Šæ—¥ä¸ä¼šå¼¹çª—ï¼š\n\n' + list);
      }
      if (Object.keys(active).length === 0) {
        alert('å½“å‰æ—¥æœŸï¼ˆ' + yyyyMMdd + 'ï¼‰ä¸åœ¨ä»»ä½•èŠ‚æ—¥çš„å¼€å§‹ï½ç»“æŸèŒƒå›´å†…ï¼Œæˆ–æœªä¸å½“æ—¥ typeDes åŒ¹é…ã€‚\n\nè¯·ç¡®è®¤åˆ—è¡¨ä¸­çš„èŠ‚æ—¥å·²è®¾ç½®å¼€å§‹/ç»“æŸæ—¥æœŸï¼ˆyyyyMMddï¼‰ä¸”åŒ…å«ä»Šå¤©ï¼›è‹¥ç±»å‹éã€Œå…¨éƒ¨ã€ï¼Œéœ€ä¸ API å½“æ—¥ typeDes ä¸€è‡´æ‰ä¼šå¼¹çª—ã€‚');
      } else {
        alert('å½“å‰æ—¥æœŸï¼š' + yyyyMMdd + (todayTypeDes != null ? 'ï¼Œå½“æ—¥ API typeDesï¼š' + todayTypeDes : '') + '\n\næ¿€æ´»çš„èŠ‚æ—¥ï¼š\n' + JSON.stringify(active, null, 2));
      }
      showStatus('holidays-status', 'å·²æ ¹æ®å½“å‰åˆ—è¡¨è®¡ç®—', 'success');
    });
    
    // ç‰ˆæœ¬æ›´æ–°ç®¡ç†ï¼ˆç®€åŒ–ç‰ˆï¼šåªä¿ç•™å¼ºåˆ¶æ›´æ–°è®¾ç½®ï¼‰
    
    // è·å–ç‰ˆæœ¬ä¿¡æ¯ï¼ˆç”¨äºæ˜¾ç¤ºå’Œè®¾ç½®å¼ºåˆ¶æ›´æ–°ï¼‰
    document.getElementById('btn-get-update-info').addEventListener('click', async () => {
      const platform = document.getElementById('update-platform-select').value;
      const [plat, arch] = platform.split(':');
      
      const cfg = getConfig();
      if (!cfg.apiBase) {
        showStatus('update-info-status', 'è¯·å…ˆé…ç½® API åœ°å€', 'error');
        return;
      }
      
      try {
        showStatus('update-info-status', 'æ­£åœ¨åŠ è½½ç‰ˆæœ¬ä¿¡æ¯...', 'info');
        // ä» Worker API è·å–ç‰ˆæœ¬ä¿¡æ¯ï¼ˆå»é™¤ apiBase å°¾æ–œæ ï¼Œé¿å… //update/check å¯¼è‡´ 404ï¼‰
        const base = (cfg.apiBase || '').replace(/\/+$/, '');
        const checkUrl = `${base}/update/check?platform=${plat}&arch=${arch}`;
        const res = await fetch(checkUrl, {
          headers: { 'Accept': 'application/json' }
        });
        const data = await res.json();
        
        if (data.ok && data.updateInfo) {
          document.getElementById('update-info-json').value = JSON.stringify(data.updateInfo, null, 2);
          
          // è‡ªåŠ¨å¡«å……å¼ºåˆ¶æ›´æ–°è®¾ç½®
          if (data.updateInfo.minimumVersion) {
            document.getElementById('update-minimum-version').value = data.updateInfo.minimumVersion;
          } else {
            document.getElementById('update-minimum-version').value = '';
          }
          document.getElementById('update-force-update').checked = data.updateInfo.forceUpdate === true;
          
          // å¦‚æœæ›´æ–°æ—¥å¿—å·²åŠ è½½ï¼Œç¡®ä¿æœ€ä½ç‰ˆæœ¬ä¸‹æ‹‰èœå•åŒ…å«å½“å‰ç‰ˆæœ¬ä¿¡æ¯ä¸­çš„ minimumVersionï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if (data.updateInfo.minimumVersion && changelogList.length > 0) {
            updateMinimumVersionSelect();
            // æ¢å¤é€‰æ‹©çš„å€¼
            if (data.updateInfo.minimumVersion) {
              document.getElementById('update-minimum-version').value = data.updateInfo.minimumVersion;
            }
          }
          
          showStatus('update-info-status', 'âœ… ç‰ˆæœ¬ä¿¡æ¯åŠ è½½æˆåŠŸ', 'success');
        } else {
          document.getElementById('update-info-json').value = 'æš‚æ— ç‰ˆæœ¬ä¿¡æ¯ï¼ˆç‰ˆæœ¬ä¿¡æ¯ä¼šè‡ªåŠ¨ä» GitHub Releases åŒæ­¥ï¼‰';
          showStatus('update-info-status', 'âš ï¸ æš‚æ— ç‰ˆæœ¬ä¿¡æ¯ï¼Œè¯·å…ˆå‘å¸ƒ GitHub Release', 'warn');
        }
      } catch (e) {
        showStatus('update-info-status', `åŠ è½½å¤±è´¥ï¼š${e.message}`, 'error');
        console.error('åŠ è½½ç‰ˆæœ¬ä¿¡æ¯å¤±è´¥:', e);
      }
    });

    // ä» GitHub åŒæ­¥ç‰ˆæœ¬ä¿¡æ¯
    document.getElementById('btn-sync-from-github').addEventListener('click', async () => {
      const platform = document.getElementById('update-platform-select').value;
      const [plat, arch] = platform.split(':');
      
      const cfg = getConfig();
      if (!cfg.apiBase) {
        showStatus('update-info-status', 'è¯·å…ˆé…ç½® API åœ°å€', 'error');
        return;
      }
      
      try {
        showStatus('update-info-status', 'æ­£åœ¨ä» GitHub åŒæ­¥ç‰ˆæœ¬ä¿¡æ¯...', 'info');
        
        // è°ƒç”¨åŒæ­¥ APIï¼ˆå¼ºåˆ¶åŒæ­¥ï¼Œå¿½ç•¥èŠ‚æµï¼‰
        // ä½¿ç”¨ callApi å‡½æ•°ä»¥ç¡®ä¿è®¤è¯ token è¢«æ­£ç¡®ä¼ é€’
        const data = await callApi('POST', `/update/sync/github?platform=${plat}&arch=${arch}`);
        
        if (!data.ok) {
          throw new Error(data.error || 'åŒæ­¥å¤±è´¥');
        }
        
        // åŒæ­¥æˆåŠŸåï¼Œè‡ªåŠ¨åˆ·æ–°ç‰ˆæœ¬ä¿¡æ¯æ˜¾ç¤º
        showStatus('update-info-status', 'âœ… å·²ä» GitHub åŒæ­¥æˆåŠŸï¼Œæ­£åœ¨åˆ·æ–°...', 'success');
        
        // å»¶è¿Ÿä¸€ä¸‹å†åˆ·æ–°ï¼Œç¡®ä¿ KV å·²æ›´æ–°
        setTimeout(async () => {
          try {
            const base = (cfg.apiBase || '').replace(/\/+$/, '');
            const checkUrl = `${base}/update/check?platform=${plat}&arch=${arch}&noCache=1`;
            const checkRes = await fetch(checkUrl, {
              headers: { 'Accept': 'application/json' }
            });
            const checkData = await checkRes.json();
            
            if (checkData.ok && checkData.updateInfo) {
              document.getElementById('update-info-json').value = JSON.stringify(checkData.updateInfo, null, 2);
              
              // è‡ªåŠ¨å¡«å……å¼ºåˆ¶æ›´æ–°è®¾ç½®
              if (checkData.updateInfo.minimumVersion) {
                document.getElementById('update-minimum-version').value = checkData.updateInfo.minimumVersion;
              } else {
                document.getElementById('update-minimum-version').value = '';
              }
              document.getElementById('update-force-update').checked = checkData.updateInfo.forceUpdate === true;
              
              showStatus('update-info-status', `âœ… åŒæ­¥æˆåŠŸï¼å½“å‰ç‰ˆæœ¬: ${checkData.updateInfo.version}`, 'success');
            } else {
              showStatus('update-info-status', 'âš ï¸ åŒæ­¥å®Œæˆï¼Œä½†æ— æ³•è·å–ç‰ˆæœ¬ä¿¡æ¯', 'warn');
            }
          } catch (e) {
            showStatus('update-info-status', `åŒæ­¥æˆåŠŸï¼Œä½†åˆ·æ–°å¤±è´¥ï¼š${e.message}`, 'warn');
          }
        }, 500);
        
      } catch (e) {
        showStatus('update-info-status', `åŒæ­¥å¤±è´¥ï¼š${e.message}`, 'error');
        console.error('ä» GitHub åŒæ­¥å¤±è´¥:', e);
      }
    });

    // åº”ç”¨å¼ºåˆ¶æ›´æ–°è®¾ç½®ï¼ˆåªæ›´æ–°å¼ºåˆ¶æ›´æ–°ç›¸å…³å­—æ®µï¼Œä¸è¦†ç›–å…¶ä»–ç‰ˆæœ¬ä¿¡æ¯ï¼‰
    document.getElementById('btn-apply-force-update').addEventListener('click', async () => {
      const platform = document.getElementById('update-platform-select').value;
      const [plat, arch] = platform.split(':');
      const minimumVersion = document.getElementById('update-minimum-version').value;
      const forceUpdate = document.getElementById('update-force-update').checked;
      
      const cfg = getConfig();
      if (!cfg.apiBase) {
        showStatus('update-info-status', 'è¯·å…ˆé…ç½® API åœ°å€', 'error');
        return;
      }
      
      try {
        showStatus('update-info-status', 'æ­£åœ¨åº”ç”¨å¼ºåˆ¶æ›´æ–°è®¾ç½®...', 'info');
        
        // å¦‚æœæ²¡æœ‰ç®¡ç† Tokenï¼Œåˆ™æ— æ³•è°ƒç”¨å—ä¿æŠ¤çš„æ›´æ–°æ¥å£
        if (!cfg.token) {
          showStatus('update-info-status', 'è¯·å…ˆåœ¨å³ä¸Šè§’ã€Œè®¾ç½®ã€ä¸­å¡«å†™ç®¡ç† Tokenï¼ˆéœ€ä¸äº‘æ§ Worker çš„ CLOUD_TOKEN ä¸€è‡´ï¼‰', 'error');
          return;
        }
        
        // å…ˆè·å–å½“å‰ç‰ˆæœ¬ä¿¡æ¯ï¼ˆå»é™¤ apiBase å°¾æ–œæ ï¼Œé¿å… //update/check å¯¼è‡´ 404ï¼‰
        const base = (cfg.apiBase || '').replace(/\/+$/, '');
        const checkUrl = `${base}/update/check?platform=${plat}&arch=${arch}`;
        const checkHeaders = { 'Accept': 'application/json' };
        if (cfg.token) checkHeaders['Authorization'] = `Bearer ${cfg.token}`;
        const res = await fetch(checkUrl, {
          headers: checkHeaders
        });
        const data = await res.json();
        
        if (!data.ok || !data.updateInfo) {
          showStatus('update-info-status', 'âŒ æ— æ³•è·å–å½“å‰ç‰ˆæœ¬ä¿¡æ¯ï¼Œè¯·å…ˆå‘å¸ƒ GitHub Release', 'error');
          return;
        }
        
        // åˆå¹¶å¼ºåˆ¶æ›´æ–°è®¾ç½®åˆ°ç°æœ‰ç‰ˆæœ¬ä¿¡æ¯
        const updateInfo = {
          ...data.updateInfo,
          minimumVersion: minimumVersion || undefined,
          forceUpdate: forceUpdate || undefined
        };
        
        // å¦‚æœå–æ¶ˆæœ€ä½ç‰ˆæœ¬è¦æ±‚ï¼Œåˆ é™¤è¯¥å­—æ®µ
        if (!minimumVersion && updateInfo.minimumVersion) {
          delete updateInfo.minimumVersion;
        }
        // å¦‚æœå–æ¶ˆå¼ºåˆ¶æ›´æ–°ï¼Œåˆ é™¤è¯¥å­—æ®µ
        if (!forceUpdate && updateInfo.forceUpdate) {
          delete updateInfo.forceUpdate;
        }
        
        // ä¸Šä¼ æ›´æ–°åçš„ç‰ˆæœ¬ä¿¡æ¯
        await callApi('PUT', `/update/info?platform=${plat}&arch=${arch}`, updateInfo);
        
        // åˆ·æ–°æ˜¾ç¤º
        document.getElementById('update-info-json').value = JSON.stringify(updateInfo, null, 2);
        showStatus('update-info-status', 'âœ… å¼ºåˆ¶æ›´æ–°è®¾ç½®å·²åº”ç”¨æˆåŠŸï¼', 'success');
      } catch (e) {
        const msg = String(e && e.message ? e.message : e);
        if (msg.includes('Unauthorized') || msg.includes('401')) {
          showStatus('update-info-status', 'åº”ç”¨å¤±è´¥ï¼šæœªæˆæƒï¼Œè¯·æ£€æŸ¥è®¾ç½®ä¸­çš„ Token æ˜¯å¦æ­£ç¡®ï¼ˆéœ€ä¸åå° CLOUD_TOKEN ä¸€è‡´ï¼‰', 'error');
        } else {
          showStatus('update-info-status', `åº”ç”¨å¤±è´¥ï¼š${msg}`, 'error');
        }
        console.error('åº”ç”¨å¼ºåˆ¶æ›´æ–°è®¾ç½®å¤±è´¥:', e);
      }
    });
    

    // æ›´æ–°æ—¥å¿—ç®¡ç†ï¼ˆåˆ—è¡¨æ¨¡å¼ï¼‰
    let changelogList = [];
    let editingIndex = -1;
    const changelogModal = document.getElementById('changelog-edit-modal');
    
    // æ›´æ–°æœ€ä½ç‰ˆæœ¬ä¸‹æ‹‰èœå•
    function updateMinimumVersionSelect() {
      const select = document.getElementById('update-minimum-version');
      const currentValue = select.value;
      
      // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™ç¬¬ä¸€ä¸ª"ä¸è®¾ç½®"é€‰é¡¹ï¼‰
      select.innerHTML = '<option value="">ä¸è®¾ç½®æœ€ä½ç‰ˆæœ¬è¦æ±‚</option>';
      
      // ä»æ›´æ–°æ—¥å¿—åˆ—è¡¨ä¸­æå–ç‰ˆæœ¬å·
      const versions = changelogList.map(c => c.version).filter(v => v);
      
      // æŒ‰ç‰ˆæœ¬å·æ’åºï¼ˆä»é«˜åˆ°ä½ï¼‰
      versions.sort((a, b) => {
        const aParts = a.split('.').map(Number);
        const bParts = b.split('.').map(Number);
        for (let i = 0; i < Math.max(aParts.length, bParts.length); i++) {
          const aVal = aParts[i] || 0;
          const bVal = bParts[i] || 0;
          if (bVal !== aVal) return bVal - aVal;
        }
        return 0;
      });
      
      // æ·»åŠ ç‰ˆæœ¬é€‰é¡¹
      versions.forEach(version => {
        const option = document.createElement('option');
        option.value = version;
        option.textContent = `v${version}`;
        select.appendChild(option);
      });
      
      // æ¢å¤ä¹‹å‰é€‰æ‹©çš„å€¼ï¼ˆå¦‚æœè¿˜å­˜åœ¨ï¼‰
      if (currentValue && versions.includes(currentValue)) {
        select.value = currentValue;
      }
    }
    
    // ä»æ–‡ä»¶åæå–ç‰ˆæœ¬å·
    function extractVersionFromFilename(filename) {
      const patterns = [
        /(?:CHANGELOG|changelog)[-_]?v?(\d+\.\d+\.\d+(?:[-.]\w+)?)/i,
        /v?(\d+\.\d+\.\d+(?:[-.]\w+)?)\.md$/i,
        /(\d+\.\d+\.\d+(?:[-.]\w+)?)\.md$/i
      ];
      
      for (const pattern of patterns) {
        const match = filename.match(pattern);
        if (match && match[1]) {
          return match[1];
        }
      }
      return null;
    }
    
    // ä» Markdown å†…å®¹æå–æ ‡é¢˜
    function extractTitleFromMarkdown(content) {
      const lines = content.split('\n');
      for (const line of lines) {
        const trimmed = line.trim();
        if (trimmed.startsWith('# ')) {
          return trimmed.substring(2).trim();
        } else if (trimmed.startsWith('## ')) {
          return trimmed.substring(3).trim();
        }
      }
      return null;
    }
    
    // æ¸²æŸ“æ›´æ–°æ—¥å¿—åˆ—è¡¨
    function renderChangelogList() {
      const container = document.getElementById('changelog-list');
      const empty = document.getElementById('changelog-list-empty');
      
      if (changelogList.length === 0) {
        container.style.display = 'none';
        empty.style.display = 'block';
        return;
      }
      
      empty.style.display = 'none';
      container.style.display = 'block';
      container.innerHTML = '';
      
      // æŒ‰ç‰ˆæœ¬å·æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
      const sorted = [...changelogList].sort((a, b) => {
        const aParts = a.version.split('.').map(Number);
        const bParts = b.version.split('.').map(Number);
        for (let i = 0; i < Math.max(aParts.length, bParts.length); i++) {
          const aVal = aParts[i] || 0;
          const bVal = bParts[i] || 0;
          if (bVal !== aVal) return bVal - aVal;
        }
        return new Date(b.releaseDate) - new Date(a.releaseDate);
      });
      
      sorted.forEach((item, index) => {
        const actualIndex = changelogList.indexOf(item);
        const releaseDate = new Date(item.releaseDate).toLocaleString('zh-CN');
        const contentPreview = item.content.substring(0, 100).replace(/\n/g, ' ').trim() + (item.content.length > 100 ? '...' : '');
        
        const card = document.createElement('div');
        card.className = 'card';
        card.style.marginBottom = '12px';
        card.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:start;">
            <div style="flex:1;">
              <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
                <h3 style="margin:0; font-size:18px;">
                  ${item.prerelease ? '<span style="background:#ff9800; color:white; padding:2px 8px; border-radius:4px; font-size:12px; margin-right:8px;">é¢„å‘å¸ƒ</span>' : ''}
                  <span style="color:#667eea;">${item.title || `ç‰ˆæœ¬ ${item.version}`}</span>
                </h3>
                <code style="background:#f0f0f0; padding:2px 8px; border-radius:4px; font-size:12px;">v${item.version}</code>
              </div>
              <div style="color:#666; font-size:13px; margin-bottom:8px;">
                <i class="fas fa-calendar"></i> ${releaseDate}
              </div>
              <div style="color:#888; font-size:12px; line-height:1.5; max-height:60px; overflow:hidden;">
                ${contentPreview}
              </div>
            </div>
            <div style="display:flex; gap:8px; margin-left:16px;">
              <button class="btn btn-sm btn-secondary" onclick="editChangelog(${actualIndex})">
                <i class="fas fa-edit"></i> ç¼–è¾‘
              </button>
              <button class="btn btn-sm btn-danger" onclick="deleteChangelog(${actualIndex})">
                <i class="fas fa-trash"></i> åˆ é™¤
              </button>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }
    
    // ç¼–è¾‘æ›´æ–°æ—¥å¿—
    window.editChangelog = function(index) {
      editingIndex = index;
      const item = changelogList[index];
      
      document.getElementById('changelog-modal-title').textContent = 'ç¼–è¾‘æ›´æ–°æ—¥å¿—';
      document.getElementById('changelog-edit-version').value = item.version;
      document.getElementById('changelog-edit-title').value = item.title || '';
      document.getElementById('changelog-edit-content').value = item.content;
      document.getElementById('changelog-edit-prerelease').checked = item.prerelease || false;
      
      // è®¾ç½®å‘å¸ƒæ—¥æœŸ
      const date = new Date(item.releaseDate);
      const dateStr = date.toISOString().slice(0, 16);
      document.getElementById('changelog-edit-releasedate').value = dateStr;
      
      // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
      document.getElementById('changelog-edit-md-file').value = '';
      
      changelogModal.classList.add('active');
    };
    
    // åˆ é™¤æ›´æ–°æ—¥å¿—
    window.deleteChangelog = function(index) {
      if (confirm(`ç¡®å®šè¦åˆ é™¤ç‰ˆæœ¬ ${changelogList[index].version} çš„æ›´æ–°æ—¥å¿—å—ï¼Ÿ`)) {
        changelogList.splice(index, 1);
        renderChangelogList();
        updateMinimumVersionSelect(); // æ›´æ–°æœ€ä½ç‰ˆæœ¬ä¸‹æ‹‰èœå•
        showStatus('changelog-status', 'å·²åˆ é™¤', 'success');
      }
    };
    
    // æ‰“å¼€æ·»åŠ æ¨¡æ€æ¡†
    document.getElementById('btn-add-changelog-version').addEventListener('click', () => {
      editingIndex = -1;
      document.getElementById('changelog-modal-title').textContent = 'æ·»åŠ æ›´æ–°æ—¥å¿—';
      document.getElementById('changelog-edit-version').value = '';
      document.getElementById('changelog-edit-title').value = '';
      document.getElementById('changelog-edit-content').value = '';
      document.getElementById('changelog-edit-releasedate').value = '';
      document.getElementById('changelog-edit-prerelease').checked = false;
      document.getElementById('changelog-edit-md-file').value = '';
      changelogModal.classList.add('active');
    });
    
    // å…³é—­æ¨¡æ€æ¡†
    document.getElementById('changelog-modal-close').addEventListener('click', () => {
      changelogModal.classList.remove('active');
    });
    
    document.getElementById('changelog-modal-cancel').addEventListener('click', () => {
      changelogModal.classList.remove('active');
    });
    
    // å¤„ç† Markdown æ–‡ä»¶ä¸Šä¼ 
    document.getElementById('changelog-edit-md-file').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      try {
        const content = await file.text();
        const version = extractVersionFromFilename(file.name);
        const title = extractTitleFromMarkdown(content);
        
        if (version) {
          document.getElementById('changelog-edit-version').value = version;
        }
        if (title) {
          document.getElementById('changelog-edit-title').value = title;
        }
        document.getElementById('changelog-edit-content').value = content.trim();
        
        showStatus('changelog-status', 'Markdown æ–‡ä»¶å·²åŠ è½½', 'success');
      } catch (e) {
        showStatus('changelog-status', `è¯»å–æ–‡ä»¶å¤±è´¥ï¼š${e.message}`, 'error');
      }
    });
    
    // ä¿å­˜æ›´æ–°æ—¥å¿—æ¡ç›®
    document.getElementById('changelog-modal-save').addEventListener('click', () => {
      const version = document.getElementById('changelog-edit-version').value.trim();
      const title = document.getElementById('changelog-edit-title').value.trim();
      const content = document.getElementById('changelog-edit-content').value.trim();
      const releaseDate = document.getElementById('changelog-edit-releasedate').value;
      const prerelease = document.getElementById('changelog-edit-prerelease').checked;
      
      if (!version) {
        showStatus('changelog-status', 'è¯·å¡«å†™ç‰ˆæœ¬å·', 'error');
        return;
      }
      
      if (!content) {
        showStatus('changelog-status', 'è¯·å¡«å†™æ›´æ–°å†…å®¹', 'error');
        return;
      }
      
      // æ£€æŸ¥ç‰ˆæœ¬å·æ˜¯å¦é‡å¤ï¼ˆç¼–è¾‘æ—¶æ’é™¤è‡ªå·±ï¼‰
      if (editingIndex === -1) {
        const exists = changelogList.findIndex(c => c.version === version);
        if (exists >= 0) {
          if (!confirm(`ç‰ˆæœ¬ ${version} å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦è¦†ç›–ï¼Ÿ`)) {
            return;
          }
          changelogList[exists] = {
            version,
            title: title || `ç‰ˆæœ¬ ${version}`,
            content,
            releaseDate: releaseDate ? new Date(releaseDate).toISOString() : new Date().toISOString(),
            prerelease
          };
        } else {
          changelogList.unshift({
            version,
            title: title || `ç‰ˆæœ¬ ${version}`,
            content,
            releaseDate: releaseDate ? new Date(releaseDate).toISOString() : new Date().toISOString(),
            prerelease
          });
        }
      } else {
        changelogList[editingIndex] = {
          version,
          title: title || `ç‰ˆæœ¬ ${version}`,
          content,
          releaseDate: releaseDate ? new Date(releaseDate).toISOString() : changelogList[editingIndex].releaseDate,
          prerelease
        };
      }
      
      renderChangelogList();
      updateMinimumVersionSelect(); // æ›´æ–°æœ€ä½ç‰ˆæœ¬ä¸‹æ‹‰èœå•
      changelogModal.classList.remove('active');
      showStatus('changelog-status', editingIndex === -1 ? 'å·²æ·»åŠ ' : 'å·²æ›´æ–°', 'success');
    });
    
    // ä»æœåŠ¡å™¨åŠ è½½
    document.getElementById('btn-get-changelog').addEventListener('click', async () => {
      try {
        showStatus('changelog-status', 'æ­£åœ¨åŠ è½½...', 'info');
        const cfg = getConfig();
        if (!cfg.apiBase) {
          showStatus('changelog-status', 'è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API åœ°å€', 'error');
          return;
        }
        // çº¦å®šï¼šGET ${apiBase}/update/changelog?force=1ï¼Œä»æœåŠ¡å™¨ï¼ˆWorker ä»£ç† GitHubï¼‰æ‹‰å– { changelog }
        const data = await callApi('GET', '/update/changelog?force=1');
        changelogList = data.changelog || [];
        renderChangelogList();
        updateMinimumVersionSelect(); // æ›´æ–°æœ€ä½ç‰ˆæœ¬ä¸‹æ‹‰èœå•
        showStatus('changelog-status', `å·²åŠ è½½ ${changelogList.length} æ¡æ›´æ–°æ—¥å¿—`, 'success');
      } catch (e) {
        console.error('åŠ è½½æ›´æ–°æ—¥å¿—å¤±è´¥:', e);
        showStatus('changelog-status', `åŠ è½½å¤±è´¥ï¼š${e.message}`, 'error');
      }
    });

    // ä» GitHub åŒæ­¥æ›´æ–°æ—¥å¿—
    document.getElementById('btn-sync-changelog-from-github').addEventListener('click', async () => {
      const cfg = getConfig();
      if (!cfg.apiBase) {
        showStatus('changelog-status', 'è¯·å…ˆé…ç½® API åœ°å€', 'error');
        return;
      }
      
      try {
        showStatus('changelog-status', 'æ­£åœ¨ä» GitHub åŒæ­¥æ›´æ–°æ—¥å¿—...', 'info');
        
        // è°ƒç”¨åŒæ­¥ APIï¼ˆå¼ºåˆ¶åŒæ­¥ï¼Œå¿½ç•¥èŠ‚æµï¼‰
        const data = await callApi('POST', '/update/changelog/sync/github');
        
        if (!data.ok) {
          throw new Error(data.error || 'åŒæ­¥å¤±è´¥');
        }
        
        showStatus('changelog-status', 'âœ… å·²ä» GitHub åŒæ­¥æˆåŠŸï¼Œæ­£åœ¨åˆ·æ–°...', 'success');
        
        // å»¶è¿Ÿä¸€ä¸‹å†åˆ·æ–°ï¼Œç¡®ä¿ KV å·²æ›´æ–°
        setTimeout(async () => {
          try {
            const loadData = await callApi('GET', '/update/changelog?force=1');
            changelogList = loadData.changelog || [];
            renderChangelogList();
            updateMinimumVersionSelect();
            
            if (changelogList.length > 0) {
              const latestVersion = changelogList[0]?.version || 'unknown';
              showStatus('changelog-status', `âœ… åŒæ­¥æˆåŠŸï¼æœ€æ–°ç‰ˆæœ¬: ${latestVersion}ï¼Œå…± ${changelogList.length} æ¡æ›´æ–°æ—¥å¿—`, 'success');
            } else {
              showStatus('changelog-status', 'âš ï¸ åŒæ­¥å®Œæˆï¼Œä½†æš‚æ— æ›´æ–°æ—¥å¿—', 'warn');
            }
          } catch (e) {
            showStatus('changelog-status', `åŒæ­¥æˆåŠŸï¼Œä½†åˆ·æ–°å¤±è´¥ï¼š${e.message}`, 'warn');
          }
        }, 500);
        
      } catch (e) {
        showStatus('changelog-status', `åŒæ­¥å¤±è´¥ï¼š${e.message}`, 'error');
        console.error('ä» GitHub åŒæ­¥æ›´æ–°æ—¥å¿—å¤±è´¥:', e);
      }
    });

    // ä¿å­˜æ‰€æœ‰æ›´æ”¹
    document.getElementById('btn-put-changelog').addEventListener('click', async () => {
      if (changelogList.length === 0) {
        showStatus('changelog-status', 'æ²¡æœ‰æ›´æ–°æ—¥å¿—å¯ä¿å­˜', 'warn');
        return;
      }
      
      try {
        showStatus('changelog-status', 'æ­£åœ¨ä¿å­˜...', 'info');
        await callApi('PUT', '/update/changelog', { changelog: changelogList });
        showStatus('changelog-status', `âœ… ä¿å­˜æˆåŠŸï¼å…± ${changelogList.length} æ¡æ›´æ–°æ—¥å¿—`, 'success');
      } catch (e) {
        showStatus('changelog-status', `ä¿å­˜å¤±è´¥ï¼š${e.message}`, 'error');
      }
    });
    
    // ç»Ÿè®¡ä¿¡æ¯
    document.getElementById('btn-refresh-stats').addEventListener('click', async () => {
      try {
        const runtimeData = await callApi('GET', '/runtime/lines').catch(() => ({ lines: [] }));
        document.getElementById('stat-runtime-count').textContent = (runtimeData.lines || []).length;
      } catch (e) {
        console.error('åˆ·æ–°ç»Ÿè®¡å¤±è´¥:', e);
      }
    });

    // ä½¿ç”¨ç»Ÿè®¡ï¼šè®¿é—®æ¬¡æ•°ã€å…¨çƒåˆ†å¸ƒã€ä½¿ç”¨ç‰ˆæœ¬ã€è®¾å¤‡ç»Ÿè®¡ã€æœ€è¿‘è®°å½•
    document.getElementById('btn-refresh-usage').addEventListener('click', async () => {
      const cfg = getConfig();
      const statUsersEl = document.getElementById('stat-users');
      const statUniqueEl = document.getElementById('stat-unique-devices');
      const statByCountryEl = document.getElementById('stat-by-country');
      const statByVersionEl = document.getElementById('stat-by-version');
      const statByOsEl = document.getElementById('stat-by-os');
      const statByDeviceEl = document.getElementById('stat-by-device');
      const statRecentTbodyEl = document.getElementById('stat-recent-tbody');

      if (!cfg.apiBase) {
        showStatus('changelog-status', 'è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API åœ°å€', 'error');
        if (statUsersEl) statUsersEl.textContent = '-';
        if (statUniqueEl) statUniqueEl.textContent = '-';
        if (statByCountryEl) statByCountryEl.textContent = 'è¯·é…ç½® API åœ°å€';
        if (statByVersionEl) statByVersionEl.textContent = '-';
        if (statByOsEl) statByOsEl.textContent = '-';
        if (statByDeviceEl) statByDeviceEl.textContent = '-';
        if (statRecentTbodyEl) statRecentTbodyEl.innerHTML = '<tr><td colspan="7" class="empty-state">è¯·å…ˆé…ç½® API åœ°å€</td></tr>';
        return;
      }
      try {
        showStatus('changelog-status', 'æ­£åœ¨åŠ è½½ä½¿ç”¨ç»Ÿè®¡...', 'info');
        const data = await callApi('GET', '/stats');
        if (statUniqueEl) statUniqueEl.textContent = (data.uniqueDevices || 0);
        
        const hintEl = document.getElementById('stat-truncated-hint');
        if (data.truncated) {
          hintEl.textContent = `ï¼ˆä»…æ˜¾ç¤ºæœ€è¿‘ 5000 æ¡ï¼Œæ±‡æ€»å·²å«å…¨éƒ¨ ${data.total} æ¡ï¼‰`;
          hintEl.style.display = 'inline';
        } else {
          hintEl.style.display = 'none';
        }
        
        // è§£æè¦æ’é™¤çš„è®¾å¤‡IDåˆ—è¡¨
        const excludeText = (document.getElementById('stat-excluded-devices')?.value || '').trim();
        const excludedIds = new Set(
          excludeText
            .split(/\s+/)
            .map(s => s.trim())
            .filter(Boolean)
        );

        // æŠŠæ’é™¤åˆ—è¡¨ä¿å­˜åˆ°æœ¬åœ°é…ç½®ï¼Œä¾¿äºä¸‹æ¬¡å¯åŠ¨æ¢å¤
        const cfgToSave = loadConfig();
        cfgToSave.excludedDevices = excludeText;
        saveConfig(cfgToSave);

        // åŒæ­¥æ’é™¤åˆ—è¡¨åˆ°æœåŠ¡å™¨ï¼Œæ”¯æŒè·¨è®¾å¤‡å…±äº«ï¼ˆéœ€è¦ Tokenï¼‰
        if (cfg.token) {
          try {
            await callApi('PUT', '/stats/config', {
              excludedDevices: Array.from(excludedIds)
            });
          } catch (e) {
            console.warn('åŒæ­¥ç»Ÿè®¡æ’é™¤åˆ—è¡¨åˆ°æœåŠ¡å™¨å¤±è´¥:', e);
          }
        } else {
          console.warn('æœªé…ç½® Tokenï¼Œè·³è¿‡åŒæ­¥ç»Ÿè®¡æ’é™¤åˆ—è¡¨åˆ°æœåŠ¡å™¨');
        }

        // ä»æ‰€æœ‰è®°å½•ä¸­æŒ‰è®¾å¤‡IDå»é‡ï¼Œç»Ÿè®¡è®¾å¤‡æ•°é‡ï¼ˆè€Œä¸æ˜¯è®¿é—®æ¬¡æ•°ï¼‰
        const rawAllRecordsForStats = data.all || data.records || [];
        const allRecordsForStats = excludedIds.size
          ? rawAllRecordsForStats.filter(r => !r.deviceId || !excludedIds.has(r.deviceId))
          : rawAllRecordsForStats;
        const deviceMap = new Map(); // deviceId -> { country, version, os, deviceId }
        const deviceOnlineSeconds = {}; // è®¾å¤‡ç´¯è®¡åœ¨çº¿æ€»æ—¶é•¿ï¼ˆç§’ï¼‰ï¼Œç”¨äºè®¾å¤‡ç»Ÿè®¡é¥¼å›¾
        
        // éå†æ‰€æœ‰è®°å½•ï¼Œä¸ºæ¯ä¸ªè®¾å¤‡ä¿ç•™æœ€æ–°çš„è®°å½•ä¿¡æ¯
        allRecordsForStats.forEach(record => {
          const deviceId = record.deviceId;
          if (!deviceId) return;
          
          if (!deviceMap.has(deviceId)) {
            deviceMap.set(deviceId, {
              country: record.country,
              version: record.version,
              os: record.os,
              deviceId: deviceId
            });
          }
        });
        
        // ç‹¬ç«‹è®¾å¤‡å¡ç‰‡ï¼šæ˜¾ç¤ºè¿‡æ»¤åçš„ç‹¬ç«‹è®¾å¤‡æ•°é‡
        if (statUsersEl) {
          statUsersEl.textContent = deviceMap.size.toString();
        }
        
        // æŒ‰åˆ†ç±»ç»Ÿè®¡è®¾å¤‡æ•°é‡
        const byCountryDevices = {};
        const byVersionDevices = {};
        const byOSDevices = {};
        
        const byDeviceDevices = {};
        deviceMap.forEach(device => {
          // æŒ‰å›½å®¶ç»Ÿè®¡è®¾å¤‡æ•°é‡
          if (device.country) {
            byCountryDevices[device.country] = (byCountryDevices[device.country] || 0) + 1;
          }
          // æŒ‰ç‰ˆæœ¬ç»Ÿè®¡è®¾å¤‡æ•°é‡
          if (device.version) {
            byVersionDevices[device.version] = (byVersionDevices[device.version] || 0) + 1;
          }
          // æŒ‰æ“ä½œç³»ç»Ÿç»Ÿè®¡è®¾å¤‡æ•°é‡ï¼ˆè§„èŒƒåŒ–ç‰ˆæœ¬å·ä»¥åˆå¹¶ç›¸åŒç‰ˆæœ¬ï¼‰
          if (device.os) {
            const normalizedOS = parseWindowsVersion(device.os);
            byOSDevices[normalizedOS] = (byOSDevices[normalizedOS] || 0) + 1;
          }
          // æŒ‰è®¾å¤‡ç»Ÿè®¡è®¿é—®æ•°é‡
          if (device.deviceId) {
            byDeviceDevices[device.deviceId] = (byDeviceDevices[device.deviceId] || 0) + 1;
          }
          // æŒ‰è®¾å¤‡ç»Ÿè®¡è®¿é—®æ•°é‡
          if (device.deviceId) {
            byDeviceDevices[device.deviceId] = (byDeviceDevices[device.deviceId] || 0) + 1;
          }
          // æŒ‰è®¾å¤‡ç»Ÿè®¡è®¿é—®æ•°é‡
          if (device.deviceId) {
            byDeviceDevices[device.deviceId] = (byDeviceDevices[device.deviceId] || 0) + 1;
          }
        });
        
        // ç¾åŒ–å…¨çƒåˆ†å¸ƒæ˜¾ç¤º - é¥¼å›¾ï¼ˆè®¾å¤‡æ•°é‡ï¼‰
        const countryElement = document.getElementById('stat-by-country');
        if (Object.keys(byCountryDevices).length) {
          const sortedCountries = Object.entries(byCountryDevices).sort((a, b) => b[1] - a[1]);
          const pieData = sortedCountries.map(([k, v]) => ({
            label: k,
            value: v
          }));
          countryElement.innerHTML = createPieChartHTML('stat-by-country', pieData, {
            size: 180,
            formatLabel: (label, value) => {
              const countryName = getCountryFlag(label);
              return `${countryName} (${label})`;
            }
          });
        } else {
          countryElement.textContent = '-';
        }
        
        // ç¾åŒ–ä½¿ç”¨ç‰ˆæœ¬æ˜¾ç¤º - é¥¼å›¾ï¼ˆè®¾å¤‡æ•°é‡ï¼‰
        const versionElement = document.getElementById('stat-by-version');
        if (Object.keys(byVersionDevices).length) {
          const sortedVersions = Object.entries(byVersionDevices).sort((a, b) => b[1] - a[1]);
          const pieData = sortedVersions.map(([k, v]) => ({
            label: k,
            value: v
          }));
          versionElement.innerHTML = createPieChartHTML('stat-by-version', pieData, {
            size: 180,
            formatLabel: (label, value) => {
              const isAdmin = label.toLowerCase() === 'admin';
              const icon = isAdmin ? 'ğŸ‘¤' : 'ğŸ“¦';
              return `${icon} ${label}`;
            }
          });
        } else {
          versionElement.textContent = '-';
        }
        
        // ç¾åŒ–æ“ä½œç³»ç»Ÿåˆ†å¸ƒæ˜¾ç¤º - é¥¼å›¾ï¼ˆè®¾å¤‡æ•°é‡ï¼‰
        const osElement = document.getElementById('stat-by-os');
        if (Object.keys(byOSDevices).length) {
          const sortedOS = Object.entries(byOSDevices).sort((a, b) => b[1] - a[1]);
          const pieData = sortedOS.map(([k, v]) => ({
            label: k,
            value: v
          }));
          osElement.innerHTML = createPieChartHTML('stat-by-os', pieData, {
            size: 180,
            formatLabel: (label, value) => {
              const osIcon = getOSIconForStat(label);
              const formattedOS = parseWindowsVersion(label);
              return `${osIcon} ${formattedOS}`;
            }
          });
        } else {
          osElement.textContent = '-';
        }
        
        // å¤„ç†æœ€è¿‘è®°å½•è¡¨æ ¼ï¼ˆä½¿ç”¨åŸå§‹è®¿é—®è®°å½•ï¼‰
        const rawAllRecords = data.all || data.recent || data.records || [];
        const allRecords = excludedIds.size
          ? rawAllRecords.filter(r => !r.deviceId || !excludedIds.has(r.deviceId))
          : rawAllRecords;
        const tbody = document.getElementById('stat-recent-tbody');
        if (!tbody) {
          window.allRecords = [];
        } else if (allRecords.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="empty-state">æš‚æ— </td></tr>';
          window.allRecords = [];
        } else {
          // æŒ‰æ—¥æœŸåˆ†ç»„ï¼ˆä½¿ç”¨æœ¬åœ°æ—¶åŒºï¼Œé¿å… UTC å¯¼è‡´ã€Œ2æœˆ6æ—¥å‡Œæ™¨ã€è¢«è®°å…¥ 2æœˆ5æ—¥ï¼‰
          const today = new Date();
          const toLocalDateStr = (ts) => {
            if (!ts) return 'unknown';
            const d = new Date(ts);
            return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
          };
          const todayStr = toLocalDateStr(today.getTime());
          const groups = {};
          allRecords.forEach(r => {
            const date = toLocalDateStr(r.ts);
            if (!groups[date]) groups[date] = [];
            groups[date].push(r);
          });
          
          // æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
          const sortedDates = Object.keys(groups).sort((a, b) => {
            if (a === 'unknown') return 1;
            if (b === 'unknown') return -1;
            return b.localeCompare(a);
          });
          
          let html = '';
          sortedDates.forEach(date => {
            const records = groups[date];
            const isToday = date === todayStr;
            const dateLabel = date === 'unknown' ? 'æœªçŸ¥æ—¥æœŸ' : date;
            const dateDisplay = date === 'unknown' ? 'æœªçŸ¥æ—¥æœŸ' : 
              new Date(date + 'T00:00:00').toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
            
            // è¯¥æ—¥æœŸçš„è®°å½•è¡Œ - å…ˆåˆå¹¶åŒä¸€è®¾å¤‡çŸ­æ—¶é—´å†…çš„é‡å¤è®¿é—®ï¼Œç„¶åæŒ‰è®¾å¤‡ç´¯è®¡ä¸€å¤©çš„æ€»æ—¶é•¿
            const mergedRecords = mergeRepeatedVisits(records, 5 * 60 * 1000); // 5åˆ†é’Ÿæ—¶é—´çª—å£
            
            // æŒ‰è®¾å¤‡åˆ†ç»„ï¼Œè®¡ç®—æ¯ä¸ªè®¾å¤‡åœ¨è¿™ä¸€å¤©çš„ç´¯è®¡æ€»æ—¶é•¿
            const deviceGroups = {};
            mergedRecords.forEach(item => {
              const deviceKey = `${item.deviceId || 'unknown'}_${item.version || 'unknown'}_${item.country || 'unknown'}_${item.city || 'unknown'}_${item.os || 'unknown'}`;
              
              if (!deviceGroups[deviceKey]) {
                deviceGroups[deviceKey] = {
                  deviceId: item.deviceId || 'unknown',
                  version: item.version || 'unknown',
                  country: item.country || '',
                  city: item.city || '',
                  os: item.os || '',
                  firstTime: item.firstTime || item.first_time || null,
                  lastTime: item.lastTime || item.last_time || null,
                  totalCount: item.count || item.totalCount || 1, // å…¼å®¹è€ç‰ˆæœ¬
                  recordIds: [...(item.recordIds || [])]
                };
              } else {
                // ç´¯è®¡åŒä¸€è®¾å¤‡çš„æ‰€æœ‰è®¿é—®
                const group = deviceGroups[deviceKey];
                group.totalCount += (item.count || item.totalCount || 1); // å…¼å®¹è€ç‰ˆæœ¬
                
                // æ›´æ–°æœ€æ—©å’Œæœ€æ™šæ—¶é—´
                const itemFirstTime = item.firstTime || item.first_time || null;
                const itemLastTime = item.lastTime || item.last_time || null;
                
                if (itemFirstTime) {
                  if (!group.firstTime || itemFirstTime < group.firstTime) {
                    group.firstTime = itemFirstTime;
                  }
                }
                if (itemLastTime) {
                  if (!group.lastTime || itemLastTime > group.lastTime) {
                    group.lastTime = itemLastTime;
                  }
                }
                
                // åˆå¹¶è®°å½•ID
                if (item.recordIds) {
                  item.recordIds.forEach(id => {
                    if (!group.recordIds.includes(id)) {
                      group.recordIds.push(id);
                    }
                  });
                }
              }
            });
            
            // è½¬æ¢ä¸ºæ•°ç»„å¹¶æŒ‰æ—¶é—´æ’åº
            const dailyDeviceRecords = Object.values(deviceGroups);
            
            // æ—¥æœŸåˆ†ç»„æ ‡é¢˜è¡Œ
            const totalVisits = records.length;
            const mergedCount = dailyDeviceRecords.length;
            html += `<tr class="date-group-header ${isToday ? '' : 'collapsed'}" data-date="${date}">
              <td colspan="7" style="padding: 8px 12px;">
                <span class="toggle-icon">â–¼</span>
                <strong>${dateDisplay}</strong>
              </td>
            </tr>`;
            
            dailyDeviceRecords.forEach(item => {
              const deviceId = item.deviceId || 'unknown';
              // æ„å»ºåœ¨çº¿æ—¶é•¿æ˜¾ç¤ºï¼ˆç´¯è®¡ä¸€å¤©çš„æ€»æ—¶é•¿ï¼‰
              let durationDisplay = '-';
              const firstTime = item.firstTime;
              const lastTime = item.lastTime;
              
              if (firstTime && lastTime) {
                // è®¡ç®—ä»æœ€æ—©åˆ°æœ€æ™šçš„æ€»æ—¶é•¿ï¼ˆç´¯è®¡ä¸€å¤©çš„æ€»æ—¶é•¿ï¼‰
                const startTime = Math.min(firstTime, lastTime);
                const endTime = Math.max(firstTime, lastTime);
                const duration = Math.floor((endTime - startTime) / 1000);
                
                if (duration > 0) {
                  // å°†æœ¬æ—¥è¯¥è®¾å¤‡çš„åœ¨çº¿ç§’æ•°ç´¯åŠ åˆ°å…¨å±€æ˜ å°„ï¼Œç”¨äºåç»­è®¾å¤‡é¥¼å›¾
                  deviceOnlineSeconds[deviceId] = (deviceOnlineSeconds[deviceId] || 0) + duration;
                  if (duration < 60) {
                    durationDisplay = `${duration}ç§’`;
                  } else if (duration < 3600) {
                    const minutes = Math.floor(duration / 60);
                    const seconds = duration % 60;
                    durationDisplay = seconds > 0 ? `${minutes}åˆ†${seconds}ç§’` : `${minutes}åˆ†é’Ÿ`;
                  } else {
                    const hours = Math.floor(duration / 3600);
                    const minutes = Math.floor((duration % 3600) / 60);
                    const seconds = duration % 60;
                    if (minutes > 0 && seconds > 0) {
                      durationDisplay = `${hours}å°æ—¶${minutes}åˆ†${seconds}ç§’`;
                    } else if (minutes > 0) {
                      durationDisplay = `${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
                    } else {
                      durationDisplay = `${hours}å°æ—¶`;
                    }
                  }
                } else {
                  // å…¼å®¹è€ç‰ˆæœ¬ï¼šæ£€æŸ¥æ˜¯å¦æœ‰è®¿é—®æ¬¡æ•°
                  const count = item.totalCount || item.count || 1;
                  if (count > 1) {
                    // å¦‚æœåªæœ‰ä¸€æ¡è®°å½•ä½† count > 1ï¼Œå¯èƒ½æ˜¯åŒä¸€æ—¶é—´ç‚¹çš„å¤šæ¬¡è®¿é—®
                    durationDisplay = '0ç§’';
                  }
                }
              } else {
                // å…¼å®¹è€ç‰ˆæœ¬ï¼šæ£€æŸ¥æ˜¯å¦æœ‰è®¿é—®æ¬¡æ•°
                const count = item.totalCount || item.count || 1;
                if (count > 1) {
                  // è€ç‰ˆæœ¬æ•°æ®å¯èƒ½æ²¡æœ‰æ—¶é—´æˆ³ï¼Œä½†æœ‰å¤šæ¡è®°å½•ï¼Œæ˜¾ç¤ºæç¤º
                  durationDisplay = 'æœªçŸ¥';
                }
              }
              
              // å…¼å®¹è€ç‰ˆæœ¬ï¼šä½¿ç”¨ totalCount æˆ– count
              const totalCount = item.totalCount || item.count || 1;
              
              // æ ¼å¼åŒ–æ“ä½œç³»ç»Ÿæ˜¾ç¤º
              const osDisplay = formatOSDisplay(item.os);
              
              html += `<tr class="date-group-rows ${isToday ? '' : 'collapsed'}" data-date="${date}">
                <td style="vertical-align:middle; text-align:left; line-height:1.5;">${getCountryFlag(item.country) || '-'}</td>
                <td style="vertical-align:middle; text-align:left; line-height:1.5;">${getCityName(item.city)}</td>
                <td style="vertical-align:middle; text-align:left; line-height:1.5;">${osDisplay}</td>
                <td style="vertical-align:middle; text-align:left; line-height:1.5;">${item.version || '-'}</td>
                <td style="vertical-align:middle; text-align:left; line-height:1.5; font-family:monospace; word-break:break-all;">${deviceId}</td>
                <td style="vertical-align:middle; text-align:left; line-height:1.5;">${durationDisplay}</td>
              </tr>`;
            });
          });
          
          tbody.innerHTML = html;
          
          // ç»‘å®šç‚¹å‡»äº‹ä»¶
          document.querySelectorAll('.date-group-header').forEach(header => {
            header.addEventListener('click', function() {
              const date = this.dataset.date;
              const isCollapsed = this.classList.contains('collapsed');
              this.classList.toggle('collapsed');
              document.querySelectorAll(`tr.date-group-rows[data-date="${date}"]`).forEach(row => {
                row.classList.toggle('collapsed');
              });
            });
          });
          
          // ä¿å­˜ allRecords åˆ°å…¨å±€å˜é‡ä¾›ä¸‹è½½ä½¿ç”¨
          window.allRecords = allRecords;
        }
        
        // ç¾åŒ–è®¾å¤‡ç»Ÿè®¡æ˜¾ç¤º - é¥¼å›¾ï¼ˆæŒ‰è¿‡æ»¤åç´¯è®¡åœ¨çº¿æ—¶é•¿å æ¯”ï¼›è‹¥æ— åœ¨çº¿æ—¶é•¿æ•°æ®åˆ™æŒ‰è®¾å¤‡æ•°é‡ï¼‰
        const deviceElement = document.getElementById('stat-by-device');
        if (deviceElement) {
          let byDeviceForChart = {};
          // ä¼˜å…ˆä½¿ç”¨ deviceOnlineSecondsï¼ˆç§’ï¼‰ï¼Œæ²¡æœ‰æ—¶æ‰é€€å›åˆ°æŒ‰è®¾å¤‡æ•°é‡ç»Ÿè®¡
          if (Object.keys(deviceOnlineSeconds).length) {
            byDeviceForChart = { ...deviceOnlineSeconds };
          } else {
            byDeviceForChart = { ...byDeviceDevices };
          }
          const deviceEntries = Object.entries(byDeviceForChart)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10);
          if (deviceEntries.length) {
            const pieData = deviceEntries.map(([k, v]) => ({
              label: k,
              value: v
            }));
            deviceElement.innerHTML = createPieChartHTML('stat-by-device', pieData, {
              size: 180,
              formatValue: (value) => {
                // å°†æ€»åœ¨çº¿ç§’æ•°è½¬ä¸ºæ›´æ˜“è¯»çš„æ—¶é•¿æ˜¾ç¤º
                const seconds = Math.floor(value || 0);
                if (seconds <= 0) return '0ç§’';
                if (seconds < 60) return `${seconds}ç§’`;
                if (seconds < 3600) {
                  const m = Math.floor(seconds / 60);
                  const s = seconds % 60;
                  return s > 0 ? `${m}åˆ†${s}ç§’` : `${m}åˆ†é’Ÿ`;
                }
                const h = Math.floor(seconds / 3600);
                const m = Math.floor((seconds % 3600) / 60);
                const s = seconds % 60;
                if (h > 0 && m > 0 && s > 0) return `${h}å°æ—¶${m}åˆ†${s}ç§’`;
                if (h > 0 && m > 0) return `${h}å°æ—¶${m}åˆ†é’Ÿ`;
                return `${h}å°æ—¶`;
              },
              formatLabel: (label, value, index) => {
                const rankIcon = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : 'ğŸ“±';
                return `${rankIcon} ${label}`;
              }
            });
          } else {
            deviceElement.textContent = '-';
          }
        }
        showStatus('changelog-status', 'ä½¿ç”¨ç»Ÿè®¡åŠ è½½æˆåŠŸ', 'success');
      } catch (e) {
        console.error('åŠ è½½ä½¿ç”¨ç»Ÿè®¡å¤±è´¥:', e);
        showStatus('changelog-status', `åŠ è½½ä½¿ç”¨ç»Ÿè®¡å¤±è´¥ï¼š${e.message}`, 'error');
        if (statUsersEl) statUsersEl.textContent = '-';
        if (statUniqueEl) statUniqueEl.textContent = '-';
        if (statByCountryEl) statByCountryEl.textContent = 'åŠ è½½å¤±è´¥';
        if (statByVersionEl) statByVersionEl.textContent = '-';
        if (statByOsEl) statByOsEl.textContent = '-';
        if (statByDeviceEl) statByDeviceEl.textContent = '-';
        if (statRecentTbodyEl) statRecentTbodyEl.innerHTML = '<tr><td colspan="7" class="empty-state">åŠ è½½å¤±è´¥ï¼š' + e.message + '</td></tr>';
        window.allRecords = [];
      }
    });

    // ä» KV è¿ç§»å†å²æ•°æ®åˆ° D1ï¼ˆåˆ†æ‰¹è‡ªåŠ¨ç»§ç»­ï¼Œé¿å…è¶…æ—¶ï¼‰
    document.getElementById('btn-migrate-kv-to-d1').addEventListener('click', async () => {
      const cfg = getConfig();
      if (!cfg.apiBase) {
        showStatus('changelog-status', 'è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API åœ°å€', 'error');
        return;
      }
      if (!cfg.token) {
        showStatus('changelog-status', 'è¿ç§»éœ€è¦è®¤è¯ Tokenï¼Œè¯·åœ¨è®¾ç½®ä¸­é…ç½®', 'error');
        return;
      }
      const base = (cfg.apiBase || '').replace(/\/+$/, '');
      let totalMigrated = 0, totalSkipped = 0, totalErrors = 0, batchNum = 0;
      let cursor = null;
      try {
        do {
          batchNum++;
          showStatus('changelog-status', `æ­£åœ¨è¿ç§»ç¬¬ ${batchNum} æ‰¹...`, 'info');
          const res = await fetch(base + '/admin/migrate-telemetry-kv-to-d1', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + cfg.token, 'Accept': 'application/json', 'Content-Type': 'application/json' },
            body: JSON.stringify(cursor ? { cursor } : {})
          });
          const data = await res.json();
          if (!data.ok) {
            showStatus('changelog-status', 'è¿ç§»å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
            return;
          }
          totalMigrated += data.migrated || 0;
          totalSkipped += data.skipped || 0;
          totalErrors += data.errors || 0;
          cursor = data.hasMore && data.nextCursor ? data.nextCursor : null;
        } while (cursor);
        showStatus('changelog-status', `âœ… è¿ç§»å®Œæˆï¼šæˆåŠŸ ${totalMigrated} æ¡ï¼Œè·³è¿‡ ${totalSkipped} æ¡ï¼Œå¤±è´¥ ${totalErrors} æ¡`, 'success');
        document.getElementById('btn-refresh-usage').click();
      } catch (e) {
        showStatus('changelog-status', 'è¿ç§»å¤±è´¥ï¼š' + e.message, 'error');
      }
    });

    // è·å–æ“ä½œç³»ç»Ÿå¯¹åº”çš„å›¾æ ‡ï¼ˆç”¨äºç»Ÿè®¡æ˜¾ç¤ºï¼‰
    function getOSIconForStat(os) {
      if (!os) return 'ğŸ’»';
      const osLower = os.toLowerCase();
      
      if (osLower.includes('windows')) return 'ğŸªŸ';
      if (osLower.includes('mac') || osLower.includes('darwin')) return 'ğŸ';
      if (osLower.includes('linux')) return 'ğŸ§';
      if (osLower.includes('android')) return 'ğŸ¤–';
      if (osLower.includes('ios')) return 'ğŸ“±';
      
      return 'ğŸ’»';
    }
    
    // è§£æWindowsç‰ˆæœ¬å·åˆ°22H2æ ¼å¼
    function parseWindowsVersion(os) {
      if (!os) return os;
      const osLower = os.toLowerCase();
      if (!osLower.includes('windows')) return os;
      
      // æå–æ„å»ºå·ï¼ˆBuild numberï¼‰
      const buildMatch = os.match(/build\s*(\d+)|(\d+\.\d+\.(\d+))/i);
      let buildNumber = null;
      if (buildMatch) {
        buildNumber = parseInt(buildMatch[1] || buildMatch[3] || '0');
      }
      
      // å¦‚æœæ²¡æœ‰æ„å»ºå·ï¼Œå°è¯•ä»ç‰ˆæœ¬å·ä¸­æå–ï¼ˆå¦‚ 10.0.26200ï¼‰
      if (!buildNumber) {
        const versionMatch = os.match(/(\d+)\.(\d+)\.(\d+)/);
        if (versionMatch) {
          buildNumber = parseInt(versionMatch[3] || '0');
        }
      }
      
      // Windowsç‰ˆæœ¬æ˜ å°„è¡¨ï¼ˆBuildå· -> ç‰ˆæœ¬å·ï¼‰
      const windowsVersionMap = {
        // Windows 11
        26200: 'Windows 11 25H2',
        26100: 'Windows 11 24H2',
        22631: 'Windows 11 23H2',
        22621: 'Windows 11 22H2',
        22000: 'Windows 11 21H2',
        // Windows 10
        19045: 'Windows 10 22H2',
        19044: 'Windows 10 21H2',
        19043: 'Windows 10 21H1',
        19042: 'Windows 10 20H2',
        19041: 'Windows 10 2004',
        18363: 'Windows 10 19H2',
        18362: 'Windows 10 1903',
        17763: 'Windows 10 1809',
        17134: 'Windows 10 1803',
        16299: 'Windows 10 1709',
        15063: 'Windows 10 1703',
        14393: 'Windows 10 1607',
        10586: 'Windows 10 1511',
        10240: 'Windows 10 1507',
        // Windows 8.1
        9600: 'Windows 8.1',
        // Windows 8
        9200: 'Windows 8',
        // Windows 7
        7601: 'Windows 7 SP1',
        7600: 'Windows 7',
        // Windows Vista
        6002: 'Windows Vista SP2',
        6001: 'Windows Vista SP1',
        6000: 'Windows Vista',
        // Windows XP
        2600: 'Windows XP'
      };
      
      if (buildNumber) {
        // ç²¾ç¡®åŒ¹é…
        if (windowsVersionMap[buildNumber]) {
          return windowsVersionMap[buildNumber];
        }
        
        // èŒƒå›´åŒ¹é…ï¼ˆWindows 11ï¼‰
        if (buildNumber >= 26200) return 'Windows 11 25H2';
        if (buildNumber >= 26100) return 'Windows 11 24H2';
        if (buildNumber >= 22631) return 'Windows 11 23H2';
        if (buildNumber >= 22621) return 'Windows 11 22H2';
        if (buildNumber >= 22000) return 'Windows 11 21H2';
        
        // èŒƒå›´åŒ¹é…ï¼ˆWindows 10ï¼‰
        if (buildNumber >= 19045) return 'Windows 10 22H2';
        if (buildNumber >= 19041) return 'Windows 10 21H2';
        if (buildNumber >= 18363) return 'Windows 10 19H2';
        if (buildNumber >= 17763) return 'Windows 10 1809';
        if (buildNumber >= 17134) return 'Windows 10 1803';
        if (buildNumber >= 16299) return 'Windows 10 1709';
        if (buildNumber >= 15063) return 'Windows 10 1703';
        if (buildNumber >= 14393) return 'Windows 10 1607';
        if (buildNumber >= 10586) return 'Windows 10 1511';
        if (buildNumber >= 10240) return 'Windows 10 1507';
        
        // èŒƒå›´åŒ¹é…ï¼ˆWindows 8.1ï¼‰
        if (buildNumber >= 9600) return 'Windows 8.1';
        
        // èŒƒå›´åŒ¹é…ï¼ˆWindows 8ï¼‰
        if (buildNumber >= 9200) return 'Windows 8';
        
        // èŒƒå›´åŒ¹é…ï¼ˆWindows 7ï¼‰
        if (buildNumber >= 7600) return 'Windows 7';
        
        // èŒƒå›´åŒ¹é…ï¼ˆWindows Vistaï¼‰
        if (buildNumber >= 6000) return 'Windows Vista';
        
        // èŒƒå›´åŒ¹é…ï¼ˆWindows XPï¼‰
        if (buildNumber >= 2600) return 'Windows XP';
      }
      
      // å¦‚æœæ— æ³•è§£æï¼Œå°è¯•ä»åŸå§‹å­—ç¬¦ä¸²ä¸­æå–ä¿¡æ¯
      if (osLower.includes('windows 11')) return 'Windows 11';
      if (osLower.includes('windows 10')) return 'Windows 10';
      if (osLower.includes('windows 8.1') || osLower.includes('windows 8.1')) return 'Windows 8.1';
      if (osLower.includes('windows 8')) return 'Windows 8';
      if (osLower.includes('windows 7')) return 'Windows 7';
      if (osLower.includes('windows vista')) return 'Windows Vista';
      if (osLower.includes('windows xp')) return 'Windows XP';
      
      return os;
    }
    
    // è·å–æ“ä½œç³»ç»Ÿå¯¹åº”çš„å›¾æ ‡ï¼ˆç”¨äºè¡¨æ ¼æ˜¾ç¤ºï¼‰
    function getOSIcon(os) {
      return getOSIconForStat(os);
    }
    
    // æ ¼å¼åŒ–æ“ä½œç³»ç»Ÿæ˜¾ç¤ºï¼ˆå¸¦å›¾æ ‡å’Œç‰ˆæœ¬ï¼‰
    function formatOSDisplay(os) {
      if (!os) return 'Unknown';
      const icon = getOSIcon(os);
      const formatted = parseWindowsVersion(os);
      return `${icon} ${formatted}`;
    }
    
    // è·å–å›½å®¶/åœ°åŒºå¯¹åº”çš„ä¸­æ–‡åç§°
    function getCountryFlag(countryCode) {
      const countryNames = {
        'HK': 'é¦™æ¸¯', 'CN': 'ä¸­å›½', 'US': 'ç¾å›½', 'JP': 'æ—¥æœ¬', 'KR': 'éŸ©å›½',
        'GB': 'è‹±å›½', 'FR': 'æ³•å›½', 'DE': 'å¾·å›½', 'CA': 'åŠ æ‹¿å¤§', 'AU': 'æ¾³å¤§åˆ©äºš',
        'SG': 'æ–°åŠ å¡', 'TW': 'å°æ¹¾', 'MY': 'é©¬æ¥è¥¿äºš', 'TH': 'æ³°å›½', 'VN': 'è¶Šå—',
        'IN': 'å°åº¦', 'ID': 'å°åº¦å°¼è¥¿äºš', 'PH': 'è²å¾‹å®¾', 'BR': 'å·´è¥¿', 'MX': 'å¢¨è¥¿å“¥',
        'RU': 'ä¿„ç½—æ–¯', 'IT': 'æ„å¤§åˆ©', 'ES': 'è¥¿ç­ç‰™', 'NL': 'è·å…°', 'SE': 'ç‘å…¸',
        'NO': 'æŒªå¨', 'DK': 'ä¸¹éº¦', 'FI': 'èŠ¬å…°', 'PL': 'æ³¢å…°', 'TR': 'åœŸè€³å…¶'
      };
      return countryNames[countryCode] || 'å…¶ä»–';
    }
    
    // è·å–åŸå¸‚å¯¹åº”çš„ä¸­æ–‡åç§°
    function getCityName(cityName) {
      if (!cityName) return '-';
      
      const cityNames = {
        // ä¸­å›½åŸå¸‚
        'Shanghai': 'ä¸Šæµ·', 'Beijing': 'åŒ—äº¬', 'Guangzhou': 'å¹¿å·', 'Shenzhen': 'æ·±åœ³',
        'Chengdu': 'æˆéƒ½', 'Hangzhou': 'æ­å·', 'Nanjing': 'å—äº¬', 'Wuhan': 'æ­¦æ±‰',
        'Xi\'an': 'è¥¿å®‰', 'Suzhou': 'è‹å·', 'Tianjin': 'å¤©æ´¥', 'Chongqing': 'é‡åº†',
        'Dongguan': 'ä¸œè', 'Qingdao': 'é’å²›', 'Dalian': 'å¤§è¿', 'Xiamen': 'å¦é—¨',
        'Foshan': 'ä½›å±±', 'Jinan': 'æµå—', 'Changsha': 'é•¿æ²™', 'Zhengzhou': 'éƒ‘å·',
        'Kunming': 'æ˜†æ˜', 'Shenyang': 'æ²ˆé˜³', 'Shijiazhuang': 'çŸ³å®¶åº„', 'Fuzhou': 'ç¦å·',
        'Ningbo': 'å®æ³¢', 'Hefei': 'åˆè‚¥', 'Changchun': 'é•¿æ˜¥', 'Harbin': 'å“ˆå°”æ»¨',
        'Taiyuan': 'å¤ªåŸ', 'Nanchang': 'å—æ˜Œ', 'Guiyang': 'è´µé˜³', 'Lanzhou': 'å…°å·',
        'Urumqi': 'ä¹Œé²æœ¨é½', 'Hohhot': 'å‘¼å’Œæµ©ç‰¹', 'Yinchuan': 'é“¶å·', 'Lhasa': 'æ‹‰è¨',
        'Haikou': 'æµ·å£', 'Sanya': 'ä¸‰äºš', 'Zhuhai': 'ç æµ·', 'Macau': 'æ¾³é—¨',
        
        // é¦™æ¸¯
        'Hong Kong': 'é¦™æ¸¯', 'Kwai Chung': 'è‘µæ¶Œ', 'Central': 'ä¸­ç¯', 'Tsim Sha Tsui': 'å°–æ²™å’€',
        'Causeway Bay': 'é“œé”£æ¹¾', 'Mong Kok': 'æ—ºè§’', 'Sha Tin': 'æ²™ç”°', 'Tuen Mun': 'å±¯é—¨',
        'Yuen Long': 'å…ƒæœ—', 'Tai Po': 'å¤§åŸ”', 'North Point': 'åŒ—è§’', 'Wan Chai': 'æ¹¾ä»”',
        
        // å°æ¹¾
        'Taipei': 'å°åŒ—', 'New Taipei': 'æ–°åŒ—', 'Kaohsiung': 'é«˜é›„', 'Taichung': 'å°ä¸­',
        'Tainan': 'å°å—', 'Hsinchu': 'æ–°ç«¹', 'Keelung': 'åŸºéš†', 'Taoyuan': 'æ¡ƒå›­',
        
        // æ—¥æœ¬
        'Tokyo': 'ä¸œäº¬', 'Osaka': 'å¤§é˜ª', 'Kyoto': 'äº¬éƒ½', 'Yokohama': 'æ¨ªæ»¨',
        'Nagoya': 'åå¤å±‹', 'Sapporo': 'æœ­å¹Œ', 'Fukuoka': 'ç¦å†ˆ', 'Kobe': 'ç¥æˆ·',
        
        // éŸ©å›½
        'Seoul': 'é¦–å°”', 'Busan': 'é‡œå±±', 'Incheon': 'ä»å·', 'Daegu': 'å¤§é‚±',
        'Daejeon': 'å¤§ç”°', 'Gwangju': 'å…‰å·', 'Ulsan': 'è”šå±±',
        
        // ç¾å›½
        'New York': 'çº½çº¦', 'Los Angeles': 'æ´›æ‰çŸ¶', 'Chicago': 'èŠåŠ å“¥', 'Houston': 'ä¼‘æ–¯é¡¿',
        'Phoenix': 'å‡¤å‡°åŸ', 'Philadelphia': 'è´¹åŸ', 'San Antonio': 'åœ£å®‰ä¸œå°¼å¥¥', 'San Diego': 'åœ£åœ°äºšå“¥',
        'Dallas': 'è¾¾æ‹‰æ–¯', 'San Jose': 'åœ£ä½•å¡', 'San Francisco': 'æ—§é‡‘å±±', 'Seattle': 'è¥¿é›…å›¾',
        'Boston': 'æ³¢å£«é¡¿', 'Miami': 'è¿ˆé˜¿å¯†', 'Washington': 'åç››é¡¿', 'Atlanta': 'äºšç‰¹å…°å¤§',
        
        // è‹±å›½
        'London': 'ä¼¦æ•¦', 'Manchester': 'æ›¼å½»æ–¯ç‰¹', 'Birmingham': 'ä¼¯æ˜ç¿°', 'Liverpool': 'åˆ©ç‰©æµ¦',
        'Leeds': 'åˆ©å…¹', 'Glasgow': 'æ ¼æ‹‰æ–¯å“¥', 'Edinburgh': 'çˆ±ä¸å ¡',
        
        // å…¶ä»–å¸¸è§åŸå¸‚
        'Singapore': 'æ–°åŠ å¡', 'Bangkok': 'æ›¼è°·', 'Kuala Lumpur': 'å‰éš†å¡', 'Jakarta': 'é›…åŠ è¾¾',
        'Manila': 'é©¬å°¼æ‹‰', 'Ho Chi Minh City': 'èƒ¡å¿—æ˜å¸‚', 'Hanoi': 'æ²³å†…', 'Sydney': 'æ‚‰å°¼',
        'Melbourne': 'å¢¨å°”æœ¬', 'Toronto': 'å¤šä¼¦å¤š', 'Vancouver': 'æ¸©å“¥å', 'Montreal': 'è’™ç‰¹åˆ©å°”',
        'Paris': 'å·´é»', 'Berlin': 'æŸæ—', 'Munich': 'æ…•å°¼é»‘', 'Rome': 'ç½—é©¬', 'Milan': 'ç±³å…°',
        'Madrid': 'é©¬å¾·é‡Œ', 'Barcelona': 'å·´å¡ç½—é‚£', 'Amsterdam': 'é˜¿å§†æ–¯ç‰¹ä¸¹', 'Brussels': 'å¸ƒé²å¡å°”',
        'Vienna': 'ç»´ä¹Ÿçº³', 'Stockholm': 'æ–¯å¾·å“¥å°”æ‘©', 'Copenhagen': 'å“¥æœ¬å“ˆæ ¹', 'Oslo': 'å¥¥æ–¯é™†',
        'Helsinki': 'èµ«å°”è¾›åŸº', 'Moscow': 'è«æ–¯ç§‘', 'Saint Petersburg': 'åœ£å½¼å¾—å ¡',
        'Dubai': 'è¿ªæ‹œ', 'Abu Dhabi': 'é˜¿å¸ƒæ‰æ¯”', 'Riyadh': 'åˆ©é›…å¾—', 'Tel Aviv': 'ç‰¹æ‹‰ç»´å¤«',
        'Mumbai': 'å­Ÿä¹°', 'Delhi': 'å¾·é‡Œ', 'Bangalore': 'ç­åŠ ç½—å°”', 'Kolkata': 'åŠ å°”å„ç­”',
        'SÃ£o Paulo': 'åœ£ä¿ç½—', 'Rio de Janeiro': 'é‡Œçº¦çƒ­å†…å¢', 'Buenos Aires': 'å¸ƒå®œè¯ºæ–¯è‰¾åˆ©æ–¯',
        'Mexico City': 'å¢¨è¥¿å“¥åŸ', 'Lima': 'åˆ©é©¬', 'BogotÃ¡': 'æ³¢å“¥å¤§'
      };
      
      // å…ˆå°è¯•ç²¾ç¡®åŒ¹é…
      if (cityNames[cityName]) {
        return cityNames[cityName];
      }
      
      // å°è¯•ä¸åŒºåˆ†å¤§å°å†™åŒ¹é…
      const cityLower = cityName.toLowerCase();
      for (const [key, value] of Object.entries(cityNames)) {
        if (key.toLowerCase() === cityLower) {
          return value;
        }
      }
      
      // å°è¯•æ¨¡ç³ŠåŒ¹é…ï¼ˆå¤„ç† Cloudflare è¿”å›çš„åŸå¸‚åç§°å˜ä½“ï¼‰
      // ä¾‹å¦‚ï¼šXi'anxiufu -> Xi'an (è¥¿å®‰)
      const fuzzyMatches = [
        { pattern: /xi['\s]*an/i, name: 'è¥¿å®‰' },
        { pattern: /xian/i, name: 'è¥¿å®‰' },
        { pattern: /shaanxi/i, name: 'é™•è¥¿' },
        { pattern: /shanxi/i, name: 'å±±è¥¿' }
      ];
      
      // æ£€æŸ¥æ˜¯å¦åŒ…å«å·²çŸ¥çš„åŸå¸‚åç§°å…³é”®è¯
      for (const { pattern, name } of fuzzyMatches) {
        if (pattern.test(cityName)) {
          return name;
        }
      }
      
      // æ£€æŸ¥æ˜¯å¦ä»¥å·²çŸ¥åŸå¸‚åç§°å¼€å¤´æˆ–åŒ…å«
      for (const [key, value] of Object.entries(cityNames)) {
        const keyLower = key.toLowerCase();
        // å¦‚æœåŸå¸‚åç§°åŒ…å«å·²çŸ¥åŸå¸‚åï¼ˆè‡³å°‘3ä¸ªå­—ç¬¦åŒ¹é…ï¼‰
        if (keyLower.length >= 3) {
          // æå–åŸå¸‚åçš„ä¸»è¦éƒ¨åˆ†ï¼ˆå»é™¤ç©ºæ ¼å’Œç‰¹æ®Šå­—ç¬¦ï¼‰
          const keyMain = keyLower.replace(/['\s-]/g, '');
          const cityMain = cityLower.replace(/['\s-]/g, '');
          
          // å¦‚æœåŒ…å«å®Œæ•´çš„åŸå¸‚åä¸»è¦éƒ¨åˆ†
          if (cityMain.includes(keyMain) || keyMain.includes(cityMain.substring(0, Math.min(keyMain.length, cityMain.length)))) {
            return value;
          }
        }
      }
      
      // å¦‚æœæ‰¾ä¸åˆ°åŒ¹é…ï¼Œè¿”å›åŸåç§°
      return cityName;
    }
    
    // ç”Ÿæˆé¥¼å›¾é¢œè‰²æ•°ç»„
    function generatePieColors(count) {
      const baseColors = [
        '#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe',
        '#43e97b', '#fa709a', '#fee140', '#30cfd0', '#a8edea',
        '#ff9a9e', '#fecfef', '#fecfef', '#ffecd2', '#fcb69f',
        '#ff8a80', '#ffd54f', '#81c784', '#64b5f6', '#ba68c8'
      ];
      const colors = [];
      for (let i = 0; i < count; i++) {
        colors.push(baseColors[i % baseColors.length]);
      }
      return colors;
    }
    
    // ç»˜åˆ¶é¥¼å›¾
    function drawPieChart(canvasId, data, options = {}) {
      const canvas = document.getElementById(canvasId);
      if (!canvas || !data || data.length === 0) return;
      
      const size = options.size || 200;
      const centerX = size / 2;
      const centerY = size / 2;
      const radius = (size - 20) / 2;
      
      canvas.width = size;
      canvas.height = size;
      const ctx = canvas.getContext('2d');
      
      // è®¡ç®—æ€»æ•°
      const total = data.reduce((sum, item) => sum + item.value, 0);
      if (total === 0) return;
      
      // ç”Ÿæˆé¢œè‰²
      const colors = options.colors || generatePieColors(data.length);
      
      // ç»˜åˆ¶é¥¼å›¾
      let currentAngle = -Math.PI / 2; // ä»é¡¶éƒ¨å¼€å§‹
      
      data.forEach((item, index) => {
        const sliceAngle = (item.value / total) * 2 * Math.PI;
        
        // ç»˜åˆ¶æ‰‡å½¢
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
        ctx.closePath();
        ctx.fillStyle = colors[index];
        ctx.fill();
        
        // æ·»åŠ è¾¹æ¡†
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        currentAngle += sliceAngle;
      });
    }
    
    // åˆ›å»ºé¥¼å›¾HTML
    function createPieChartHTML(containerId, data, options = {}) {
      if (!data || data.length === 0) return '<div style="color:#999;">æš‚æ— æ•°æ®</div>';
      
      const canvasId = `${containerId}-canvas`;
      const colors = options.colors || generatePieColors(data.length);
      const total = data.reduce((sum, item) => sum + item.value, 0);
      
      // ç”Ÿæˆå›¾ä¾‹
      const legendHTML = data.map((item, index) => {
        const percent = total > 0 ? ((item.value / total) * 100).toFixed(1) : 0;
        const label = options.formatLabel ? options.formatLabel(item.label, item.value, index, item) : item.label;
        const displayValue = options.formatValue ? options.formatValue(item.value, item.label, index, item) : item.value;
        return `
          <div class="pie-legend-item">
            <div class="pie-legend-color" style="background:${colors[index]};"></div>
            <div class="pie-legend-label">${label}</div>
            <div class="pie-legend-value">${displayValue} (${percent}%)</div>
          </div>
        `;
      }).join('');
      
      const html = `
        <div class="pie-chart-container">
          <div class="pie-chart-wrapper">
            <canvas id="${canvasId}" class="pie-chart-canvas"></canvas>
          </div>
          <div class="pie-chart-legend">
            ${legendHTML}
          </div>
        </div>
      `;
      
      // å»¶è¿Ÿç»˜åˆ¶ï¼Œç¡®ä¿DOMå·²æ›´æ–°
      setTimeout(() => {
        drawPieChart(canvasId, data, options);
      }, 10);
      
      return html;
    }
    
    // åˆå¹¶åŒä¸€è®¾å¤‡çŸ­æ—¶é—´å†…çš„é‡å¤è®¿é—®è®°å½•ï¼ˆä¿ç•™åŸå§‹è®°å½• ID åˆ—è¡¨ï¼‰
    function mergeRepeatedVisits(records, timeWindow) {
      if (!records || records.length === 0) return [];
      
      // å…¼å®¹è€ç‰ˆæœ¬ï¼šæ”¯æŒä¸åŒçš„æ—¶é—´æˆ³å­—æ®µå
      const getTimestamp = (record) => {
        return record.ts || record.timestamp || record.time || (record.date ? new Date(record.date).getTime() : 0);
      };
      
      // æŒ‰æ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
      const sorted = [...records].sort((a, b) => getTimestamp(b) - getTimestamp(a));
      
      const merged = [];
      let currentGroup = null;
      
      for (const record of sorted) {
        const deviceKey = `${record.deviceId || record.device_id || 'unknown'}_${record.version || 'unknown'}_${record.country || 'unknown'}_${record.city || 'unknown'}_${record.os || 'unknown'}`;
        const recordTs = getTimestamp(record);
        
        // å¦‚æœæ˜¯æ–°è®¾å¤‡æˆ–æ—¶é—´é—´éš”è¶…è¿‡é˜ˆå€¼ï¼Œå¼€å§‹æ–°åˆ†ç»„
        if (!currentGroup || 
            currentGroup.key !== deviceKey || 
            (currentGroup.firstTime - recordTs > timeWindow)) {
          // ä¿å­˜å½“å‰åˆ†ç»„
          if (currentGroup) {
            merged.push({
              deviceId: currentGroup.deviceId,
              version: currentGroup.version,
              country: currentGroup.country,
              city: currentGroup.city,
              os: currentGroup.os,
              firstTime: currentGroup.firstTime,
              lastTime: currentGroup.lastTime,
              count: currentGroup.count,
              recordIds: currentGroup.recordIds // ä¿ç•™åŸå§‹è®°å½• ID åˆ—è¡¨
            });
          }
          
          // å¼€å§‹æ–°åˆ†ç»„
          currentGroup = {
            key: deviceKey,
            deviceId: record.deviceId || record.device_id || 'unknown',
            version: record.version || 'unknown',
            country: record.country || '',
            city: record.city || '',
            os: record.os || '',
            firstTime: recordTs, // ç¬¬ä¸€ä¸ªè®°å½•çš„æ—¶é—´ï¼ˆæœ€æ–°çš„ï¼‰
            lastTime: recordTs,  // åˆå§‹åŒ–ä¸ºç¬¬ä¸€ä¸ªè®°å½•çš„æ—¶é—´
            count: 1,
            recordIds: [record.id || record._id || `${recordTs}_${(record.deviceId || record.device_id || 'unknown').substring(0, 8)}`] // ä¿å­˜åŸå§‹è®°å½• ID
          };
        } else {
          // åˆå¹¶åˆ°å½“å‰åˆ†ç»„
          currentGroup.count++;
          // æ›´æ–°æœ€æ—©æ—¶é—´ï¼ˆå› ä¸ºå·²æ’åºï¼Œå½“å‰è®°å½•çš„æ—¶é—´æ›´æ—©ï¼‰
          if (recordTs < currentGroup.lastTime) {
            currentGroup.lastTime = recordTs;
          }
          const recordId = record.id || record._id || `${recordTs}_${(record.deviceId || record.device_id || 'unknown').substring(0, 8)}`;
          if (!currentGroup.recordIds.includes(recordId)) {
            currentGroup.recordIds.push(recordId);
          }
        }
      }
      
      // ä¿å­˜æœ€åä¸€ä¸ªåˆ†ç»„
      if (currentGroup) {
        merged.push({
          deviceId: currentGroup.deviceId,
          version: currentGroup.version,
          country: currentGroup.country,
          city: currentGroup.city,
          os: currentGroup.os,
          firstTime: currentGroup.firstTime,
          lastTime: currentGroup.lastTime,
          count: currentGroup.count,
          recordIds: currentGroup.recordIds // ä¿ç•™åŸå§‹è®°å½• ID åˆ—è¡¨
        });
      }
      
      return merged;
    }
    
    // ä¸‹è½½è®¿é—®è®°å½•
    document.getElementById('btn-download-records').addEventListener('click', async () => {
      const cfg = getConfig();
      if (!cfg.apiBase) {
        alert('è¯·å…ˆè®¾ç½® API åœ°å€');
        return;
      }
      
      try {
        // è·å–æ‰€æœ‰è®°å½•
        const data = await callApi('GET', '/stats');
        const allRecords = data.all || data.recent || [];
        
        if (allRecords.length === 0) {
          alert('æš‚æ— è®¿é—®è®°å½•');
          return;
        }
        
        // å‡†å¤‡æ‰€æœ‰æ•°æ®ï¼ˆåŒ…å«ç»Ÿè®¡ä¿¡æ¯å’Œè®°å½•ï¼‰
        const statsData = {
          summary: {
            total: data.total || 0,
            uniqueDevices: data.uniqueDevices || 0,
            byCountry: data.byCountry || {},
            byVersion: data.byVersion || {},
            byOS: data.byOS || {},
            byDevice: data.byDevice || {}
          },
          records: allRecords
        };
        
        // è½¬æ¢ä¸º CSV æ ¼å¼ï¼ˆåŒ…å«ç»Ÿè®¡ä¿¡æ¯å’Œè®°å½•ï¼‰
        const csvLines = [];
        csvLines.push('=== ç»Ÿè®¡æ‘˜è¦ ===');
        csvLines.push(`æ€»è®¿é—®æ¬¡æ•°,${statsData.summary.total}`);
        csvLines.push(`ç‹¬ç«‹è®¾å¤‡æ•°,${statsData.summary.uniqueDevices}`);
        csvLines.push('');
        csvLines.push('=== æŒ‰å›½å®¶/åœ°åŒºç»Ÿè®¡ ===');
        csvLines.push('å›½å®¶/åœ°åŒº,è®¿é—®æ¬¡æ•°');
        Object.entries(statsData.summary.byCountry).forEach(([country, count]) => {
          csvLines.push(`"${country}",${count}`);
        });
        csvLines.push('');
        csvLines.push('=== æŒ‰ç‰ˆæœ¬ç»Ÿè®¡ ===');
        csvLines.push('ç‰ˆæœ¬,è®¿é—®æ¬¡æ•°');
        Object.entries(statsData.summary.byVersion).forEach(([version, count]) => {
          csvLines.push(`"${version}",${count}`);
        });
        csvLines.push('');
        csvLines.push('=== æŒ‰è®¾å¤‡ç»Ÿè®¡ ===');
        csvLines.push('è®¾å¤‡ID,è®¿é—®æ¬¡æ•°');
        Object.entries(statsData.summary.byDevice).forEach(([deviceId, count]) => {
          csvLines.push(`"${deviceId}",${count}`);
        });
        csvLines.push('');
        csvLines.push('=== è¯¦ç»†è®¿é—®è®°å½• ===');
        csvLines.push('æ—¶é—´,å›½å®¶/åœ°åŒº,åŸå¸‚,ç‰ˆæœ¬,è®¾å¤‡ID,IPåœ°å€');
        allRecords.forEach(r => {
          const t = r.ts ? new Date(r.ts).toISOString() : '';
          const row = [
            t,
            r.country || '',
            r.city || '',
            r.version || '',
            r.deviceId || 'unknown',
            r.ip || ''
          ].map(v => `"${String(v).replace(/"/g, '""')}"`).join(',');
          csvLines.push(row);
        });
        
        const csv = csvLines.join('\n');
        const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `metro-pids-all-data-${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        alert(`å·²ä¸‹è½½æ‰€æœ‰æ•°æ®ï¼ˆ${allRecords.length} æ¡è®¿é—®è®°å½• + ç»Ÿè®¡æ‘˜è¦ï¼‰`);
      } catch (e) {
        alert('ä¸‹è½½å¤±è´¥ï¼š' + e.message);
      }
    });
    
    // æ’é™¤çš„è®¾å¤‡IDï¼šå®æ—¶åŒæ­¥åˆ°æœ¬åœ°å’ŒæœåŠ¡å™¨ï¼ˆæ— éœ€ç‚¹å‡»åˆ·æ–°ï¼‰
    (function initExcludedDevicesAutoSync() {
      const textarea = document.getElementById('stat-excluded-devices');
      if (!textarea) return;
      let timer = null;
      textarea.addEventListener('input', () => {
        const text = textarea.value.trim();

        // æœ¬åœ°ä¿å­˜ï¼Œä¿è¯æœ¬æœºåˆ·æ–°æ—¶ä»èƒ½æ¢å¤
        const localCfg = loadConfig();
        localCfg.excludedDevices = text;
        saveConfig(localCfg);

        // éœ€è¦ API åœ°å€å’Œ Token æ‰åŒæ­¥åˆ°æœåŠ¡å™¨
        const cfg = loadConfig();
        if (!cfg.apiBase || !cfg.token) {
          console.warn('æœªé…ç½® API åœ°å€æˆ– Tokenï¼Œè·³è¿‡å®æ—¶åŒæ­¥æ’é™¤è®¾å¤‡IDåˆ°æœåŠ¡å™¨');
          return;
        }

        if (timer) clearTimeout(timer);
        timer = setTimeout(async () => {
          const ids = text
            .split(/[\n\r]+/)
            .map(s => s.trim())
            .filter(Boolean);
          try {
            await callApi('PUT', '/stats/config', { excludedDevices: ids });
            console.log('[Admin] âœ… å·²å®æ—¶åŒæ­¥æ’é™¤è®¾å¤‡IDåˆ°æœåŠ¡å™¨');
          } catch (e) {
            console.warn('[Admin] âš ï¸ å®æ—¶åŒæ­¥æ’é™¤è®¾å¤‡IDå¤±è´¥:', e);
          }
        }, 800);
      });
    })();

    // åˆå§‹åŒ–ï¼šå¯åŠ¨æ—¶è‡ªåŠ¨ä»æœåŠ¡å™¨åŠ è½½æ‰€æœ‰æ•°æ®
    window.addEventListener('DOMContentLoaded', () => {
      initSidebarNavigation();
      const savedConfig = loadConfig();
      document.getElementById('api-base').value = savedConfig.apiBase || '';
      document.getElementById('api-token').value = savedConfig.token || '';
      document.getElementById('api-base-display').textContent = savedConfig.apiBase || 'æœªè®¾ç½®';
      if (savedConfig.excludedDevices && document.getElementById('stat-excluded-devices')) {
        document.getElementById('stat-excluded-devices').value = savedConfig.excludedDevices;
      }
      const today = new Date();
      document.getElementById('holiday-query-date').value = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
      
      if (savedConfig.apiBase) {
        // å»¶è¿ŸåŠ è½½ï¼Œç¡®ä¿æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨å·²æ³¨å†Œ
        setTimeout(() => {
          console.log('[Admin] ğŸš€ å¼€å§‹è‡ªåŠ¨åŠ è½½æœåŠ¡å™¨æ•°æ®...');
          showAutoLoadModal();
          let step = 0;
          const totalSteps = 9;

          // 0. å°è¯•ä»æœåŠ¡å™¨åŠ è½½ç»Ÿè®¡é…ç½®ï¼ˆæ’é™¤çš„è®¾å¤‡IDåˆ—è¡¨ï¼‰ï¼Œè¦†ç›–æœ¬åœ°ç¼“å­˜ï¼Œæ”¯æŒè·¨è®¾å¤‡å…±äº«ï¼ˆéœ€è¦ Tokenï¼‰
          try {
            if (savedConfig.token) {
              callApi('GET', '/stats/config').then((cfg) => {
                const list = (cfg && cfg.config && Array.isArray(cfg.config.excludedDevices))
                  ? cfg.config.excludedDevices
                  : [];
                const text = list.join('\n');
                const textarea = document.getElementById('stat-excluded-devices');
                if (textarea) {
                  textarea.value = text;
                }
                const localCfg = loadConfig();
                localCfg.excludedDevices = text;
                saveConfig(localCfg);
                step++;
                updateAutoLoadProgress((step / totalSteps) * 100, 'å·²åŠ è½½ç»Ÿè®¡é…ç½®');
              }).catch((e) => {
                console.warn('ä»æœåŠ¡å™¨åŠ è½½ç»Ÿè®¡é…ç½®å¤±è´¥:', e);
              });
            } else {
              console.warn('æœªé…ç½® Tokenï¼Œè·³è¿‡ä»æœåŠ¡å™¨åŠ è½½ç»Ÿè®¡é…ç½®');
            }
          } catch (e) {
            console.warn('åˆå§‹åŒ–åŠ è½½ç»Ÿè®¡é…ç½®å‡ºé”™:', e);
          }
          
          // 1. åŠ è½½è¿æ§çº¿è·¯åˆ—è¡¨
          try {
            document.getElementById('btn-list-runtime').click();
            console.log('[Admin] âœ… å·²è§¦å‘è¿æ§çº¿è·¯åˆ—è¡¨åŠ è½½');
            step++;
            updateAutoLoadProgress((step / totalSteps) * 100, 'å·²åŠ è½½äº‘æ§çº¿è·¯');
          } catch (e) {
            console.warn('[Admin] âš ï¸ è¿æ§çº¿è·¯åˆ—è¡¨åŠ è½½å¤±è´¥:', e);
          }
          
          // 2. åŠ è½½æ›´æ–°æ—¥å¿—
          try {
            document.getElementById('btn-get-changelog').click();
            console.log('[Admin] âœ… å·²è§¦å‘æ›´æ–°æ—¥å¿—åŠ è½½');
            step++;
            updateAutoLoadProgress((step / totalSteps) * 100, 'å·²åŠ è½½æ›´æ–°æ—¥å¿—');
          } catch (e) {
            console.warn('[Admin] âš ï¸ æ›´æ–°æ—¥å¿—åŠ è½½å¤±è´¥:', e);
          }
          
          // 3. åŠ è½½ç‰ˆæœ¬ä¿¡æ¯
          try {
            document.getElementById('btn-get-update-info').click();
            console.log('[Admin] âœ… å·²è§¦å‘ç‰ˆæœ¬ä¿¡æ¯åŠ è½½');
            step++;
            updateAutoLoadProgress((step / totalSteps) * 100, 'å·²åŠ è½½ç‰ˆæœ¬ä¿¡æ¯');
          } catch (e) {
            console.warn('[Admin] âš ï¸ ç‰ˆæœ¬ä¿¡æ¯åŠ è½½å¤±è´¥:', e);
          }
          
          // 4. åŠ è½½ç»Ÿè®¡ä¿¡æ¯
          try {
            document.getElementById('btn-refresh-stats').click();
            console.log('[Admin] âœ… å·²è§¦å‘ç»Ÿè®¡ä¿¡æ¯åŠ è½½');
            step++;
            updateAutoLoadProgress((step / totalSteps) * 100, 'å·²åŠ è½½ç»Ÿè®¡ä¿¡æ¯');
          } catch (e) {
            console.warn('[Admin] âš ï¸ ç»Ÿè®¡ä¿¡æ¯åŠ è½½å¤±è´¥:', e);
          }
          
          // 5. åŠ è½½ä½¿ç”¨ç»Ÿè®¡
          try {
            document.getElementById('btn-refresh-usage').click();
            console.log('[Admin] âœ… å·²è§¦å‘ä½¿ç”¨ç»Ÿè®¡åŠ è½½');
            step++;
            updateAutoLoadProgress((step / totalSteps) * 100, 'å·²åŠ è½½ä½¿ç”¨ç»Ÿè®¡');
          } catch (e) {
            console.warn('[Admin] âš ï¸ ä½¿ç”¨ç»Ÿè®¡åŠ è½½å¤±è´¥:', e);
          }
          
          // 6. åŠ è½½å½©è›‹é…ç½®
          try {
            document.getElementById('btn-get-easter-eggs').click();
            console.log('[Admin] âœ… å·²è§¦å‘å½©è›‹é…ç½®åŠ è½½');
            step++;
            updateAutoLoadProgress((step / totalSteps) * 100, 'å·²åŠ è½½å½©è›‹é…ç½®');
          } catch (e) {
            console.warn('[Admin] âš ï¸ å½©è›‹é…ç½®åŠ è½½å¤±è´¥:', e);
          }
          
          // 7. åŠ è½½èŠ‚æ—¥é…ç½®
          try {
            document.getElementById('btn-get-holidays').click();
            console.log('[Admin] âœ… å·²è§¦å‘èŠ‚æ—¥é…ç½®åŠ è½½');
            step++;
            updateAutoLoadProgress((step / totalSteps) * 100, 'å·²åŠ è½½èŠ‚æ—¥é…ç½®');
          } catch (e) {
            console.warn('[Admin] âš ï¸ èŠ‚æ—¥é…ç½®åŠ è½½å¤±è´¥:', e);
          }

          // 8. åŠ è½½å¯åŠ¨å…¬å‘Šé…ç½®
          try {
            document.getElementById('btn-get-startup').click();
            console.log('[Admin] âœ… å·²è§¦å‘å¯åŠ¨å…¬å‘ŠåŠ è½½');
            step++;
            updateAutoLoadProgress((step / totalSteps) * 100, 'å·²åŠ è½½å¯åŠ¨å…¬å‘Š');
          } catch (e) {
            console.warn('[Admin] âš ï¸ å¯åŠ¨å…¬å‘ŠåŠ è½½å¤±è´¥:', e);
          }

          // 9. åŠ è½½æ˜¾ç¤ºç«¯åŠŸèƒ½é…ç½®
          try {
            document.getElementById('btn-get-display-flags').click();
            console.log('[Admin] âœ… å·²è§¦å‘æ˜¾ç¤ºç«¯åŠŸèƒ½åŠ è½½');
            step++;
            updateAutoLoadProgress((step / totalSteps) * 100, 'å·²åŠ è½½æ˜¾ç¤ºç«¯åŠŸèƒ½');
          } catch (e) {
            console.warn('[Admin] âš ï¸ æ˜¾ç¤ºç«¯åŠŸèƒ½åŠ è½½å¤±è´¥:', e);
          }
          
          console.log('[Admin] âœ… æ‰€æœ‰æ•°æ®åŠ è½½ä»»åŠ¡å·²å¯åŠ¨');
          setTimeout(() => {
            updateAutoLoadProgress(100, 'åŠ è½½å®Œæˆ');
            hideAutoLoadModal();
          }, 600);
        }, 800); // å»¶è¿Ÿ 800msï¼Œç¡®ä¿æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨å·²æ³¨å†Œ
      } else {
        console.log('[Admin] âš ï¸ API åœ°å€æœªé…ç½®ï¼Œè·³è¿‡è‡ªåŠ¨åŠ è½½');
      }
    });
  </script>
</body>
</html>