# 后台统计信息显示优化

## 📊 优化内容

### 问题
同一设备在短时间内反复访问会产生大量重复记录，占用大量显示空间，不便于查看。

例如：
```
HK  Kwai Chung  1.5.5  10f635d4-4fc...  2026/1/18 18:02:56
HK  Kwai Chung  1.5.5  10f635d4-4fc...  2026/1/18 18:02:39
HK  Kwai Chung  1.5.5  10f635d4-4fc...  2026/1/18 17:53:32
HK  Kwai Chung  1.5.5  10f635d4-4fc...  2026/1/18 17:53:29
...（连续多条相同设备的记录）
```

### 解决方案

后台管理界面现在会自动合并同一设备在 **5分钟时间窗口** 内的重复访问，显示为：

```
HK  Kwai Chung  1.5.5  10f635d4-4fc...  18:02:56 (11次, 持续15分钟)
```

## ✨ 功能特性

### 1. 智能合并
- **时间窗口**: 5分钟内的重复访问自动合并
- **合并条件**: 相同的设备ID + 版本 + 国家 + 城市
- **时间跨度**: 显示首次和最后访问时间的持续时长

### 2. 视觉增强
- 🟡 **黄色高亮**: 访问次数超过3次的记录用黄色背景标识
- 📊 **访问统计**: 显示访问次数和持续时间
- 📅 **日期分组**: 按日期分组，显示每天的设备组数和总访问次数

### 3. 信息展示
合并后的记录显示：
- 首次访问时间
- 访问次数
- 持续时间（自动格式化为秒/分钟/小时）

示例：
- `18:02:56` - 单次访问
- `18:02:56 (3次, 持续45秒)` - 45秒内访问3次
- `17:46:58 (11次, 持续15分钟)` - 15分钟内访问11次

## 📈 统计信息改进

### 日期分组标题
原来：
```
2026年1月18日星期六 (19 条记录)
```

现在：
```
2026年1月18日星期六 (3 组设备，共 19 次访问，已合并 16 条重复)
```

### 表格标题
添加了提示信息：
- "最近记录（按日期分组，已合并5分钟内重复访问）"
- "💡 同一设备短时间内的重复访问已自动合并"
- 时间列说明："时间（重复访问会显示次数和持续时间）"

## 🔧 技术实现

### 合并算法
```javascript
function mergeRepeatedVisits(records, timeWindow) {
  // 1. 按时间排序（最新的在前）
  // 2. 遍历记录，构建设备唯一键
  // 3. 相同设备且时间间隔 <= 5分钟的记录合并
  // 4. 记录首次和最后访问时间
  // 5. 统计访问次数
}
```

### 设备唯一键
```
deviceKey = deviceId + version + country + city
```

确保只合并完全相同环境下的访问。

### 时间窗口
```javascript
const timeWindow = 5 * 60 * 1000; // 5分钟 = 300,000毫秒
```

可以根据需要调整此值。

## 📝 使用示例

### 原始数据（19条记录）
```
10f635d4-4fc... | HK | Kwai Chung | 1.5.5 | 18:02:56
10f635d4-4fc... | HK | Kwai Chung | 1.5.5 | 18:02:39
10f635d4-4fc... | HK | Kwai Chung | 1.5.5 | 17:53:32
10f635d4-4fc... | HK | Kwai Chung | 1.5.5 | 17:53:29
10f635d4-4fc... | HK | Kwai Chung | 1.5.5 | 17:53:10
10f635d4-4fc... | HK | Kwai Chung | 1.5.5 | 17:52:31
10f635d4-4fc... | HK | Kwai Chung | 1.5.5 | 17:52:16
10f635d4-4fc... | HK | Kwai Chung | 1.5.5 | 17:52:12
10f635d4-4fc... | HK | Kwai Chung | 1.5.5 | 17:47:26
10f635d4-4fc... | HK | Kwai Chung | 1.5.5 | 17:47:09
10f635d4-4fc... | HK | Kwai Chung | 1.5.5 | 17:46:58
261f5a1d-b22... | HK | Kwai Chung | admin | 17:34:05
261f5a1d-b22... | HK | Kwai Chung | admin | 17:34:03
261f5a1d-b22... | HK | Kwai Chung | admin | 17:27:56
261f5a1d-b22... | HK | Kwai Chung | admin | 17:26:20
unknown        | HK | Kwai Chung | admin | 17:22:35
unknown        | HK | Kwai Chung | admin | 17:16:35
unknown        | HK | Kwai Chung | admin | 17:16:34
unknown        | HK | Kwai Chung | admin | 17:12:12
```

### 优化后显示（5条记录）
```
🟡 10f635d4-4fc... | HK | Kwai Chung | 1.5.5 | 18:02:56 (2次, 持续17秒)
🟡 10f635d4-4fc... | HK | Kwai Chung | 1.5.5 | 17:53:32 (6次, 持续1分钟)
🟡 10f635d4-4fc... | HK | Kwai Chung | 1.5.5 | 17:47:26 (3次, 持续28秒)
   261f5a1d-b22... | HK | Kwai Chung | admin | 17:34:05 (2次, 持续2秒)
   261f5a1d-b22... | HK | Kwai Chung | admin | 17:27:56 (2次, 持续1分钟)
   unknown        | HK | Kwai Chung | admin | 17:22:35 (1次)
   unknown        | HK | Kwai Chung | admin | 17:16:35 (2次, 持续1秒)
   unknown        | HK | Kwai Chung | admin | 17:12:12 (1次)
```

注：🟡 表示访问次数 > 3 的记录（黄色高亮）

## 💡 优势

1. **节省空间**: 19条记录压缩为8条，节省58%空间
2. **易于分析**: 快速识别频繁访问的设备
3. **异常检测**: 黄色高亮标识异常频繁的访问
4. **保留详情**: 显示访问次数和时长，不丢失信息

## 🔄 数据完整性

- ✅ 原始数据仍然保存在服务器
- ✅ 下载功能仍然导出完整的原始记录
- ✅ 仅在显示层面进行合并优化
- ✅ 不影响统计数据的准确性

## 🎯 适用场景

特别适用于：
- 开发测试阶段（频繁重启应用）
- 自动化测试（定时访问）
- 应用崩溃重启（短时间多次启动）
- 用户频繁切换线路（多次上报统计）

## 📌 注意事项

- 合并仅影响前端显示，不影响服务器存储的原始数据
- 下载的 CSV 文件包含完整的未合并数据
- 5分钟时间窗口可以根据需要调整（在 `admin.html` 中修改）
